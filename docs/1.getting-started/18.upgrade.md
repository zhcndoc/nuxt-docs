---
title: å‡çº§æŒ‡å—
description: 'äº†è§£å¦‚ä½•å‡çº§åˆ°æœ€æ–°çš„ Nuxt ç‰ˆæœ¬ã€‚'
navigation.icon: i-lucide-circle-arrow-up
---

## å‡çº§ Nuxt

### æœ€æ–°ç‰ˆæœ¬

è¦å°† Nuxt å‡çº§åˆ° [æœ€æ–°ç‰ˆæœ¬](https://github.com/nuxt/nuxt/releases)ï¼Œè¯·ä½¿ç”¨ `nuxt upgrade` å‘½ä»¤ã€‚

::code-group{sync="pm"}

```bash [npm]
npx nuxt upgrade
```

```bash [yarn]
yarn nuxt upgrade
```

```bash [pnpm]
pnpm nuxt upgrade
```

```bash [bun]
bun x nuxt upgrade
```

::

### å¤œé—´ç‰ˆæœ¬é€šé“

è¦ä½¿ç”¨æœ€æ–°çš„ Nuxt æ„å»ºå¹¶åœ¨å‘å¸ƒä¹‹å‰æµ‹è¯•åŠŸèƒ½ï¼Œè¯·é˜…è¯» [å¤œé—´ç‰ˆæœ¬é€šé“](/docs/guide/going-further/nightly-release-channel) æŒ‡å—ã€‚

## è¿ç§»åˆ° Nuxt 4

Nuxt 4 åŒ…å«æ˜¾è‘—çš„æ”¹è¿›å’Œå˜åŒ–ã€‚æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å°†ç°æœ‰çš„ Nuxt 3 åº”ç”¨ç¨‹åºè¿ç§»åˆ° Nuxt 4ã€‚

é¦–å…ˆï¼Œå‡çº§åˆ° Nuxt 4ï¼š

::code-group{sync="pm"}

```bash [npm]
npm install nuxt@^4.0.0-rc
```

```bash [yarn]
yarn add nuxt@^4.0.0-rc
```

```bash [pnpm]
pnpm add nuxt@^4.0.0-rc
```

```bash [bun]
bun add nuxt@^4.0.0-rc
```

::

å‡çº§åï¼Œå¤§å¤šæ•° Nuxt 4 çš„è¡Œä¸ºç°åœ¨æ˜¯é»˜è®¤è®¾ç½®ã€‚ç„¶è€Œï¼Œå¦‚æœæ‚¨åœ¨è¿ç§»è¿‡ç¨‹ä¸­éœ€è¦ä¿æŒå‘åå…¼å®¹æ€§ï¼ŒæŸäº›åŠŸèƒ½ä»ç„¶å¯ä»¥è¿›è¡Œé…ç½®ã€‚

ä»¥ä¸‹éƒ¨åˆ†è¯¦ç»†è¯´æ˜äº†å‡çº§åˆ° Nuxt 4 æ—¶æ‰€éœ€çš„å…³é”®æ›´æ”¹å’Œè¿ç§»ã€‚

ä¸‹é¢è®°å½•äº†é‡å¤§æˆ–æ˜¾è‘—çš„æ›´æ”¹ï¼Œä»¥åŠè¿ç§»æ­¥éª¤å’Œå¯ç”¨çš„é…ç½®é€‰é¡¹ã€‚

### ä½¿ç”¨ Codemods è¿ç§»

ä¸ºä¾¿äºå‡çº§è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸ [Codemod](https://github.com/codemod-com/codemod) å›¢é˜Ÿåˆä½œï¼Œä½¿ç”¨ä¸€äº›å¼€æºçš„ codemods è‡ªåŠ¨åŒ–è®¸å¤šè¿ç§»æ­¥éª¤ã€‚

::note
å¦‚æœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·å‘ Codemod å›¢é˜ŸæŠ¥å‘Š `npx codemod feedback` ğŸ™
::

æœ‰å…³ Nuxt 4 codemods çš„å®Œæ•´åˆ—è¡¨ã€æ¯ä¸ª codemod çš„è¯¦ç»†ä¿¡æ¯ã€å…¶æ¥æºå’Œå¤šç§æ‰§è¡Œæ–¹å¼ï¼Œè¯·è®¿é—® [Codemod Registry](https://go.codemod.com/codemod-registry)ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ `codemod` é…æ–¹è¿è¡Œæœ¬æŒ‡å—ä¸­æåˆ°çš„æ‰€æœ‰ codemodsï¼š

::code-group

```bash [npm]
npx codemod@latest nuxt/4/migration-recipe
```

```bash [yarn]
yarn dlx codemod@latest nuxt/4/migration-recipe
```

```bash [pnpm]
pnpm dlx codemod@latest nuxt/4/migration-recipe
```

```bash [bun]
bun x codemod@latest nuxt/4/migration-recipe
```

::

æ­¤å‘½ä»¤å°†æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰ codemodsï¼Œå¹¶å¯é€‰æ‹©å–æ¶ˆé€‰æ‹©ä»»ä½•æ‚¨ä¸å¸Œæœ›è¿è¡Œçš„é¡¹ç›®ã€‚æ¯ä¸ª codemod ä¹Ÿä¼šåœ¨ä¸‹é¢åˆ—å‡ºåŠå…¶ç›¸åº”çš„å˜æ›´ï¼Œå¹¶å¯ä»¥ç‹¬ç«‹æ‰§è¡Œã€‚

### æ–°ç›®å½•ç»“æ„

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæ˜¾è‘—

Nuxt ç°åœ¨é»˜è®¤ä½¿ç”¨æ–°çš„ç›®å½•ç»“æ„ï¼Œå…·æœ‰å‘åå…¼å®¹æ€§ï¼ˆå› æ­¤å¦‚æœ Nuxt æ£€æµ‹åˆ°æ‚¨ä½¿ç”¨æ—§ç»“æ„ï¼Œä¾‹å¦‚é¡¶çº§çš„ `pages/` ç›®å½•ï¼Œåˆ™æ­¤æ–°ç»“æ„å°†ä¸é€‚ç”¨ï¼‰ã€‚

ğŸ‘‰ [æŸ¥çœ‹å®Œæ•´çš„ RFC](https://github.com/nuxt/nuxt/issues/26444)

#### å˜æ›´å†…å®¹

* æ–°çš„ Nuxt é»˜è®¤ `srcDir` é»˜è®¤å€¼ä¸º `app/`ï¼Œå¤§å¤šæ•°å†…å®¹ä»é‚£é‡Œè§£æã€‚
* `serverDir` ç°åœ¨é»˜è®¤å€¼ä¸º `<rootDir>/server`ï¼Œè€Œä¸æ˜¯ `<srcDir>/server`
* `layers/`ã€`modules/` å’Œ `public/` é»˜è®¤ç›¸å¯¹äº `<rootDir>` è§£æ
* å¦‚æœä½¿ç”¨ [Nuxt Content v2.13+](https://github.com/nuxt/content/pull/2649)ï¼Œ`content/` ç›¸å¯¹äº `<rootDir>` è§£æ
* æ·»åŠ äº†æ–°çš„ `dir.app`ï¼Œè¿™æ˜¯æˆ‘ä»¬å¯»æ‰¾ `router.options.ts` å’Œ `spa-loading-template.html` çš„ç›®å½•â€”â€”é»˜è®¤å€¼ä¸º `<srcDir>/`

<details>

<summary>ä¸€ä¸ªç¤ºä¾‹ v4 æ–‡ä»¶å¤¹ç»“æ„ã€‚</summary>

```sh
.output/
.nuxt/
app/
  assets/
  components/
  composables/
  layouts/
  middleware/
  pages/
  plugins/
  utils/
  app.config.ts
  app.vue
  router.options.ts
content/
layers/
modules/
node_modules/
public/
server/
  api/
  middleware/
  plugins/
  routes/
  utils/
nuxt.config.ts
```

::note
With this new structure, the `~` alias now points to the `app/` directory by default (your `srcDir`). This means `~/components` resolves to `app/components/`, `~/pages` to `app/pages/`, etc.
::

</details>

ğŸ‘‰ æ›´å¤šè¯¦æƒ…è¯·å‚è§ [å®ç°æ­¤å˜æ›´çš„ PR](https://github.com/nuxt/nuxt/pull/27029)ã€‚

#### å˜æ›´åŸå› 

1. **æ€§èƒ½** - å°†æ‰€æœ‰ä»£ç æ”¾åœ¨ä»£ç åº“çš„æ ¹ç›®å½•ä¸­ï¼Œä¼šå¯¼è‡´ `.git/` å’Œ `node_modules/` æ–‡ä»¶å¤¹è¢«æ–‡ä»¶ç³»ç»Ÿç›‘è§†å™¨æ‰«æ/åŒ…å«ï¼Œè¿™å¯èƒ½æ˜¾è‘—å»¶è¿Ÿé Mac OS ä¸Šçš„å¯åŠ¨æ—¶é—´ã€‚
1. **IDE ç±»å‹å®‰å…¨** - `server/` å’Œæ‚¨çš„åº”ç”¨çš„å…¶ä½™éƒ¨åˆ†åœ¨ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œå…·æœ‰ä¸åŒçš„å…¨å±€å¯¼å…¥ï¼Œå¹¶ç¡®ä¿ `server/` ä¸ä¸æ‚¨åº”ç”¨çš„å…¶ä½™éƒ¨åˆ†åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­æ˜¯ç¡®ä¿åœ¨ IDE ä¸­è·å¾—è‰¯å¥½è‡ªåŠ¨è¡¥å…¨çš„ç¬¬ä¸€æ­¥ã€‚

:video-accordion{title="è§‚çœ‹ Vue School å…³äºæ–°ç›®å½•ç»“æ„çš„è§†é¢‘" videoId="1031028378" platform="vimeo"}

#### è¿ç§»æ­¥éª¤

1. åˆ›å»ºä¸€ä¸ªæ–°çš„ç›®å½• `app/`ã€‚
1. å°†æ‚¨çš„ `assets/`ã€`components/`ã€`composables/`ã€`layouts/`ã€`middleware/`ã€`pages/`ã€`plugins/` å’Œ `utils/` æ–‡ä»¶å¤¹ç§»åŠ¨åˆ°å…¶ä¸­ï¼Œä»¥åŠ `app.vue`ã€`error.vue`ã€`app.config.ts`ã€‚å¦‚æœæ‚¨æœ‰ `app/router-options.ts` æˆ– `app/spa-loading-template.html`ï¼Œè¿™äº›è·¯å¾„ä¿æŒä¸å˜ã€‚
1. ç¡®ä¿æ‚¨çš„ `nuxt.config.ts`ã€`content/`ã€`layers/`ã€`modules/`ã€`public/` å’Œ `server/` æ–‡ä»¶å¤¹ä¿æŒåœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `app/` æ–‡ä»¶å¤¹ä¹‹å¤–ã€‚
1. è¯·è®°å¾—æ›´æ–°ä»»ä½•ç¬¬ä¸‰æ–¹é…ç½®æ–‡ä»¶ä»¥ä¸æ–°ç›®å½•ç»“æ„é…åˆä½¿ç”¨ï¼Œä¾‹å¦‚æ‚¨çš„ `tailwindcss` æˆ– `eslint` é…ç½®ï¼ˆå¦‚æœ‰å¿…è¦ï¼Œ`@nuxtjs/tailwindcss` åº”è‡ªåŠ¨æ­£ç¡®é…ç½® `tailwindcss`ï¼‰ã€‚

::tip
æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/file-structure` æ¥è‡ªåŠ¨åŒ–æ­¤è¿ç§»
::

ç„¶è€Œï¼Œè¿ç§» _ä¸æ˜¯å¿…éœ€çš„_ã€‚å¦‚æœæ‚¨å¸Œæœ›ä¿ç•™å½“å‰çš„æ–‡ä»¶å¤¹ç»“æ„ï¼ŒNuxt åº”è¯¥èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹å®ƒã€‚ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œè¯·æå‡ºé—®é¢˜ã€‚ï¼‰å”¯ä¸€çš„ä¾‹å¤–æ˜¯å¦‚æœæ‚¨ _å·²ç»_ æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„ `srcDir`ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥çŸ¥é“ï¼Œæ‚¨çš„ `modules/`ã€`public/` å’Œ `server/` æ–‡ä»¶å¤¹å°†ä»æ‚¨çš„ `rootDir` è§£æï¼Œè€Œä¸æ˜¯ä»æ‚¨çš„è‡ªå®šä¹‰ `srcDir` è§£æã€‚å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥é€šè¿‡é…ç½® `dir.modules`ã€`dir.public` å’Œ `serverDir` æ¥è¦†ç›–æ­¤è®¾ç½®ã€‚

æ‚¨è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®å¼ºåˆ¶ä½¿ç”¨ v3 æ–‡ä»¶å¤¹ç»“æ„ï¼š

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  // è¿™å°†å°†æ–°çš„ srcDir é»˜è®¤å€¼ä» `app` è¿˜åŸä¸ºæ‚¨çš„æ ¹ç›®å½•
  srcDir: '.',
  // è¿™æŒ‡å®š `router.options.ts` å’Œ `spa-loading-template.html` çš„ç›®å½•å‰ç¼€
  dir: {
    app: 'app'
  }
})
```

### å•ä¾‹æ•°æ®è·å–å±‚

ğŸš¦ **å½±å“çº§åˆ«**ï¼šé€‚ä¸­

#### å˜æ›´å†…å®¹

Nuxt çš„æ•°æ®è·å–ç³»ç»Ÿï¼ˆ`useAsyncData` å’Œ `useFetch`ï¼‰å·²è¢«æ˜¾è‘—é‡ç»„ï¼Œä»¥æé«˜æ€§èƒ½å’Œä¸€è‡´æ€§ï¼š

1. **åŒé”®å…±äº« ref**ï¼šå¯¹åŒä¸€é”®çš„æ‰€æœ‰ `useAsyncData` æˆ– `useFetch` è°ƒç”¨ç°åœ¨å…±äº«åŒä¸€ `data`ã€`error` å’Œ `status` refsã€‚è¿™æ„å‘³ç€æ‰€æœ‰å…·æœ‰æ˜¾å¼é”®çš„è°ƒç”¨ä¸å¾—æœ‰å†²çªçš„ `deep`ã€`transform`ã€`pick`ã€`getCachedData` æˆ– `default` é€‰é¡¹ã€‚

2. **æ›´å¥½åœ°æ§åˆ¶ `getCachedData`**ï¼šæ¯æ¬¡è·å–æ•°æ®æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ `getCachedData` å‡½æ•°ï¼Œå³ä½¿è¿™è¢«è§‚å¯Ÿè€…å¼•èµ·æˆ–è°ƒç”¨ `refreshNuxtData` ä¹Ÿä¼šå¦‚æ­¤ã€‚ï¼ˆä»¥å‰ï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹æ€»æ˜¯ä¼šè·å–æ–°æ•°æ®ï¼Œè€Œä¸”ä¸ä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚ï¼‰ä¸ºäº†å…è®¸æ›´å¥½åœ°æ§åˆ¶ä½•æ—¶ä½¿ç”¨ç¼“å­˜æ•°æ®ä»¥åŠä½•æ—¶é‡æ–°è·å–ï¼Œå‡½æ•°ç°åœ¨æ¥æ”¶ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒåŒ…å«è¯·æ±‚çš„åŸå› ã€‚

3. **æ”¯æŒååº”æ€§é”®**ï¼šæ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨è®¡ç®—çš„ refsã€æ™®é€šçš„ refs æˆ– getter å‡½æ•°ä½œä¸ºé”®ï¼Œè¿™æ ·å¯ä»¥å®ç°è‡ªåŠ¨é‡æ–°è·å–æ•°æ®ï¼ˆå¹¶å•ç‹¬å­˜å‚¨æ•°æ®ï¼‰ã€‚

4. **æ•°æ®æ¸…ç†**ï¼šå½“æœ€åä¸€ä¸ªä½¿ç”¨ `useAsyncData` è·å–æ•°æ®çš„ç»„ä»¶è¢«å¸è½½æ—¶ï¼ŒNuxt å°†åˆ é™¤è¯¥æ•°æ®ï¼Œä»¥é¿å…ä¸æ–­å¢é•¿çš„å†…å­˜ä½¿ç”¨ã€‚

#### å˜æ›´åŸå› 

è¿™äº›æ›´æ”¹æ—¨åœ¨æ”¹å–„å†…å­˜ä½¿ç”¨ï¼Œå¹¶åœ¨å¯¹ `useAsyncData` çš„è°ƒç”¨ä¹‹é—´æé«˜åŠ è½½çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚

#### è¿ç§»æ­¥éª¤

1. **æ£€æŸ¥ä¸ä¸€è‡´çš„é€‰é¡¹**ï¼šå®¡æ ¸ä»»ä½•ä½¿ç”¨ç›¸åŒé”®ä½†é€‰é¡¹æˆ–è·å–å‡½æ•°ä¸åŒçš„ç»„ä»¶ã€‚

   ```ts
   // è¿™ç°åœ¨å°†è§¦å‘è­¦å‘Š
   const { data: users1 } = useAsyncData('users', () => $fetch('/api/users'), { deep: false })
   const { data: users2 } = useAsyncData('users', () => $fetch('/api/users'), { deep: true })
   ```

   å°†å…±äº«æ˜¾å¼é”®ï¼ˆå¹¶ä¸”æœ‰è‡ªå®šä¹‰é€‰é¡¹ï¼‰çš„ä»»ä½• `useAsyncData` è°ƒç”¨æå–åˆ°å®ƒä»¬è‡ªå·±çš„ç»„åˆä¸­å¯èƒ½æ˜¯æœ‰ç›Šçš„ï¼š

   ```ts [composables/useUserData.ts]
   export function useUserData(userId: string) {
     return useAsyncData(
       `user-${userId}`,
       () => fetchUser(userId),
       { 
         deep: true,
         transform: (user) => ({ ...user, lastAccessed: new Date() })
       }
     )
   }
   ```

2. **æ›´æ–° `getCachedData` å®ç°**ï¼š

   ```diff
   useAsyncData('key', fetchFunction, {
   -  getCachedData: (key, nuxtApp) => {
   -    return cachedData[key]
   -  }
   +  getCachedData: (key, nuxtApp, ctx) => {
   +    // ctx.cause - å¯ä»¥æ˜¯ 'initial' | 'refresh:hook' | 'refresh:manual' | 'watch'
   +    
   +    // ç¤ºä¾‹ï¼šåœ¨æ‰‹åŠ¨åˆ·æ–°æ—¶ä¸ä½¿ç”¨ç¼“å­˜
   +    if (ctx.cause === 'refresh:manual') return undefined
   +    
   +    return cachedData[key]
   +  }
   })
   ```

æˆ–è€…ï¼Œæ‚¨ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç¦ç”¨æ­¤è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    granularCachedData: false,
    purgeCachedData: false
  }
})
```

### ä¿®æ­£äº†å±‚ä¸­çš„æ¨¡å—åŠ è½½é¡ºåº

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

ä½¿ç”¨ [Nuxt layers](/docs/guide/going-further/layers) æ—¶ï¼Œæ¨¡å—åŠ è½½çš„é¡ºåºå·²è¢«ä¿®æ­£ã€‚ä»¥å‰ï¼Œé¡¹ç›®æ ¹ç›®å½•ä¸­çš„æ¨¡å—åœ¨æ‰©å±•å±‚ä¸­çš„æ¨¡å—ä¹‹å‰åŠ è½½ï¼Œè¿™ä¸é¢„æœŸçš„è¡Œä¸ºç›¸åã€‚

ç°åœ¨æ¨¡å—ä»¥æ­£ç¡®çš„é¡ºåºåŠ è½½ï¼š

1. **é¦–å…ˆæ˜¯å±‚æ¨¡å—**ï¼ˆæŒ‰æ‰©å±•é¡ºåº - æ·±å±‚æ¨¡å—ä¼˜å…ˆï¼‰
2. **æœ€åæ˜¯é¡¹ç›®æ¨¡å—**ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

è¿™å½±å“åˆ°ï¼š
* åœ¨ `nuxt.config.ts` ä¸­çš„ `modules` æ•°ç»„å®šä¹‰çš„æ¨¡å—
* ä» `modules/` ç›®å½•è‡ªåŠ¨å‘ç°çš„æ¨¡å—

#### å˜æ›´åŸå› 

æ­¤æ›´æ”¹ç¡®ä¿ï¼š
* æ‰©å±•å±‚çš„ä¼˜å…ˆçº§ä½äºæ¶ˆè´¹é¡¹ç›®
* æ¨¡å—æ‰§è¡Œé¡ºåºä¸ç›´è§‚çš„å±‚ç»§æ‰¿æ¨¡å¼ç›¸åŒ¹é…
* æ¨¡å—é…ç½®å’Œé’©å­åœ¨å¤šå±‚è®¾ç½®ä¸­æŒ‰é¢„æœŸå·¥ä½œ

#### è¿ç§»æ­¥éª¤

**å¤§å¤šæ•°é¡¹ç›®ä¸éœ€è¦æ›´æ”¹**ï¼Œå› ä¸ºè¿™ä¿®æ­£äº†åŠ è½½é¡ºåºä»¥åŒ¹é…é¢„æœŸè¡Œä¸ºã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„é¡¹ç›®ä¾èµ–äºå…ˆå‰ä¸æ­£ç¡®çš„é¡ºåºï¼Œåˆ™å¯èƒ½éœ€è¦ï¼š

1. **å®¡æŸ¥æ¨¡å—ä¾èµ–å…³ç³»**ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¨¡å—ä¾èµ–äºç‰¹å®šçš„åŠ è½½é¡ºåº
2. **è°ƒæ•´æ¨¡å—é…ç½®**ï¼šå¦‚æœæ¨¡å—è¢«é…ç½®ä¸ºè§£å†³ä¸æ­£ç¡®çš„é¡ºåº
3. **å½»åº•æµ‹è¯•**ï¼šç¡®ä¿æ‰€æœ‰åŠŸèƒ½åœ¨æ›´æ­£çš„é¡ºåºä¸‹æŒ‰é¢„æœŸå·¥ä½œ

æ–°æ­£ç¡®é¡ºåºçš„ç¤ºä¾‹ï¼š
```ts
// Layer: my-layer/nuxt.config.ts
export default defineNuxtConfig({
  modules: ['layer-module-1', 'layer-module-2']
})

// Project: nuxt.config.ts
export default defineNuxtConfig({
  extends: ['./my-layer'],
  modules: ['project-module-1', 'project-module-2']
})

// Loading order (corrected):
// 1. layer-module-1
// 2. layer-module-2  
// 3. project-module-1 (can override layer modules)
// 4. project-module-2 (can override layer modules)
```

å¦‚æœæ‚¨é‡åˆ°ç”±äºéœ€è¦æ³¨å†Œé’©å­è€Œå¯¼è‡´çš„æ¨¡å—é¡ºåºä¾èµ–é—®é¢˜ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ [`modules:done` é’©å­](/docs/guide/going-further/modules#custom-hooks) æ¥å¤„ç†éœ€è¦è°ƒç”¨é’©å­çš„æ¨¡å—ã€‚è¯¥é’©å­åœ¨æ‰€æœ‰å…¶ä»–æ¨¡å—åŠ è½½åè¿è¡Œï¼Œè¿™æ„å‘³ç€ä½¿ç”¨å®ƒæ˜¯å®‰å…¨çš„ã€‚

ğŸ‘‰ è¯·å‚è§ [PR #31507](https://github.com/nuxt/nuxt/pull/31507) å’Œ [issue #25719](https://github.com/nuxt/nuxt/issues/25719) ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

### è·¯ç”±å…ƒæ•°æ®çš„å»é‡

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

ç°åœ¨å¯ä»¥ä½¿ç”¨ `definePageMeta` è®¾ç½®ä¸€äº›è·¯ç”±å…ƒæ•°æ®ï¼Œä¾‹å¦‚ `name`ã€`path` ç­‰ã€‚ä»¥å‰ï¼Œè¿™äº›åœ¨è·¯ç”±å’Œè·¯ç”±å…ƒæ•°æ®ä¸Šéƒ½å¯ç”¨ï¼ˆä¾‹å¦‚ï¼Œ`route.name` å’Œ `route.meta.name`ï¼‰ã€‚

ç°åœ¨ï¼Œå®ƒä»¬åªèƒ½åœ¨è·¯ç”±å¯¹è±¡ä¸Šè®¿é—®ã€‚

#### å˜æ›´åŸå› 

è¿™æ˜¯é»˜è®¤å¯ç”¨ `experimental.scanPageMeta` çš„ç»“æœï¼Œæ˜¯ä¸€ç§æ€§èƒ½ä¼˜åŒ–ã€‚

#### è¿ç§»æ­¥éª¤

æ­¤è¿ç§»åº”è¯¥æ˜¯ç›´æ¥çš„ï¼š

```diff
  const route = useRoute()
  
- console.log(route.meta.name)
+ console.log(route.name)
```

### è§„èŒƒåŒ–ç»„ä»¶åç§°

ğŸš¦ **å½±å“çº§åˆ«**ï¼šé€‚ä¸­

Vue ç°åœ¨å°†ç”Ÿæˆä¸ Nuxt ç»„ä»¶å‘½åçš„æ¨¡å¼ç›¸åŒ¹é…çš„ç»„ä»¶åç§°ã€‚

#### å˜æ›´å†…å®¹

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ‚¨æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®ï¼ŒVue å°†ä¸ºç»„ä»¶åˆ†é…ä¸€ä¸ªä¸ç»„ä»¶æ–‡ä»¶ååŒ¹é…çš„åç§°ã€‚

```bash [ç›®å½•ç»“æ„]
â”œâ”€ components/
â”œâ”€â”€â”€ SomeFolder/
â”œâ”€â”€â”€â”€â”€ MyComponent.vue
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°± Vue è€Œè¨€ï¼Œç»„ä»¶åç§°å°†æ˜¯ `MyComponent`ã€‚å¦‚æœæ‚¨æƒ³ä½¿ç”¨ `<KeepAlive>`ï¼Œæˆ–åœ¨ Vue DevTools ä¸­è¯†åˆ«å®ƒï¼Œæ‚¨éœ€è¦ä½¿ç”¨è¿™ä¸ªåç§°ã€‚

ä½†æ˜¯ä¸ºäº†è‡ªåŠ¨å¯¼å…¥ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ `SomeFolderMyComponent`ã€‚

é€šè¿‡è¿™ä¸€å˜æ›´ï¼Œè¿™ä¸¤ä¸ªå€¼å°†åŒ¹é…ï¼ŒVue å°†ç”Ÿæˆä¸ Nuxt ç»„ä»¶å‘½åæ¨¡å¼ç›¸åŒ¹é…çš„ç»„ä»¶åç§°ã€‚

#### è¿ç§»æ­¥éª¤

ç¡®ä¿åœ¨ä»»ä½•ä½¿ç”¨ `@vue/test-utils` ä¸­çš„ `findComponent` çš„æµ‹è¯•ä¸­ä½¿ç”¨æ›´æ–°åçš„åç§°ï¼Œå¹¶åœ¨ä»»ä½•ä¾èµ–äºç»„ä»¶åç§°çš„ `<KeepAlive>` ä¸­ä½¿ç”¨ã€‚

æˆ–è€…ï¼Œæ‚¨ç›®å‰å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç¦ç”¨æ­¤è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    normalizeComponentNames: false
  }
})
```

### Unhead v2

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

ç”¨äºç”Ÿæˆ `<head>` æ ‡ç­¾çš„ [Unhead](https://unhead.unjs.io/) å·²æ›´æ–°è‡³ç‰ˆæœ¬ 2ã€‚è™½ç„¶åŸºæœ¬å…¼å®¹ï¼Œä½†å®ƒåŒ…æ‹¬å¤šä¸ªåº•å±‚ API çš„é‡å¤§å˜æ›´ã€‚

* ç§»é™¤äº†å±æ€§ï¼š`vmid`ã€`hid`ã€`children`ã€`body`ã€‚
* ä¸å†æ”¯æŒ Promise è¾“å…¥ã€‚
* ç°åœ¨ä½¿ç”¨ Capo.js é»˜è®¤å¯¹æ ‡ç­¾è¿›è¡Œæ’åºã€‚

#### è¿ç§»æ­¥éª¤

ä¸Šè¿°æ›´æ”¹å¯¹æ‚¨çš„åº”ç”¨åº”æœ‰æœ€å°å½±å“ã€‚

å¦‚æœæ‚¨é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

* æ‚¨æ²¡æœ‰ä½¿ç”¨ä»»ä½•å·²ç§»é™¤çš„å±æ€§ã€‚

```diff
useHead({
  meta: [{ 
    name: 'description', 
    // meta æ ‡ç­¾ä¸éœ€è¦ vmid æˆ–é”®    
-   vmid: 'description' 
-   hid: 'description'
  }]
})
```

* å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ [Template Params](https://unhead.unjs.io/docs/head/guides/plugins/template-params) æˆ– [Alias Tag Sorting](https://unhead.unjs.io/docs/head/guides/plugins/alias-sorting)ï¼Œæ‚¨ç°åœ¨éœ€è¦æ˜¾å¼é€‰æ‹©åŠ å…¥è¿™äº›åŠŸèƒ½ã€‚

```ts
import { TemplateParamsPlugin, AliasSortingPlugin } from '@unhead/vue/plugins'

export default defineNuxtPlugin({
  setup() {
    const unhead = injectHead()
    unhead.use(TemplateParamsPlugin)
    unhead.use(AliasSortingPlugin)
  }
})
```

è™½ç„¶ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†å»ºè®®å°†ä»»ä½•æ¥è‡ª `@unhead/vue` çš„å¯¼å…¥æ›´æ–°ä¸º `#imports` æˆ– `nuxt/app`ã€‚

```diff
-import { useHead } from '@unhead/vue'
+import { useHead } from '#imports'
```

å¦‚æœæ‚¨ä»ç„¶é‡åˆ°é—®é¢˜ï¼Œæ‚¨å¯ä»¥é€šè¿‡å¯ç”¨ `head.legacy` é…ç½®æ¢å¤åˆ° v1 è¡Œä¸ºã€‚

```ts
export default defineNuxtConfig({
  unhead: {
    legacy: true,
  }
})
```

### SPA åŠ è½½å±å¹•çš„æ–° DOM ä½ç½®

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

åœ¨å‘ˆç°ä»…å®¢æˆ·ç«¯é¡µé¢ï¼ˆ`ssr: false`ï¼‰æ—¶ï¼Œæˆ‘ä»¬å¯é€‰æ‹©åœ¨ Nuxt åº”ç”¨æ ¹ä¸­æ¸²æŸ“åŠ è½½å±å¹•ï¼ˆæ¥è‡ª `~/app/spa-loading-template.html` - note that this has also changed to `~/spa-loading-template.html` in Nuxt 4ï¼‰ï¼š

```html
<div id="__nuxt">
  <!-- spa loading template -->
</div>
```

ç°åœ¨ï¼Œæˆ‘ä»¬é»˜è®¤ä¸ºåœ¨ Nuxt åº”ç”¨æ ¹æ—è¾¹æ¸²æŸ“æ¨¡æ¿ï¼š

```html
<div id="__nuxt"></div>
<!-- spa loading template -->
```

#### å˜æ›´åŸå› 

è¿™æ ·å¯ä»¥ä½¿ spa åŠ è½½æ¨¡æ¿åœ¨ Vue åº”ç”¨ suspense è§£æä¹‹å‰ä¿æŒåœ¨ DOM ä¸­ï¼Œé˜²æ­¢å‡ºç°ç™½å±é—ªçƒã€‚

#### è¿ç§»æ­¥éª¤

å¦‚æœæ‚¨ä½¿ç”¨ CSS æˆ– `document.queryElement` é’ˆå¯¹ SPA åŠ è½½æ¨¡æ¿è¿›è¡Œå®šå‘ï¼Œæ‚¨å°†éœ€è¦æ›´æ–°é€‰æ‹©å™¨ã€‚ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ–°çš„ `app.spaLoaderTag` å’Œ `app.spaLoaderAttrs` é…ç½®é€‰é¡¹ã€‚

æˆ–è€…ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¢å¤ä¹‹å‰çš„è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    spaLoadingTemplateLocation: 'within',
  }
})
```

### è§£æçš„ `error.data`

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

å¯ä»¥é€šè¿‡ `data` å±æ€§æŠ›å‡ºé”™è¯¯ï¼Œä½†è¿™æœªè¢«è§£æã€‚ç°åœ¨ï¼Œå®ƒè¢«è§£æå¹¶å¯åœ¨ `error` å¯¹è±¡ä¸­è®¿é—®ã€‚å°½ç®¡è¿™æ˜¯ä¸€ä¸ªä¿®å¤ï¼Œä½†å¦‚æœæ‚¨ä¾èµ–ä¹‹å‰çš„è¡Œä¸ºå¹¶æ‰‹åŠ¨è§£æï¼Œè¿™åœ¨æŠ€æœ¯ä¸Šæ˜¯ä¸€ä¸ªç ´åæ€§æ›´æ”¹ã€‚

#### è¿ç§»æ­¥éª¤

æ›´æ–°æ‚¨çš„è‡ªå®šä¹‰ `error.vue`ï¼Œä»¥å»é™¤å¯¹ `error.data` çš„ä»»ä½•é¢å¤–è§£æï¼š

```diff
  <script setup lang="ts">
  import type { NuxtError } from '#app'

  const props = defineProps({
    error: Object as () => NuxtError
  })

- const data = JSON.parse(error.data)
+ const data = error.data
  </script>
```

### æ›´ç»†ç²’åº¦çš„å†…è”æ ·å¼

ğŸš¦ **å½±å“çº§åˆ«**ï¼šé€‚ä¸­

Nuxt ç°åœ¨åªä¼šä¸º Vue ç»„ä»¶å†…è”æ ·å¼ï¼Œè€Œä¸æ˜¯å…¨å±€ CSSã€‚

#### å˜æ›´å†…å®¹

ä»¥å‰ï¼ŒNuxt ä¼šå†…è”æ‰€æœ‰ CSSï¼ŒåŒ…æ‹¬å…¨å±€æ ·å¼ï¼Œå¹¶åˆ é™¤æŒ‡å‘å•ç‹¬ CSS æ–‡ä»¶çš„ `<link>` å…ƒç´ ã€‚ç°åœ¨ï¼ŒNuxt åªä¼šå¯¹ Vue ç»„ä»¶æ‰§è¡Œæ­¤æ“ä½œï¼ˆæ­¤å‰ä¼šç”Ÿæˆç‹¬ç«‹çš„ CSS å—ï¼‰ã€‚æˆ‘ä»¬è®¤ä¸ºè¿™æ˜¯å‡å°‘å•ç‹¬ç½‘ç»œè¯·æ±‚çš„æ›´å¥½å¹³è¡¡ï¼ˆæ­£å¦‚ä»¥å¾€ï¼Œå¯¹äºåˆå§‹åŠ è½½ï¼Œæ¯ä¸ªé¡µé¢æˆ–æ¯ä¸ªç»„ä»¶å°†ä¸å†æœ‰å•ç‹¬è¯·æ±‚ `.css` æ–‡ä»¶ï¼‰ï¼Œå¹¶å…è®¸å¯¹å•ä¸ªå…¨å±€ CSS æ–‡ä»¶è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘åˆå§‹è¯·æ±‚çš„æ–‡æ¡£ä¸‹è½½å¤§å°ã€‚

#### è¿ç§»æ­¥éª¤

æ­¤åŠŸèƒ½æ˜¯å®Œå…¨å¯é…ç½®çš„ï¼Œæ‚¨å¯ä»¥é€šè¿‡è®¾ç½® `inlineStyles: true` å°†å…¨å±€ CSS ä»¥åŠæ¯ä¸ªç»„ä»¶ CSS å†…è”ï¼Œä»¥æ¢å¤åˆ°ä¹‹å‰çš„è¡Œä¸ºã€‚

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  features: {
    inlineStyles: true
  }
})
```

### åœ¨è§£æåæ‰«æé¡µé¢å…ƒæ•°æ®

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

æˆ‘ä»¬ç°åœ¨åœ¨è°ƒç”¨ `pages:extend` é’©å­ _ä¹‹å_ æ‰«æé¡µé¢å…ƒæ•°æ®ï¼ˆåœ¨ `definePageMeta` ä¸­å®šä¹‰ï¼‰ã€‚

#### å˜æ›´åŸå› 

è¿™æ˜¯ä¸ºäº†å…è®¸æ‰«æç”¨æˆ·å¸Œæœ›åœ¨ `pages:extend` ä¸­æ·»åŠ çš„é¡µé¢çš„å…ƒæ•°æ®ã€‚æˆ‘ä»¬ä»ç„¶æä¾›åœ¨æ–°çš„ `pages:resolved` é’©å­ä¸­æ›´æ”¹æˆ–è¦†ç›–é¡µé¢å…ƒæ•°æ®çš„æœºä¼šã€‚

#### è¿ç§»æ­¥éª¤

å¦‚æœæ‚¨æƒ³è¦†ç›–é¡µé¢å…ƒæ•°æ®ï¼Œè¯·åœ¨ `pages:resolved` ä¸­è¿›è¡Œï¼Œè€Œä¸æ˜¯åœ¨ `pages:extend` ä¸­ã€‚

```diff
  export default defineNuxtConfig({
    hooks: {
-     'pages:extend'(pages) {
+     'pages:resolved'(pages) {
        const myPage = pages.find(page => page.path === '/')
        myPage.meta ||= {}
        myPage.meta.layout = 'overridden-layout'
      }
    }
  })
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¢å¤ä¹‹å‰çš„è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    scanPageMeta: true
  }
})
```

### å…±äº«é¢„æ¸²æŸ“æ•°æ®

ğŸš¦ **å½±å“çº§åˆ«**ï¼šé€‚ä¸­

#### å˜æ›´å†…å®¹

æˆ‘ä»¬å¯ç”¨äº†ä¸€ä¸ªå…ˆå‰å®éªŒæ€§åŠŸèƒ½ï¼Œä»¥å…±äº«æ¥è‡ª `useAsyncData` å’Œ `useFetch` è°ƒç”¨çš„æ•°æ®ï¼Œåœ¨ä¸åŒé¡µé¢ä¹‹é—´å…±äº«ã€‚è¯·å‚è§ [åŸå§‹ PR](https://github.com/nuxt/nuxt/pull/24894)ã€‚

#### å˜æ›´åŸå› 

æ­¤åŠŸèƒ½è‡ªåŠ¨å…±äº«åœ¨é¢„æ¸²æŸ“æ—¶ä» `useAsyncData` æˆ– `useFetch` è·å–çš„ _æ•°æ®_ã€‚è¿™å¯ä»¥æ˜¾è‘—æé«˜é¢„æ¸²æŸ“ä½¿ç”¨äº†ç›¸åŒæ•°æ®çš„ç«™ç‚¹çš„æ€§èƒ½ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„ç«™ç‚¹å¯¹äºæ¯ä¸ªé¡µé¢éƒ½éœ€è¦ `useFetch` è°ƒç”¨ï¼ˆä¾‹å¦‚ï¼Œè·å–ç”¨äºèœå•çš„å¯¼èˆªæ•°æ®ï¼Œæˆ–ä» CMS è·å–ç«™ç‚¹è®¾ç½®ï¼‰ï¼Œåˆ™æ­¤æ•°æ®åœ¨é¢„æ¸²æŸ“ç¬¬ä¸€ä¸ªä½¿ç”¨å®ƒçš„é¡µé¢æ—¶åªéœ€è·å–ä¸€æ¬¡ï¼Œç„¶ååœ¨é¢„æ¸²æŸ“å…¶ä»–é¡µé¢æ—¶ç¼“å­˜ä»¥ä½¿ç”¨ã€‚

#### è¿ç§»æ­¥éª¤

ç¡®ä¿æ‚¨çš„æ•°æ®çš„ä»»ä½•å”¯ä¸€é”®æ€»æ˜¯å¯ä»¥è§£æä¸ºç›¸åŒçš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ `useAsyncData` è·å–ä¸ç‰¹å®šé¡µé¢ç›¸å…³çš„æ•°æ®ï¼Œåˆ™åº”æä¾›ä¸€ä¸ªå”¯ä¸€åŒ¹é…è¯¥æ•°æ®çš„é”®ã€‚ï¼ˆ`useFetch` åº”è‡ªåŠ¨ä¸ºæ‚¨æ‰§è¡Œæ­¤æ“ä½œã€‚ï¼‰

```ts [app/pages/test/[slug\\].vue]
// è¿™åœ¨åŠ¨æ€é¡µé¢ï¼ˆä¾‹å¦‚ `[slug].vue`ï¼‰ä¸­ä¸å®‰å…¨ï¼Œå› ä¸ºè·¯ç”± slug ä¼šå½±å“è·å–çš„æ•°æ®ï¼Œè€Œ Nuxt æ— æ³•çŸ¥é“ï¼Œå› ä¸ºè¿™æœªåœ¨é”®ä¸­åæ˜ ã€‚
const route = useRoute()
const { data } = await useAsyncData(async () => {
  return await $fetch(`/api/my-page/${route.params.slug}`)
})
// ç›¸åï¼Œæ‚¨åº”ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€æ ‡è¯†æ‰€è·å–æ•°æ®çš„é”®ã€‚
const { data } = await useAsyncData(route.params.slug, async () => {
  return await $fetch(`/api/my-page/${route.params.slug}`)
})
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ç¦ç”¨æ­¤åŠŸèƒ½ï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    sharedPrerenderData: false
  }
})
```

### `useAsyncData` å’Œ `useFetch` ä¸­çš„é»˜è®¤ `data` å’Œ `error` å€¼

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

ä» `useAsyncData` è¿”å›çš„ `data` å’Œ `error` å¯¹è±¡ç°åœ¨é»˜è®¤ä¸º `undefined`ã€‚

#### å˜æ›´åŸå› 

ä»¥å‰ï¼Œ`data` åˆå§‹åŒ–ä¸º `null`ï¼Œä½†åœ¨ `clearNuxtData` ä¸­é‡ç½®ä¸º `undefined`ã€‚`error` åˆå§‹åŒ–ä¸º `null`ã€‚æ­¤æ›´æ”¹æ—¨åœ¨æé«˜ä¸€è‡´æ€§ã€‚

#### è¿ç§»æ­¥éª¤

å¦‚æœæ‚¨æ£€æŸ¥ `data.value` æˆ– `error.value` æ˜¯å¦ä¸º `null`ï¼Œåˆ™å¯ä»¥å°†è¿™äº›æ£€æŸ¥æ›´æ–°ä¸ºæ£€æŸ¥ `undefined`ã€‚

::tip
æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/default-data-error-value` æ¥è‡ªåŠ¨åŒ–æ­¤æ­¥éª¤
::

å¦‚æœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¢å¤åˆ°ä»¥å‰çš„è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
// @errors: 2353
export default defineNuxtConfig({
  experimental: {
    defaults: {
      useAsyncData: {
        value: 'null',
        errorValue: 'null'
      }
    }
  }
})
```

è¯·æŠ¥å‘Šä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ‚¨æ­£åœ¨æ‰§è¡Œæ­¤æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬ä¸æ‰“ç®—å°†å…¶ä¿æŒä¸ºå¯é…ç½®ã€‚

### åœ¨ `useAsyncData` å’Œ `useFetch` ä¸­è°ƒç”¨ `refresh` æ—¶ç§»é™¤å·²å¼ƒç”¨çš„ `boolean` å€¼ä½œä¸º `dedupe` é€‰é¡¹

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

ä»¥å‰å¯ä»¥å°† `dedupe: boolean` ä¼ é€’ç»™ `refresh`ã€‚è¿™äº›æ˜¯ `cancel` (`true`) å’Œ `defer` (`false`) çš„åˆ«åã€‚

```ts twoslash [app.vue]
// @errors: 2322
const { refresh } = await useAsyncData(async () => ({ message: 'Hello, Nuxt!' }))

async function refreshData () {
  await refresh({ dedupe: true })
}
```

#### å˜æ›´åŸå› 

è¿™äº›åˆ«åè¢«ç§»é™¤ï¼Œä»¥æé«˜æ¸…æ™°åº¦ã€‚

å½“å‘ `useAsyncData` æ·»åŠ  `dedupe` é€‰é¡¹æ—¶å‡ºç°äº†æ­¤é—®é¢˜ï¼Œæˆ‘ä»¬åˆ é™¤äº†å¸ƒå°”å€¼ï¼Œå› ä¸ºå®ƒä»¬æœ€ç»ˆæˆä¸º _åä¹‰_ã€‚

`refresh({ dedupe: false })` çš„æ„æ€æ˜¯ **ä¸å–æ¶ˆç°æœ‰è¯·æ±‚ä»¥æ”¯æŒè¿™ä¸ªæ–°è¯·æ±‚**ã€‚ä½†åœ¨ `useAsyncData` çš„é€‰é¡¹ä¸­ä¼ é€’ `dedupe: true` æ„å‘³ç€ **å¦‚æœæœ‰ç°æœ‰çš„å¾…å¤„ç†è¯·æ±‚ï¼Œåˆ™ä¸å‘èµ·ä»»ä½•æ–°çš„è¯·æ±‚ã€‚**ï¼ˆ[PR](https://github.com/nuxt/nuxt/pull/24564#pullrequestreview-1764584361)ï¼‰

#### è¿ç§»æ­¥éª¤

è¿ç§»åº”è¯¥å¾ˆç®€å•ï¼š

```diff
  const { refresh } = await useAsyncData(async () => ({ message: 'Hello, Nuxt 3!' }))
  
  async function refreshData () {
-   await refresh({ dedupe: true })
+   await refresh({ dedupe: 'cancel' })

-   await refresh({ dedupe: false })
+   await refresh({ dedupe: 'defer' })
  }
```

::tip
æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/deprecated-dedupe-value` è‡ªåŠ¨åŒ–æ­¤æ­¥éª¤
::

### æ¸…é™¤ `useAsyncData` å’Œ `useFetch` ä¸­çš„ `data` æ—¶å°Šé‡é»˜è®¤å€¼

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

å¦‚æœæ‚¨ä¸º `useAsyncData` æä¾›äº†è‡ªå®šä¹‰çš„ `default` å€¼ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨ `clear` æˆ– `clearNuxtData` æ—¶å°†ä½¿ç”¨è¯¥å€¼ï¼Œå¹¶å°†å…¶é‡ç½®ä¸ºé»˜è®¤å€¼ï¼Œè€Œä¸ä»…ä»…æ˜¯å–æ¶ˆè®¾ç½®ã€‚

#### å˜æ›´åŸå› 

ç”¨æˆ·é€šå¸¸ä¼šè®¾ç½®ä¸€ä¸ªé€‚å½“çš„ç©ºå€¼ï¼Œä¾‹å¦‚ç©ºæ•°ç»„ï¼Œä»¥é¿å…åœ¨è¿­ä»£æ—¶éœ€è¦æ£€æŸ¥ `null`/`undefined`ã€‚åœ¨é‡ç½®/æ¸…é™¤æ•°æ®æ—¶åº”å°Šé‡è¿™ä¸€ç‚¹ã€‚

### `useAsyncData` å’Œ `useFetch` ä¸­ `pending` å€¼çš„å¯¹é½

ğŸš¦ **å½±å“çº§åˆ«**ï¼šä¸­ç­‰

ä» `useAsyncData`ã€`useFetch`ã€`useLazyAsyncData` å’Œ `useLazyFetch` è¿”å›çš„ `pending` å¯¹è±¡ç°åœ¨æ˜¯ä¸€ä¸ªè®¡ç®—å±æ€§ï¼Œåªæœ‰åœ¨ `status` ä¹Ÿå¤„äºå¾…å¤„ç†çŠ¶æ€æ—¶æ‰ä¸º `true`ã€‚

#### å˜æ›´å†…å®¹

ç°åœ¨ï¼Œå½“ä¼ å…¥ `immediate: false` æ—¶ï¼Œ`pending` å°†åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚å‘å‡ºä¹‹å‰ä¸º `false`ã€‚è¿™ä¸ä¹‹å‰çš„è¡Œä¸ºä¸åŒï¼Œä¹‹å‰ `pending` åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚å‘å‡ºä¹‹å‰å§‹ç»ˆä¸º `true`ã€‚

#### å˜æ›´åŸå› 

è¿™ä½¿å¾— `pending` çš„å«ä¹‰ä¸ `status` å±æ€§å¯¹é½ï¼Œå½“è¯·æ±‚æ­£åœ¨è¿›è¡Œæ—¶ï¼Œ`status` ä¹Ÿä¸º `pending`ã€‚

#### è¿ç§»æ­¥éª¤

å¦‚æœæ‚¨ä¾èµ–äº `pending` å±æ€§ï¼Œè¯·ç¡®ä¿æ‚¨çš„é€»è¾‘è€ƒè™‘åˆ°æ–°çš„è¡Œä¸ºï¼Œå³ `pending` ä»…åœ¨çŠ¶æ€ä¹Ÿä¸ºå¾…å¤„ç†æ—¶æ‰ä¸º `true`ã€‚

```diff
  <template>
-   <div v-if="!pending">
+   <div v-if="status === 'success'">
      <p>Data: {{ data }}</p>
    </div>
    <div v-else>
      <p>Loading...</p>
    </div>
  </template>
  <script setup lang="ts">
  const { data, pending, execute, status } = await useAsyncData(() => fetch('/api/data'), {
    immediate: false
  })
  onMounted(() => execute())
  </script>
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥æš‚æ—¶æ¢å¤åˆ°ä¹‹å‰çš„è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    pendingWhenIdle: true
  }
})
```

### `useAsyncData` å’Œ `useFetch` ä¸­çš„å…³é”®æ›´æ”¹è¡Œä¸º

ğŸš¦ **å½±å“çº§åˆ«**ï¼šä¸­ç­‰

#### å˜æ›´å†…å®¹

åœ¨ `useAsyncData` æˆ– `useFetch` ä¸­ä½¿ç”¨ååº”æ€§é”®æ—¶ï¼ŒNuxt åœ¨é”®æ›´æ”¹æ—¶ä¼šè‡ªåŠ¨é‡æ–°è·å–æ•°æ®ã€‚å½“è®¾ç½® `immediate: false` æ—¶ï¼Œ`useAsyncData` ä»…åœ¨æ•°æ®å·²ç»è·å–è¿‡ä¸€æ¬¡æ—¶æ‰ä¼šåœ¨é”®æ›´æ”¹æ—¶è·å–æ•°æ®ã€‚

ä¹‹å‰ï¼Œ`useFetch` çš„è¡Œä¸ºç•¥æœ‰ä¸åŒã€‚å®ƒåœ¨é”®æ›´æ”¹æ—¶æ€»æ˜¯ä¼šè·å–æ•°æ®ã€‚

ç°åœ¨ï¼Œ`useFetch` å’Œ `useAsyncData` çš„è¡Œä¸ºä¸€è‡´â€”â€”ä»…åœ¨é”®æ›´æ”¹æ—¶è·å–æ•°æ®ï¼Œå¦‚æœæ•°æ®å·²ç»è·å–è¿‡ä¸€æ¬¡ã€‚

#### å˜æ›´åŸå› 

è¿™ç¡®ä¿äº† `useAsyncData` å’Œ `useFetch` ä¹‹é—´çš„ä¸€è‡´è¡Œä¸ºï¼Œé¿å…äº†æ„å¤–è·å–ã€‚å¦‚æœæ‚¨è®¾ç½®äº† `immediate: false`ï¼Œé‚£ä¹ˆæ‚¨å¿…é¡»æ‰‹åŠ¨è§¦å‘ `refresh` æˆ– `execute`ï¼Œå¦åˆ™æ•°æ®åœ¨ `useFetch` æˆ– `useAsyncData` ä¸­å°†ä»æœªè¢«è·å–ã€‚

#### è¿ç§»æ­¥éª¤

æ­¤æ›´æ”¹åº”æ€»ä½“ä¸Šæé«˜é¢„æœŸè¡Œä¸ºï¼Œä½†å¦‚æœæ‚¨æœŸæœ›æ›´æ”¹ä¸€ä¸ªéç«‹å³çš„ `useFetch` çš„é”®æˆ–é€‰é¡¹ï¼Œç°åœ¨æ‚¨éœ€è¦åœ¨ç¬¬ä¸€æ¬¡æ‰‹åŠ¨è§¦å‘å®ƒã€‚

```diff
  const id = ref('123')
  const { data, execute } = await useFetch('/api/test', {
    query: { id },
    immediate: false
  )
+ watch(id, () => execute(), { once: true })
```

å¦‚æœæ‚¨å¸Œæœ›é€€å‡ºæ­¤è¡Œä¸ºï¼š

```ts
// æˆ–åœ¨æ‚¨çš„ Nuxt é…ç½®ä¸­å…¨å±€è®¾ç½®
export default defineNuxtConfig({
  experimental: {
    alwaysRunFetchOnKeyChange: true
  }
})
```

### `useAsyncData` å’Œ `useFetch` ä¸­çš„æµ…æ•°æ®å“åº”æ€§

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

ä» `useAsyncData`ã€`useFetch`ã€`useLazyAsyncData` å’Œ `useLazyFetch` è¿”å›çš„ `data` å¯¹è±¡ç°åœ¨æ˜¯ä¸€ä¸ª `shallowRef` è€Œä¸æ˜¯ä¸€ä¸ª `ref`ã€‚

#### å˜æ›´å†…å®¹

å½“è·å–æ–°æ•°æ®æ—¶ï¼Œä¾èµ–äº `data` çš„ä»»ä½•å†…å®¹ä»ç„¶æ˜¯ååº”æ€§çš„ï¼Œå› ä¸ºæ•´ä¸ªå¯¹è±¡è¢«æ›¿æ¢ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„ä»£ç æ›´æ”¹äº†è¯¥æ•°æ®ç»“æ„ä¸­çš„æŸä¸ªå±æ€§ï¼Œåˆ™ä¸ä¼šåœ¨æ‚¨çš„åº”ç”¨ä¸­è§¦å‘ä»»ä½•ååº”æ€§ã€‚

#### å˜æ›´åŸå› 

è¿™å¸¦æ¥äº†å¯¹æ·±åº¦åµŒå¥—å¯¹è±¡å’Œæ•°ç»„çš„ **æ˜¾è‘—** æ€§èƒ½æå‡ï¼Œå› ä¸º Vue ä¸éœ€è¦ç›‘è§†æ¯ä¸ªå±æ€§/æ•°ç»„çš„ä¿®æ”¹ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ`data` ä¹Ÿåº”è¯¥æ˜¯ä¸å¯å˜çš„ã€‚

#### è¿ç§»æ­¥éª¤

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸éœ€è¦è¿ç§»æ­¥éª¤ï¼Œä½†å¦‚æœæ‚¨ä¾èµ–äºæ•°æ®å¯¹è±¡çš„ååº”æ€§ï¼Œåˆ™æ‚¨æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼š

1. æ‚¨å¯ä»¥é€ä¸ªç»„åˆåœ°é€‰æ‹©åŠ å…¥æ·±åº¦ååº”æ€§ï¼š
   ```diff
   - const { data } = useFetch('/api/test')
   + const { data } = useFetch('/api/test', { deep: true })
   ```
2. æ‚¨å¯ä»¥åœ¨é¡¹ç›®èŒƒå›´å†…æ›´æ”¹é»˜è®¤è¡Œä¸ºï¼ˆä¸å»ºè®®ï¼‰ï¼š
   ```ts twoslash [nuxt.config.ts]
   export default defineNuxtConfig({
     experimental: {
       defaults: {
         useAsyncData: {
           deep: true
         }
       }
     }
   })
   ```

::tip
å¦‚æœ‰éœ€è¦ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/shallow-function-reactivity` è‡ªåŠ¨åŒ–æ­¤æ­¥éª¤
::

### `builder:watch` ä¸­çš„ç»å¯¹ç›‘è§†è·¯å¾„

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

Nuxt `builder:watch` é’©å­ç°åœ¨å‘å‡ºä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œè€Œä¸æ˜¯ç›¸å¯¹äºæ‚¨çš„é¡¹ç›® `srcDir` çš„è·¯å¾„ã€‚

#### å˜æ›´åŸå› 

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿæ”¯æŒç›‘è§†ä½äº `srcDir` ä¹‹å¤–çš„è·¯å¾„ï¼Œå¹¶æä¾›å¯¹å±‚å’Œå…¶ä»–æ›´å¤æ‚æ¨¡å¼çš„æ›´å¥½æ”¯æŒã€‚

#### è¿ç§»æ­¥éª¤

æˆ‘ä»¬å·²ç»ç§¯æè¿ç§»äº†æˆ‘ä»¬çŸ¥é“ä½¿ç”¨æ­¤é’©å­çš„å…¬å…± Nuxt æ¨¡å—ã€‚è¯·å‚é˜… [issue #25339](https://github.com/nuxt/nuxt/issues/25339)ã€‚

ç„¶è€Œï¼Œå¦‚æœæ‚¨æ˜¯æ¨¡å—ä½œè€…ï¼Œä½¿ç”¨ `builder:watch` é’©å­å¹¶å¸Œæœ›ä¿æŒå‘å/å‘å‰å…¼å®¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç æ¥ç¡®ä¿æ‚¨çš„ä»£ç åœ¨ Nuxt v3 å’Œ Nuxt v4 ä¸­çš„å·¥ä½œæ–¹å¼ç›¸åŒï¼š

```diff
+ import { relative, resolve } from 'node:fs'
  // ...
  nuxt.hook('builder:watch', async (event, path) => {
+   path = relative(nuxt.options.srcDir, resolve(nuxt.options.srcDir, path))
    // ...
  })
```

::tip
æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/absolute-watch-path` è‡ªåŠ¨åŒ–æ­¤æ­¥éª¤
::

### ç§»é™¤ `window.__NUXT__` å¯¹è±¡

#### å˜æ›´å†…å®¹

æˆ‘ä»¬åœ¨åº”ç”¨å®Œæˆæ°´åˆåï¼Œå°†ç§»é™¤å…¨å±€ `window.__NUXT__` å¯¹è±¡ã€‚

#### å˜æ›´åŸå› 

è¿™ä¸ºå¤šåº”ç”¨æ¨¡å¼ï¼ˆ[#21635](https://github.com/nuxt/nuxt/issues/21635)ï¼‰æ‰“å¼€äº†å¤§é—¨ï¼Œå¹¶ä½¿æˆ‘ä»¬èƒ½å¤Ÿä¸“æ³¨äºä¸€ç§è®¿é—® Nuxt åº”ç”¨æ•°æ®çš„æ–¹å¼â€”â€”`useNuxtApp()`ã€‚

#### è¿ç§»æ­¥éª¤

æ•°æ®ä»ç„¶å¯ç”¨ï¼Œä½†å¯ä»¥é€šè¿‡ `useNuxtApp().payload` è®¿é—®ï¼š

```diff
- console.log(window.__NUXT__)
+ console.log(useNuxtApp().payload)
```

### ç›®å½•ç´¢å¼•æ‰«æ

ğŸš¦ **å½±å“çº§åˆ«**ï¼šé€‚ä¸­

#### å˜æ›´å†…å®¹

ç°åœ¨æ‚¨çš„ `middleware/` æ–‡ä»¶å¤¹ä¸­çš„å­æ–‡ä»¶å¤¹ä¹Ÿä¼šæ‰«æ `index` æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ç°åœ¨ä¹Ÿå°†åœ¨æ‚¨çš„é¡¹ç›®ä¸­æ³¨å†Œä¸ºä¸­é—´ä»¶ã€‚

#### å˜æ›´åŸå› 

Nuxt ä¼šè‡ªåŠ¨æ‰«æå¤šä¸ªæ–‡ä»¶å¤¹ï¼ŒåŒ…æ‹¬ `middleware/` å’Œ `plugins/`ã€‚

æˆ‘ä»¬å¸Œæœ›åœ¨æ‰«æç›®å½•ä¹‹é—´ä¿æŒè¿™ç§è¡Œä¸ºä¸€è‡´ï¼Œå› æ­¤åœ¨ `plugins/` æ–‡ä»¶å¤¹ä¸­çš„å­æ–‡ä»¶å¤¹ä¹Ÿä¼šæ‰«æ `index` æ–‡ä»¶ã€‚

#### è¿ç§»æ­¥éª¤

å¯èƒ½ä¸éœ€è¦ä»»ä½•è¿ç§»ï¼Œä½†å¦‚æœæ‚¨å¸Œæœ›æ¢å¤åˆ°ä»¥å‰çš„è¡Œä¸ºï¼Œæ‚¨å¯ä»¥æ·»åŠ ä¸€ä¸ªé’©å­ä»¥è¿‡æ»¤æ‰è¿™äº›ä¸­é—´ä»¶ï¼š

```ts
export default defineNuxtConfig({
  hooks: {
    'app:resolve'(app) {
      app.middleware = app.middleware.filter(mw => !/\/index\.[^/]+$/.test(mw.path))
    }
  }
})
```

### æ¨¡æ¿ç¼–è¯‘æ›´æ”¹

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

ä»¥å‰ï¼ŒNuxt ä½¿ç”¨ `lodash/template` æ¥ç¼–è¯‘ä½äºæ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ¨¡æ¿ï¼Œä½¿ç”¨ `.ejs` æ–‡ä»¶æ ¼å¼/è¯­æ³•ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€äº›æ¨¡æ¿å®ç”¨å·¥å…·ï¼ˆ`serialize`ã€`importName`ã€`importSources`ï¼‰ï¼Œè¿™äº›å®ç”¨å·¥å…·å¯ä»¥åœ¨è¿™äº›æ¨¡æ¿ä¸­ç”¨äºä»£ç ç”Ÿæˆï¼Œç°åœ¨å°†è¢«ç§»é™¤ã€‚

#### å˜æ›´åŸå› 

åœ¨ Nuxt v3 ä¸­ï¼Œæˆ‘ä»¬è½¬å‘äº†ä¸€ç§â€œè™šæ‹Ÿâ€è¯­æ³•ï¼Œä½¿ç”¨ `getContents()` å‡½æ•°ï¼Œè¿™æ ·æ›´åŠ çµæ´»ä¸”æ€§èƒ½è‰¯å¥½ã€‚

æ­¤å¤–ï¼Œ`lodash/template` é‡åˆ°äº†ä¸€ç³»åˆ—å®‰å…¨é—®é¢˜ã€‚è¿™äº›é—®é¢˜å¹¶ä¸çœŸæ­£é€‚ç”¨äº Nuxt é¡¹ç›®ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨æ„å»ºæ—¶ä½¿ç”¨è€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶ï¼Œå¹¶ä¸”ç”±å—ä¿¡ä»»çš„ä»£ç ä½¿ç”¨ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬ä»ä¼šå‡ºç°åœ¨å®‰å…¨å®¡è®¡ä¸­ã€‚æ­¤å¤–ï¼Œ`lodash` æ˜¯ä¸€ä¸ªåºå¤§çš„ä¾èµ–é¡¹ï¼Œå¤§å¤šæ•°é¡¹ç›®éƒ½ä¸ä½¿ç”¨å®ƒã€‚

æœ€åï¼Œå°†ä»£ç åºåˆ—åŒ–åŠŸèƒ½ç›´æ¥æä¾›ç»™ Nuxt å¹¶ä¸ç†æƒ³ã€‚ç›¸åï¼Œæˆ‘ä»¬ç»´æŠ¤åƒ [unjs/knitwork](http://github.com/unjs/knitwork) è¿™æ ·çš„é¡¹ç›®ï¼Œå¯ä»¥ä½œä¸ºæ‚¨é¡¹ç›®çš„ä¾èµ–é¡¹ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥æŠ¥å‘Š/è§£å†³å®‰å…¨é—®é¢˜ï¼Œè€Œæ— éœ€æ›´æ–° Nuxt æœ¬èº«ã€‚

#### è¿ç§»æ­¥éª¤

æˆ‘ä»¬å·²ç»æå‡º PR æ¥æ›´æ–°ä½¿ç”¨ EJS è¯­æ³•çš„æ¨¡å—ï¼Œä½†å¦‚æœæ‚¨éœ€è¦è‡ªå·±æ‰§è¡Œæ­¤æ“ä½œï¼Œæ‚¨æœ‰ä¸‰ä¸ªå‘å/å‘å‰å…¼å®¹çš„æ›¿ä»£æ–¹æ¡ˆï¼š

* å°†å­—ç¬¦ä¸²æ’å€¼é€»è¾‘ç›´æ¥ç§»åŠ¨åˆ° `getContents()` ä¸­ã€‚
* ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°è¿›è¡Œæ›¿æ¢ï¼Œä¾‹å¦‚åœ¨ https://github.com/nuxt-modules/color-mode/pull/240 ä¸­ã€‚
* åœ¨æ‚¨çš„é¡¹ç›®ä¸­å°† `es-toolkit/compat` ä½œä¸ºä¾èµ–é¡¹ä½¿ç”¨ï¼ˆè¿™æ˜¯ lodash æ¨¡æ¿çš„æ›¿ä»£å“ï¼‰ï¼š

```diff
+ import { readFileSync } from 'node:fs'
+ import { template } from 'es-toolkit/compat'
  // ...
  addTemplate({
    fileName: 'appinsights-vue.js'
    options: { /* some options */ },
-   src: resolver.resolve('./runtime/plugin.ejs'),
+   getContents({ options }) {
+     const contents = readFileSync(resolver.resolve('./runtime/plugin.ejs'), 'utf-8')
+     return template(contents)({ options })
+   },
  })
```

æœ€åï¼Œå¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨æ¨¡æ¿å®ç”¨ç¨‹åºï¼ˆ`serialize`ã€`importName`ã€`importSources`ï¼‰ï¼Œæ‚¨å¯ä»¥ç”¨æ¥è‡ª `knitwork` çš„å®ç”¨ç¨‹åºæ›¿æ¢å®ƒä»¬ï¼š

```ts
import { genDynamicImport, genImport, genSafeVariableName } from 'knitwork'

const serialize = (data: any) => JSON.stringify(data, null, 2).replace(/"{(.+)}"(?=,?$)/gm, r => JSON.parse(r).replace(/^{(.*)}$/, '$1'))

const importSources = (sources: string | string[], { lazy = false } = {}) => {
  return toArray(sources).map((src) => {
    if (lazy) {
      return `const ${genSafeVariableName(src)} = ${genDynamicImport(src, { comment: `webpackChunkName: ${JSON.stringify(src)}` })}`
    }
    return genImport(src, genSafeVariableName(src))
  }).join('\n')
}

const importName = genSafeVariableName
```

::tip
æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/template-compilation-changes` è‡ªåŠ¨åŒ–æ­¤æ­¥éª¤
::

### TypeScript é…ç½®æ›´æ”¹

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

Nuxt ç°åœ¨ä¸ºä¸åŒçš„ä¸Šä¸‹æ–‡ç”Ÿæˆç‹¬ç«‹çš„ TypeScript é…ç½®ï¼Œä»¥æä¾›æ›´å¥½çš„ç±»å‹æ£€æŸ¥ä½“éªŒï¼š

1. **æ–°çš„ TypeScript é…ç½®æ–‡ä»¶**ï¼šNuxt ç°åœ¨ç”Ÿæˆé¢å¤–çš„ TypeScript é…ç½®ï¼š
   * `.nuxt/tsconfig.app.json` - ç”¨äºæ‚¨çš„åº”ç”¨ç¨‹åºä»£ç ï¼ˆVue ç»„ä»¶ã€ç»„åˆå¼ç­‰ï¼‰
   * `.nuxt/tsconfig.server.json` - ç”¨äºæ‚¨çš„æœåŠ¡å™¨ç«¯ä»£ç ï¼ˆNitro/server ç›®å½•ï¼‰
   * `.nuxt/tsconfig.node.json` - ç”¨äºæ‚¨çš„æ„å»ºæ—¶ä»£ç ï¼ˆæ¨¡å—ã€`nuxt.config.ts` ç­‰ï¼‰
   * `.nuxt/tsconfig.shared.json` - ç”¨äºåº”ç”¨ç¨‹åºå’ŒæœåŠ¡å™¨ä¸Šä¸‹æ–‡ä¹‹é—´å…±äº«çš„ä»£ç ï¼ˆå¦‚ç±»å‹å’Œéç¯å¢ƒç‰¹å®šå®ç”¨ç¨‹åºï¼‰
   * `.nuxt/tsconfig.json` - æ—§ç‰ˆé…ç½®ï¼Œä»¥ä¿æŒå‘åå…¼å®¹æ€§

2. **å‘åå…¼å®¹æ€§**ï¼šæ‰©å±• `.nuxt/tsconfig.json` çš„ç°æœ‰é¡¹ç›®å°†ç»§ç»­æŒ‰ä»¥å‰çš„æ–¹å¼å·¥ä½œã€‚

3. **é€‰æ‹©æ€§é¡¹ç›®å¼•ç”¨**ï¼šæ–°é¡¹ç›®æˆ–å¸Œæœ›è·å¾—æ›´å¥½ç±»å‹æ£€æŸ¥çš„é¡¹ç›®å¯ä»¥é‡‡ç”¨ TypeScript çš„é¡¹ç›®å¼•ç”¨åŠŸèƒ½ã€‚

4. **ç‰¹å®šä¸Šä¸‹æ–‡çš„ç±»å‹æ£€æŸ¥**ï¼šæ¯ä¸ªä¸Šä¸‹æ–‡ç°åœ¨éƒ½æœ‰é€‚å½“çš„ç¼–è¯‘å™¨é€‰é¡¹å’ŒåŒ…å«/æ’é™¤ç‰¹å®šç¯å¢ƒçš„è®¾ç½®ã€‚

5. **æ–°çš„ `typescript.nodeTsConfig` é€‰é¡¹**ï¼šæ‚¨ç°åœ¨å¯ä»¥è‡ªå®šä¹‰ Node.js æ„å»ºæ—¶ä»£ç çš„ TypeScript é…ç½®ã€‚

#### å˜æ›´åŸå› 

æ­¤æ›´æ”¹æä¾›äº†å‡ ä¸ªå¥½å¤„ï¼š

1. **æ›´å¥½çš„ç±»å‹å®‰å…¨**ï¼šæ¯ä¸ªä¸Šä¸‹æ–‡ï¼ˆåº”ç”¨ç¨‹åºã€æœåŠ¡å™¨ã€æ„å»ºæ—¶ï¼‰éƒ½è·å¾—äº†é€‚å½“çš„ç±»å‹æ£€æŸ¥ï¼Œå…·æœ‰ç‰¹å®šäºä¸Šä¸‹æ–‡çš„å…¨å±€å˜é‡å’Œ APIã€‚
2. **æ”¹è¿›çš„ IDE ä½“éªŒ**ï¼šä¸ºä»£ç åº“çš„ä¸åŒéƒ¨åˆ†æä¾›æ›´å¥½çš„ IntelliSense å’Œé”™è¯¯æŠ¥å‘Šã€‚
3. **æ›´æ¸…æ™°çš„åˆ†ç¦»**ï¼šæœåŠ¡å™¨ä»£ç ä¸ä¼šé”™è¯¯åœ°å»ºè®®å®¢æˆ·ç«¯ APIï¼Œåä¹‹äº¦ç„¶ã€‚
4. **æ€§èƒ½**ï¼šTypeScript å¯ä»¥æ›´æœ‰æ•ˆåœ°æ£€æŸ¥å…·æœ‰é€‚å½“ä½œç”¨åŸŸé…ç½®çš„ä»£ç ã€‚

ä¾‹å¦‚ï¼Œè‡ªåŠ¨å¯¼å…¥åœ¨æ‚¨çš„ `nuxt.config.ts` ä¸­ä¸å¯ç”¨ï¼ˆä½†ä»¥å‰è¿™å¹¶æœªè¢« TypeScript æ ‡è®°ï¼‰ã€‚è™½ç„¶ IDE è¯†åˆ«äº† `server/` ç›®å½•ä¸­ `tsconfig.json` æç¤ºçš„å•ç‹¬ä¸Šä¸‹æ–‡ï¼Œä½†è¿™å¹¶æœªåæ˜ åœ¨ç±»å‹æ£€æŸ¥ä¸­ï¼ˆéœ€è¦å•ç‹¬çš„æ­¥éª¤ï¼‰ã€‚

#### è¿ç§»æ­¥éª¤

**ä¸éœ€è¦è¿ç§»** - ç°æœ‰é¡¹ç›®å°†ç»§ç»­æŒ‰ä»¥å‰çš„æ–¹å¼å·¥ä½œã€‚

ä½†æ˜¯ï¼Œä¸ºäº†åˆ©ç”¨æ”¹è¿›çš„ç±»å‹æ£€æŸ¥ï¼Œæ‚¨å¯ä»¥é€‰æ‹©é‡‡ç”¨æ–°çš„é¡¹ç›®å¼•ç”¨æ–¹æ³•ï¼š

1. **æ›´æ–°æ‚¨çš„æ ¹ `tsconfig.json`** ä»¥ä½¿ç”¨é¡¹ç›®å¼•ç”¨ï¼š

   ```json
   {
     "files": [],
     "references": [
       { "path": "./.nuxt/tsconfig.app.json" },
       { "path": "./.nuxt/tsconfig.server.json" },
       { "path": "./.nuxt/tsconfig.shared.json" },
       { "path": "./.nuxt/tsconfig.node.json" }
     ]
   }
   ```

2. **åˆ é™¤ä»»ä½•æ‰‹åŠ¨çš„æœåŠ¡å™¨ `tsconfig.json`** æ–‡ä»¶ï¼ˆå¦‚ `server/tsconfig.json`ï¼‰ï¼Œè¿™äº›æ–‡ä»¶æ‰©å±•äº† `.nuxt/tsconfig.server.json`ã€‚

3. **æ›´æ–°æ‚¨çš„ç±»å‹æ£€æŸ¥è„šæœ¬** ä»¥ä½¿ç”¨é¡¹ç›®å¼•ç”¨çš„æ„å»ºæ ‡å¿—ï¼š

   ```diff
   - "typecheck": "nuxt prepare && vue-tsc --noEmit"
   + "typecheck": "nuxt prepare && vue-tsc -b --noEmit"
   ```

4. **å¦‚æœéœ€è¦ï¼Œé…ç½® Node.js TypeScript é€‰é¡¹ï¼š**
   <!-- @case-police-ignore tsConfig -->

   ```ts
   export default defineNuxtConfig({
     typescript: {
       // Customize app/server TypeScript config
       tsConfig: {
         compilerOptions: {
           strict: true
         }
       },
       // Customize build-time TypeScript config  
       nodeTsConfig: {
         compilerOptions: {
           strict: true
         }
       }
     }
   })
   ```

5. **æ›´æ–°ä»»ä½•è¿è¡Œ TypeScript æ£€æŸ¥çš„ CI/æ„å»ºè„šæœ¬**ï¼Œä»¥ç¡®ä¿å®ƒä»¬ä½¿ç”¨æ–°çš„é¡¹ç›®å¼•ç”¨æ–¹æ³•ã€‚

æ–°çš„é…ç½®ä¸ºé€‰æ‹©åŠ å…¥çš„é¡¹ç›®æä¾›äº†æ›´å¥½çš„ç±»å‹å®‰å…¨æ€§å’Œæ™ºèƒ½æ„ŸçŸ¥ï¼ŒåŒæ—¶ä¿æŒå¯¹ç°æœ‰è®¾ç½®çš„å®Œå…¨å‘åå…¼å®¹ã€‚

### ç§»é™¤å®éªŒæ€§åŠŸèƒ½

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

åœ¨ Nuxt 4 ä¸­ï¼Œå››ä¸ªå®éªŒæ€§åŠŸèƒ½ä¸å†å¯é…ç½®ï¼š

* `experimental.treeshakeClientOnly` å°†ä¸º `true`ï¼ˆè‡ª v3.0 èµ·é»˜è®¤ï¼‰
* `experimental.configSchema` å°†ä¸º `true`ï¼ˆè‡ª v3.3 èµ·é»˜è®¤ï¼‰
* `experimental.polyfillVueUseHead` å°†ä¸º `false`ï¼ˆè‡ª v3.4 èµ·é»˜è®¤ï¼‰
* `experimental.respectNoSSRHeader` å°†ä¸º `false`ï¼ˆè‡ª v3.4 èµ·é»˜è®¤ï¼‰
* `vite.devBundler` ä¸å†å¯é…ç½® - å®ƒå°†é»˜è®¤ä½¿ç”¨ `vite-node`

#### å˜æ›´åŸå› 

è¿™äº›é€‰é¡¹å·²ç»åœ¨ä¸€æ®µæ—¶é—´å†…è®¾ç½®ä¸ºå…¶å½“å‰å€¼ï¼Œæˆ‘ä»¬æ²¡æœ‰ç†ç”±ç›¸ä¿¡å®ƒä»¬éœ€è¦ä¿æŒå¯é…ç½®ã€‚

#### è¿ç§»æ­¥éª¤

* `polyfillVueUseHead` å¯ä»¥é€šè¿‡ [æ­¤æ’ä»¶](https://github.com/nuxt/nuxt/blob/f209158352b09d1986aa320e29ff36353b91c358/packages/nuxt/src/head/runtime/plugins/vueuse-head-polyfill.ts#L10-L11) åœ¨ç”¨æˆ·ç©ºé—´å®ç°ã€‚

* `respectNoSSRHeader` å¯ä»¥é€šè¿‡ [æœåŠ¡å™¨ä¸­é—´ä»¶](https://github.com/nuxt/nuxt/blob/c660b39447f0d5b8790c0826092638d321cd6821/packages/nuxt/src/core/runtime/nitro/no-ssr.ts#L8-L9) åœ¨ç”¨æˆ·ç©ºé—´å®ç°ã€‚

### ç§»é™¤é¡¶çº§ `generate` é…ç½®

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜æ›´å†…å®¹

é¡¶çº§çš„ `generate` é…ç½®é€‰é¡¹åœ¨ Nuxt 4 ä¸­ä¸å†å¯ç”¨ã€‚è¿™åŒ…æ‹¬å®ƒçš„æ‰€æœ‰å±æ€§ï¼š

* `generate.exclude` - ç”¨äºæ’é™¤ä¸è¿›è¡Œé¢„æ¸²æŸ“çš„è·¯ç”±
* `generate.routes` - ç”¨äºæŒ‡å®šè¦é¢„æ¸²æŸ“çš„è·¯ç”±

#### å˜æ›´åŸå› 

é¡¶çº§çš„ `generate` é…ç½®æ˜¯ Nuxt 2 çš„é—ç•™éƒ¨åˆ†ã€‚æˆ‘ä»¬å·²ç»æ”¯æŒ `nitro.prerender` ä¸€æ®µæ—¶é—´äº†ï¼Œå®ƒæ˜¯ Nuxt 3+ ä¸­é…ç½®é¢„æ¸²æŸ“çš„é¦–é€‰æ–¹å¼ã€‚

#### è¿ç§»æ­¥éª¤

ç”¨ç›¸åº”çš„ `nitro.prerender` é€‰é¡¹æ›¿æ¢ `generate` é…ç½®ï¼š

```diff
export default defineNuxtConfig({
- generate: {
-   exclude: ['/admin', '/private'],
-   routes: ['/sitemap.xml', '/robots.txt']
- }
+ nitro: {
+   prerender: {
+     ignore: ['/admin', '/private'],
+     routes: ['/sitemap.xml', '/robots.txt']
+   }
+ }
})
```

::read-more{to="https://nitro.zhcndoc.com/config/#prerender"}
äº†è§£æ›´å¤šå…³äº Nitro çš„é¢„æ¸²æŸ“é…ç½®é€‰é¡¹ã€‚
::

## Nuxt 2 ä¸ Nuxt 3+

åœ¨ä¸‹é¢çš„è¡¨æ ¼ä¸­ï¼Œå¿«é€Ÿæ¯”è¾ƒäº† 3 ä¸ªç‰ˆæœ¬çš„ Nuxtï¼š

ç‰¹æ€§ / ç‰ˆæœ¬        | Nuxt 2          | Nuxt Bridge      | Nuxt 3+
-------------------|------------------|-------------------|---------
Vue                | 2                | 2                 | 3
ç¨³å®šæ€§             | ğŸ˜Š ç¨³å®š          | ğŸ˜Š ç¨³å®š           | ğŸ˜Š ç¨³å®š
æ€§èƒ½               | ğŸ å¿«            | âœˆï¸ æ›´å¿«           | ğŸš€ æœ€å¿«
Nitro å¼•æ“         | âŒ               | âœ…                | âœ…
ESM æ”¯æŒ           | ğŸŒ™ éƒ¨åˆ†          | ğŸ‘ æ›´å¥½           | âœ…
TypeScript         | â˜‘ï¸ é€‰æ‹©åŠ å…¥      | ğŸš§ éƒ¨åˆ†           | âœ…
ç»„åˆ API          | âŒ               | ğŸš§ éƒ¨åˆ†           | âœ…
é€‰é¡¹ API          | âœ…               | âœ…                | âœ…
ç»„ä»¶è‡ªåŠ¨å¯¼å…¥      | âœ…               | âœ…                | âœ…
`<script setup>` è¯­æ³• | âŒ               | ğŸš§ éƒ¨åˆ†           | âœ…
è‡ªåŠ¨å¯¼å…¥          | âŒ               | âœ…                | âœ…
webpack            | 4                | 4                 | 5
Vite              | âš ï¸ éƒ¨åˆ†           | ğŸš§ éƒ¨åˆ†           | âœ…
Nuxt CLI          | âŒ æ—§ç‰ˆ         | âœ… nuxt           | âœ… nuxt
é™æ€ç½‘ç«™          | âœ…               | âœ…                | âœ…

## ä» Nuxt 2 å‡çº§åˆ° Nuxt 3+

è¿ç§»æŒ‡å—æä¾›äº† Nuxt 2 ç‰¹æ€§çš„é€æ­¥æ¯”è¾ƒä¸ Nuxt 3+ ç‰¹æ€§ï¼Œå¹¶æŒ‡å¯¼æ‚¨è°ƒæ•´å½“å‰åº”ç”¨ã€‚

::read-more{to="/docs/migration/overview"}
æŸ¥çœ‹ **ä» Nuxt 2 è¿ç§»åˆ° Nuxt 3 çš„æŒ‡å—**ã€‚
::

## ä» Nuxt 2 è¿ç§»åˆ° Nuxt Bridge

å¦‚æœæ‚¨å¸Œæœ›é€æ­¥å°† Nuxt 2 åº”ç”¨ç¨‹åºè¿ç§»åˆ° Nuxt 3ï¼Œå¯ä»¥ä½¿ç”¨ Nuxt Bridgeã€‚Nuxt Bridge æ˜¯ä¸€ä¸ªå…¼å®¹å±‚ï¼Œå…è®¸æ‚¨åœ¨ Nuxt 2 ä¸­ä½¿ç”¨ Nuxt 3+ åŠŸèƒ½ï¼Œé‡‡ç”¨é€‰æ‹©åŠ å…¥æœºåˆ¶ã€‚

::read-more{to="/docs/bridge/overview"}
**ä» Nuxt 2 è¿ç§»åˆ° Nuxt Bridge**
::
