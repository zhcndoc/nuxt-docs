---
title: å‡çº§æŒ‡å—
description: 'äº†è§£å¦‚ä½•å‡çº§åˆ°æœ€æ–°çš„ Nuxt ç‰ˆæœ¬ã€‚'
navigation.icon: i-lucide-circle-arrow-up
---

## å‡çº§ Nuxt

### æœ€æ–°ç‰ˆæœ¬

è¦å°† Nuxt å‡çº§åˆ°[æœ€æ–°ç‰ˆæœ¬](https://github.com/nuxt/nuxt/releases)ï¼Œè¯·ä½¿ç”¨ `nuxt upgrade` å‘½ä»¤ã€‚

::code-group{sync="pm"}

```bash [npm]
npx nuxt upgrade
```

```bash [yarn]
yarn nuxt upgrade
```

```bash [pnpm]
pnpm nuxt upgrade
```

```bash [bun]
bun x nuxt upgrade
```

::

### æ¯æ—¥æ„å»ºç‰ˆæœ¬æ¸ é“

è¦åœ¨æ–°ç‰¹æ€§å‘å¸ƒå‰ä½¿ç”¨æœ€æ–°çš„ Nuxt æ„å»ºå¹¶è¿›è¡Œæµ‹è¯•ï¼Œè¯·é˜…è¯» [æ¯æ—¥æ„å»ºç‰ˆæœ¬æ¸ é“](/docs/guide/going-further/nightly-release-channel) æŒ‡å—ã€‚

::warning
æ¯æ—¥æ„å»ºç‰ˆæœ¬æ¸ é“ `latest` æ ‡ç­¾ç›®å‰è·Ÿè¸ª Nuxt v4 åˆ†æ”¯ï¼Œè¿™æ„å‘³ç€ç°åœ¨ç‰¹åˆ«å¯èƒ½å­˜åœ¨ç ´åæ€§æ›´æ”¹ â€”â€” è¯·åŠ¡å¿…å°å¿ƒï¼ä½ å¯ä»¥é€šè¿‡ `"nuxt": "npm:nuxt-nightly@3x"` é€‰æ‹©ä½¿ç”¨ 3.x åˆ†æ”¯çš„æ¯æ—¥æ„å»ºç‰ˆæœ¬ã€‚
::

## æµ‹è¯• Nuxt 4

Nuxt 4 **è®¡åˆ’äº 2025 å¹´ç¬¬äºŒå­£åº¦å‘å¸ƒ**ã€‚å®ƒå°†åŒ…å«æ‰€æœ‰å½“å‰é€šè¿‡ `compatibilityVersion: 4` å¯ç”¨çš„åŠŸèƒ½ã€‚

åœ¨æ­£å¼å‘å¸ƒä¹‹å‰ï¼Œå¯ä»¥ä» Nuxt 3.12 ç‰ˆæœ¬å¼€å§‹æµ‹è¯•è®¸å¤š Nuxt 4 çš„ç ´åæ€§æ›´æ”¹ã€‚

:video-accordion{title="è§‚çœ‹ Alexander Lichter ä»‹ç»å¦‚ä½•é€‰æ‹© Nuxt 4 ç ´åæ€§æ›´æ”¹çš„è§†é¢‘" videoId="r4wFKlcJK6c"}

### é€‰æ‹©ä½¿ç”¨ Nuxt 4

é¦–å…ˆï¼Œå°† Nuxt å‡çº§åˆ°[æœ€æ–°ç‰ˆæœ¬](https://github.com/nuxt/nuxt/releases)ã€‚

ç„¶åï¼Œä½ å¯ä»¥è®¾ç½® `compatibilityVersion` æ¥åŒ¹é… Nuxt 4 çš„è¡Œä¸ºï¼š

::code-collapse
```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  future: {
    compatibilityVersion: 4,
  },
  // è‹¥è¦é‡æ–°å¯ç”¨ _å…¨éƒ¨_ Nuxt v3 çš„è¡Œä¸ºï¼Œè¯·è®¾ç½®ä»¥ä¸‹é€‰é¡¹ï¼š
  // srcDir: '.',
  // dir: {
  //   app: 'app'
  // },
  // experimental: {
  //   scanPageMeta: 'after-resolve',
  //   sharedPrerenderData: false,
  //   compileTemplate: true,
  //   resetAsyncDataToUndefined: true,
  //   templateUtils: true,
  //   relativeWatchPaths: true,
  //   normalizeComponentNames: false,
  //   spaLoadingTemplateLocation: 'within',
  //   parseErrorData: false,
  //   pendingWhenIdle: true,
  //   alwaysRunFetchOnKeyChange: true,
  //   defaults: {
  //     useAsyncData: {
  //       deep: true
  //     }
  //   }
  // },
  // features: {
  //   inlineStyles: true
  // },
  // unhead: {
  //   renderSSRHeadOptions: {
  //     omitLineBreaks: false
  //   }
  // }
})
```
::

::note
ç›®å‰ï¼Œä½ éœ€è¦åœ¨æ¯ä¸ªé€‰æ‹© Nuxt 4 è¡Œä¸ºçš„å±‚å†…å®šä¹‰ `compatibilityVersion`ã€‚åœ¨ Nuxt 4 å‘å¸ƒåï¼Œå°†ä¸å†éœ€è¦è¿™æ ·åšã€‚
::

å½“ä½ å°† `compatibilityVersion` è®¾ç½®ä¸º `4` æ—¶ï¼ŒNuxt é…ç½®ä¸­çš„é»˜è®¤å€¼å°†æ›´æ”¹ä»¥é€‚åº” Nuxt v4 è¡Œä¸ºï¼Œä½†ä½ å¯ä»¥æ ¹æ®ä¸Šé¢æ³¨é‡Šçš„è¡Œå†…å®¹ï¼Œåœ¨æµ‹è¯•ä¸­é€æ­¥é‡æ–°å¯ç”¨ Nuxt v3 çš„è¡Œä¸ºã€‚å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æäº¤ issueï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨ Nuxt æˆ–ç”Ÿæ€ç³»ç»Ÿä¸­ä¿®å¤ã€‚

é‡å¤§æˆ–ç ´åæ€§å˜æ›´å°†ä¼šåœ¨è¿™é‡Œè¿›è¡Œè¯´æ˜ï¼Œå¹¶æä¾›å‘å‰/å‘åå…¼å®¹çš„è¿ç§»æ­¥éª¤ã€‚

::note
æ­¤éƒ¨åˆ†å†…å®¹ç›´åˆ°æœ€ç»ˆå‘å¸ƒå‰å¯èƒ½ä¼šæœ‰å˜åŒ–ï¼Œå¦‚æœä½ æ­£åœ¨ä½¿ç”¨ `compatibilityVersion: 4` æµ‹è¯• Nuxt 4ï¼Œè¯·å®šæœŸå›æ¥æŸ¥çœ‹ã€‚
::

### ä½¿ç”¨ Codemods è¿ç§»

ä¸ºäº†ç®€åŒ–å‡çº§æµç¨‹ï¼Œæˆ‘ä»¬ä¸ [Codemod](https://github.com/codemod-com/codemod) å›¢é˜Ÿåˆä½œï¼Œæä¾›äº†ä¸€äº›å¼€æºçš„ä»£ç è½¬æ¢å·¥å…·ï¼ˆcodemodsï¼‰æ¥è‡ªåŠ¨æ‰§è¡Œè®¸å¤šè¿ç§»æ­¥éª¤ã€‚

::note
å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·é€šè¿‡ `npx codemod feedback` å‘ Codemod å›¢é˜Ÿåé¦ˆ ğŸ™
::

æœ‰å…³å®Œæ•´çš„ Nuxt 4 codemods åˆ—è¡¨ã€æ¯ä¸ªå·¥å…·çš„è¯¦ç»†ä¿¡æ¯ã€æºç å’Œå¤šç§è¿è¡Œæ–¹å¼ï¼Œè¯·è®¿é—® [Codemod æ³¨å†Œè¡¨](https://go.codemod.com/codemod-registry)ã€‚

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ `codemod` å‘½ä»¤æ‰§è¡Œæœ¬æŒ‡å—ä¸­æåˆ°çš„æ‰€æœ‰ codemodsï¼š

::code-group

```bash [npm]
npx codemod@latest nuxt/4/migration-recipe
```

```bash [yarn]
yarn dlx codemod@latest nuxt/4/migration-recipe
```

```bash [pnpm]
pnpm dlx codemod@latest nuxt/4/migration-recipe
```

```bash [bun]
bun x codemod@latest nuxt/4/migration-recipe
```

::

è¯¥å‘½ä»¤å°†ä¼šæŒ‰é¡ºåºè¿è¡Œæ‰€æœ‰ codemodsï¼Œä½ è¿˜å¯ä»¥é€‰æ‹©ä¸æ‰§è¡ŒæŸäº›ä¸æƒ³è¿è¡Œçš„ï¼›æ¯ä¸ª codemod ä¹Ÿåœ¨ä¸‹æ–‡åˆ—å‡ºï¼Œå¹¶å¯å•ç‹¬è¿è¡Œã€‚

### æ–°çš„ç›®å½•ç»“æ„

ğŸš¦ **å½±å“ç­‰çº§**ï¼šé‡å¤§

Nuxt é»˜è®¤é‡‡ç”¨æ–°çš„ç›®å½•ç»“æ„ï¼Œä½†ä¿æŒå‘åå…¼å®¹ï¼ˆå¦‚æœ Nuxt æ£€æµ‹åˆ°ä½ ä½¿ç”¨çš„æ˜¯æ—§ç»“æ„ï¼Œæ¯”å¦‚é¡¶çº§çš„ `pages/` ç›®å½•ï¼Œåˆ™ä¸ä¼šåº”ç”¨è¿™ä¸ªæ–°ç»“æ„ï¼‰ã€‚

ğŸ‘‰ [æŸ¥çœ‹å®Œæ•´çš„ RFC](https://github.com/nuxt/nuxt/issues/26444)

#### å˜åŒ–å†…å®¹

* æ–°çš„ Nuxt é»˜è®¤ `srcDir` ç°åœ¨æ˜¯ `app/`ï¼Œå¤§éƒ¨åˆ†å†…å®¹éƒ½ä»è¿™é‡Œè§£æã€‚
* `serverDir` é»˜è®¤ä» `<rootDir>/server` è€Œé `<srcDir>/server`
* `layers/`ã€`modules/` å’Œ `public/` ç›®å½•é»˜è®¤ç›¸å¯¹äº `<rootDir>` è§£æ
* å¦‚æœä½¿ç”¨ [Nuxt Content v2.13+](https://github.com/nuxt/content/pull/2649)ï¼Œ`content/` ç›¸å¯¹äº `<rootDir>` è§£æ
* æ–°å¢ `dir.app`ï¼Œè¿™æ˜¯å¯»æ‰¾ `router.options.ts` å’Œ `spa-loading-template.html` çš„ç›®å½•ï¼Œé»˜è®¤æ˜¯ `<srcDir>/`

<details>

<summary>ç¤ºä¾‹ v4 æ–‡ä»¶å¤¹ç»“æ„</summary>

```sh
.output/
.nuxt/
app/
  assets/
  components/
  composables/
  layouts/
  middleware/
  pages/
  plugins/
  utils/
  app.config.ts
  app.vue
  router.options.ts
content/
layers/
modules/
node_modules/
public/
server/
  api/
  middleware/
  plugins/
  routes/
  utils/
nuxt.config.ts
```

</details>

ğŸ‘‰ è¯¦æƒ…å¯è§ [å®ç°æ­¤å˜æ›´çš„ PR](https://github.com/nuxt/nuxt/pull/27029)ã€‚

#### å˜æ›´åŸå› 

1. **æ€§èƒ½** - æŠŠä»£ç å…¨éƒ¨æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¼šå¯¼è‡´ `.git/` å’Œ `node_modules/` æ–‡ä»¶å¤¹è¢«æ–‡ä»¶ç³»ç»Ÿç›‘å¬å™¨æ‰«æ/åŒ…å«ï¼Œè¿™å¯èƒ½åœ¨é macOS ç³»ç»Ÿä¸Šæ˜¾è‘—å»¶é•¿å¯åŠ¨æ—¶é—´ã€‚
2. **IDE ç±»å‹å®‰å…¨** - `server/` ç›®å½•ä¸åº”ç”¨å…¶ä½™éƒ¨åˆ†è¿è¡Œåœ¨ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ç¯å¢ƒä¸­ï¼Œæ‹¥æœ‰ä¸åŒçš„å…¨å±€å¯¼å…¥ã€‚ç¡®ä¿ `server/` ä¸åœ¨åº”ç”¨ç¨‹åºå…¶ä½™éƒ¨åˆ†çš„ç›¸åŒç›®å½•ä¸­æ˜¯å®ç° IDE è‰¯å¥½è‡ªåŠ¨è¡¥å…¨çš„ç¬¬ä¸€å¤§æ­¥ã€‚

:video-accordion{title="Vue School è§†é¢‘ä»‹ç»æ–°çš„ç›®å½•ç»“æ„" videoId="1031028378" platform="vimeo"}

#### è¿ç§»æ­¥éª¤

1. åˆ›å»ºä¸€ä¸ªåä¸º `app/` çš„æ–°ç›®å½•ã€‚
2. å°†ä½ çš„ `assets/`ã€`components/`ã€`composables/`ã€`layouts/`ã€`middleware/`ã€`pages/`ã€`plugins/` å’Œ `utils/` æ–‡ä»¶å¤¹ç§»åˆ°å…¶ä¸­ï¼Œä»¥åŠ `app.vue`ã€`error.vue`ã€`app.config.ts`ã€‚å¦‚æœä½ å·²æœ‰ `app/router-options.ts` æˆ– `app/spa-loading-template.html`ï¼Œè·¯å¾„ä¿æŒä¸å˜ã€‚
3. ç¡®ä¿ `nuxt.config.ts`ã€`content/`ã€`layers/`ã€`modules/`ã€`public/` å’Œ `server/` æ–‡ä»¶å¤¹ç•™åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼ˆ`app/` å¤–ï¼‰ã€‚
4. è®°å¾—æ›´æ–°ä»»ä½•ç¬¬ä¸‰æ–¹é…ç½®æ–‡ä»¶ä»¥é€‚åº”æ–°çš„ç›®å½•ç»“æ„ï¼Œæ¯”å¦‚ä½ çš„ `tailwindcss` æˆ– `eslint` é…ç½®ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼Œ`@nuxtjs/tailwindcss` ä¼šè‡ªåŠ¨é…ç½®æ­£ç¡®çš„ `tailwindcss`ï¼‰ã€‚

::tip
ä½ å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/file-structure` æ¥è‡ªåŠ¨åŒ–æ­¤è¿ç§»ã€‚
::

ç„¶è€Œï¼Œè¿ç§» _éå¿…éœ€_ã€‚å¦‚æœæƒ³ç»§ç»­ä½¿ç”¨å½“å‰çš„æ–‡ä»¶å¤¹ç»“æ„ï¼ŒNuxt ä¼šè‡ªåŠ¨æ£€æµ‹ã€‚å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ï¼Œè¯·æäº¤ issueã€‚å”¯ä¸€çš„ä¾‹å¤–æ˜¯å¦‚æœä½ å·²ç»è‡ªå®šä¹‰äº† `srcDir`ã€‚æ­¤æ—¶ï¼Œä½ éœ€è¦çŸ¥é“ `modules/`ã€`public/` å’Œ `server/` æ–‡ä»¶å¤¹ä¼šä»ä½ çš„ `rootDir` è§£æï¼Œè€Œä¸æ˜¯ä»è‡ªå®šä¹‰çš„ `srcDir`ã€‚å¦‚æœ‰éœ€è¦ï¼Œä½ å¯é€šè¿‡é…ç½® `dir.modules`ã€`dir.public` å’Œ `serverDir` æ¥è¦†ç›–ã€‚

ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®å¼ºåˆ¶ä½¿ç”¨ v3 æ–‡ä»¶å¤¹ç»“æ„ï¼š

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  // å°†æ–°çš„ srcDir é»˜è®¤å€¼ä» `app` æ”¹å›æ ¹ç›®å½•
  srcDir: '.',
  // æŒ‡å®š `app/router.options.ts` å’Œ `app/spa-loading-template.html` çš„ç›®å½•å‰ç¼€
  dir: {
    app: 'app'
  }
})
```

### å•ä¾‹æ•°æ®è·å–å±‚

ğŸš¦ **å½±å“ç­‰çº§**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

Nuxt çš„æ•°æ®è·å–ç³»ç»Ÿ (`useAsyncData` å’Œ `useFetch`) å·²ç»è¢«å¤§å¹…é‡æ„ï¼Œä»¥æå‡æ€§èƒ½å’Œä¸€è‡´æ€§ï¼š

1. **ç›¸åŒ key å…±äº« refs**ï¼šæ‰€æœ‰è°ƒç”¨ `useAsyncData` æˆ– `useFetch` å¹¶ä½¿ç”¨ç›¸åŒ key çš„è°ƒç”¨éƒ½ä¼šå…±äº«åŒä¸€ä»½ `data`ã€`error` å’Œ `status` refsã€‚è¿™æ„å‘³ç€æ‰€æœ‰å¸¦æ˜¾å¼ key çš„è°ƒç”¨çš„é€‰é¡¹ `deep`ã€`transform`ã€`pick`ã€`getCachedData` æˆ– `default` ä¸èƒ½å†²çªã€‚

2. **å¯¹ `getCachedData` æ›´å¤šæ§åˆ¶**ï¼šç°åœ¨æ— è®ºæ•°æ®æ˜¯å¦æ¥è‡ª watcher è¿˜æ˜¯é€šè¿‡è°ƒç”¨ `refreshNuxtData`ï¼Œæ¯æ¬¡è¯·æ±‚æ•°æ®æ—¶éƒ½ä¼šè°ƒç”¨ `getCachedData`ã€‚ä¹‹å‰è¿™äº›åœºæ™¯ä¸‹ä¼šå¼ºåˆ¶é‡æ–°è·å–æ•°æ®è€Œä¸è°ƒç”¨è¯¥å‡½æ•°ã€‚ä¸ºäº†æ›´çµæ´»åœ°æ§åˆ¶ä½•æ—¶ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œå‡½æ•°æ¥æ”¶çš„ä¸Šä¸‹æ–‡å‚æ•°ä¸­åŒ…å«äº†è¯·æ±‚æ¥æºã€‚

3. **æ”¯æŒå“åº”å¼ key**ï¼šç°åœ¨å¯ä½¿ç”¨è®¡ç®—çš„ refsã€æ™®é€š refs æˆ– getter å‡½æ•°ä½œä¸º keyï¼Œä»è€Œæ”¯æŒè‡ªåŠ¨æ•°æ®åˆ·æ–°ï¼ˆå¹¶åˆ†å¼€å­˜å‚¨æ•°æ®ï¼‰ã€‚

4. **æ•°æ®æ¸…ç†**ï¼šå½“æœ€åä¸€ä¸ªä½¿ç”¨äº†æŸæ¡ `useAsyncData` è·å–æ•°æ®çš„ç»„ä»¶å¸è½½æ—¶ï¼ŒNuxt ä¼šç§»é™¤è¿™æ¡æ•°æ®ï¼Œé¿å…å†…å­˜æŒç»­å¢é•¿ã€‚

#### å˜æ›´åŸå› 

è¿™äº›ä¿®æ”¹æ˜¯ä¸ºäº†æ”¹å–„å†…å­˜ä½¿ç”¨æ•ˆç‡å’Œæå‡å¤šä¸ªè°ƒç”¨ä¹‹é—´åŠ è½½çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚

#### è¿ç§»æ­¥éª¤

1. **æ£€æŸ¥ä¸ä¸€è‡´çš„é€‰é¡¹**ï¼šå®¡æŸ¥ä»»ä½•å¯¹ç›¸åŒ key ä½¿ç”¨ä¸ä¸€è‡´é€‰é¡¹æˆ–è·å–å‡½æ•°çš„ç»„ä»¶ã€‚

   ```ts
   // è¿™å°†è§¦å‘è­¦å‘Š
   const { data: users1 } = useAsyncData('users', () => $fetch('/api/users'), { deep: false })
   const { data: users2 } = useAsyncData('users', () => $fetch('/api/users'), { deep: true })
   ```

   å»ºè®®å°†å¯¹åŒä¸€æ˜ç¡® key çš„è°ƒç”¨ï¼ˆåŒæ—¶å«è‡ªå®šä¹‰é€‰é¡¹ï¼‰æå–åˆ°ç‹¬ç«‹çš„ç»„åˆå‡½æ•°ä¸­ï¼š

   ```ts [composables/useUserData.ts]
   export function useUserData(userId: string) {
     return useAsyncData(
       `user-${userId}`,
       () => fetchUser(userId),
       { 
         deep: true,
         transform: (user) => ({ ...user, lastAccessed: new Date() })
       }
     )
   }
   ```

2. **æ›´æ–° `getCachedData` çš„å®ç°**ï¼š

   ```diff
   useAsyncData('key', fetchFunction, {
   -  getCachedData: (key, nuxtApp) => {
   -    return cachedData[key]
   -  }
   +  getCachedData: (key, nuxtApp, ctx) => {
   +    // ctx.cause - å¯èƒ½æ˜¯ 'initial' | 'refresh:hook' | 'refresh:manual' | 'watch'
   +    
   +    // ä¾‹å­ï¼šæ‰‹åŠ¨åˆ·æ–°æ—¶ä¸ä½¿ç”¨ç¼“å­˜
   +    if (ctx.cause === 'refresh:manual') return undefined
   +    
   +    return cachedData[key]
   +  }
   })
   ```

ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®å…³é—­è¯¥è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    granularCachedData: false,
    purgeCachedData: false
  }
})
```

### è·¯ç”±å…ƒæ•°æ®å»é‡

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

#### å˜åŒ–å†…å®¹

å¯ä»¥é€šè¿‡ `definePageMeta` è®¾ç½®éƒ¨åˆ†è·¯ç”±å…ƒæ•°æ®ï¼Œä¾‹å¦‚ `name`ã€`path` ç­‰ã€‚ä»¥å‰è¿™äº›ä¿¡æ¯æ—¢å­˜åœ¨äºè·¯ç”±å¯¹è±¡ä¸Šï¼Œä¹Ÿå­˜åœ¨äºè·¯ç”±å…ƒæ•°æ®ä¸­ï¼ˆä¾‹å¦‚ï¼Œ`route.name` ä¸ `route.meta.name`ï¼‰ã€‚

ç°åœ¨ï¼Œè¿™äº›å±æ€§ä»…å¯é€šè¿‡è·¯ç”±å¯¹è±¡è®¿é—®ã€‚

#### å˜æ›´åŸå› 

è¿™æ˜¯å› ä¸ºé»˜è®¤å¯ç”¨äº† `experimental.scanPageMeta`ï¼Œæ˜¯æ€§èƒ½ä¼˜åŒ–æªæ–½ã€‚

#### è¿ç§»æ­¥éª¤

è¿ç§»æ¯”è¾ƒç®€å•ï¼š

```diff
  const route = useRoute()
  
- console.log(route.meta.name)
+ console.log(route.name)
```

### ç»„ä»¶åç§°è§„èŒƒåŒ–

ğŸš¦ **å½±å“ç­‰çº§**ï¼šä¸­ç­‰

Vue ç°åœ¨ä¼šç”Ÿæˆç¬¦åˆ Nuxt ç»„ä»¶å‘½åè§„èŒƒçš„ç»„ä»¶åç§°ã€‚

#### å˜åŒ–å†…å®¹

å¦‚æœä½ æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®ç»„ä»¶åç§°ï¼ŒVue é»˜è®¤ä¼šå°†ç»„ä»¶åç§°è®¾ä¸ºç»„ä»¶çš„æ–‡ä»¶åã€‚

```bash [ç›®å½•ç»“æ„]
â”œâ”€ components/
â”œâ”€â”€â”€ SomeFolder/
â”œâ”€â”€â”€â”€â”€ MyComponent.vue
```

åœ¨ Vue ä¸­ï¼Œè¯¥ç»„ä»¶åç§°ä¸º `MyComponent`ã€‚ä½ å¦‚æœæƒ³åœ¨ `<KeepAlive>` ä¸­ä½¿ç”¨ï¼Œæˆ–è€…åœ¨ Vue DevTools ä¸­è¯†åˆ«å®ƒï¼Œå°±ä¼šç”¨è¿™ä¸ªåç§°ã€‚

ä½†ä¸ºäº†è‡ªåŠ¨å¯¼å…¥ï¼Œä½ å¿…é¡»ä½¿ç”¨ `SomeFolderMyComponent`ã€‚

ç°åœ¨è¿™ä¸¤ä¸ªåç§°å°†ä¼šç»Ÿä¸€ï¼ŒVue ä¼šç”Ÿæˆä¸ Nuxt ç»„ä»¶å‘½åæ¨¡å¼åŒ¹é…çš„ç»„ä»¶åç§°ã€‚

#### è¿ç§»æ­¥éª¤

è¯·ç¡®ä¿åœ¨æ‰€æœ‰ä½¿ç”¨ `@vue/test-utils` ä¸­çš„ `findComponent` çš„æµ‹è¯•ä»¥åŠæ‰€æœ‰ä¾èµ–ç»„ä»¶åç§°çš„ `<KeepAlive>` æ ‡ç­¾ä¸­ï¼Œä½¿ç”¨äº†æ›´æ–°åçš„åç§°ã€‚

ä½ ä¹Ÿå¯ä»¥æš‚æ—¶é€šè¿‡ä»¥ä¸‹é…ç½®å…³é—­è¯¥è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    normalizeComponentNames: false
  }
})
```

### Unhead v2

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

#### å˜åŒ–å†…å®¹

ç”¨äºç”Ÿæˆ `<head>` æ ‡ç­¾çš„ [Unhead](https://unhead.unjs.io/) æ›´æ–°è‡³ç‰ˆæœ¬ 2ã€‚è™½ç„¶å¤§å¤šæ•°å…¼å®¹ï¼Œä½†åº•å±‚ API æœ‰è‹¥å¹²ç ´åæ€§å˜æ›´ï¼š

* ç§»é™¤äº†å±æ€§ï¼š`vmid`ã€`hid`ã€`children`ã€`body`ã€‚
* ä¸å†æ”¯æŒ Promise ç±»å‹è¾“å…¥ã€‚
* æ ‡ç­¾æ’åºé»˜è®¤ä½¿ç”¨ Capo.jsã€‚

#### è¿ç§»æ­¥éª¤

ä¸Šè¿°å˜æ›´å¯¹ä½ çš„åº”ç”¨å½±å“è¾ƒå°ã€‚

ç¡®ä¿ä½ æ²¡æœ‰ä½¿ç”¨å·²ç§»é™¤çš„å±æ€§ã€‚

```diff
useHead({
  meta: [{ 
    name: 'description', 
    // meta æ ‡ç­¾ä¸å†éœ€è¦ vmid æˆ– key    
-   vmid: 'description' 
-   hid: 'description'
  }]
})
```

å¦‚æœä½¿ç”¨äº† [æ¨¡æ¿å‚æ•°](https://unhead.unjs.io/docs/head/guides/plugins/template-params) æˆ– [åˆ«åæ’åº](https://unhead.unjs.io/docs/head/guides/plugins/alias-sorting)ï¼Œç°åœ¨éœ€è¦æ˜¾å¼å¯ç”¨ï¼š

```ts
import { TemplateParamsPlugin, AliasSortingPlugin } from '@unhead/vue/plugins'

export default defineNuxtPlugin({
  setup() {
    const unhead = injectHead()
    unhead.use(TemplateParamsPlugin)
    unhead.use(AliasSortingPlugin)
  }
})
```

è™½éå¿…é¡»ï¼Œæ¨èå°† `@unhead/vue` çš„å¼•å…¥æ”¹ä¸º `#imports` æˆ– `nuxt/app`ã€‚

```diff
-import { useHead } from '@unhead/vue'
+import { useHead } from '#imports'
```

å¦‚æœä»æœ‰é—®é¢˜ï¼Œå¯é€šè¿‡å¼€å¯æ—§ç‰ˆæ¨¡å¼æ¢å¤ v1 è¡Œä¸ºï¼š

```ts
export default defineNuxtConfig({
  unhead: {
    legacy: true,
  }
})
```

### SPA åŠ è½½å±å¹•çš„æ–° DOM ä½ç½®

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

#### å˜åŒ–å†…å®¹

åœ¨æ¸²æŸ“ä»…å®¢æˆ·ç«¯é¡µé¢ï¼ˆ`ssr: false`ï¼‰æ—¶ï¼ŒNuxt ä¼šåœ¨ Nuxt åº”ç”¨æ ¹èŠ‚ç‚¹å†…æ¸²æŸ“åŠ è½½å±å¹•ï¼ˆå–è‡ª `app/spa-loading-template.html`ï¼‰ï¼š

```html
<div id="__nuxt">
  <!-- spa loading template -->
</div>
```

ç°åœ¨ï¼Œé»˜è®¤å°†åŠ è½½æ¨¡æ¿æ¸²æŸ“åœ¨ Nuxt åº”ç”¨æ ¹èŠ‚ç‚¹æ—è¾¹ï¼š

```html
<div id="__nuxt"></div>
<!-- spa loading template -->
```

#### å˜æ›´åŸå› 

è¿™æ ·åšå¯ç¡®ä¿åŠ è½½æ¨¡æ¿ä¿ç•™åœ¨ DOM ä¸­ï¼Œç›´åˆ° Vue åº”ç”¨çš„ Suspense è§£æå®Œæˆï¼Œé¿å…ç™½å±é—ªçƒã€‚

#### è¿ç§»æ­¥éª¤

å¦‚æœä½ ä½¿ç”¨ CSS æˆ– `document.querySelector` é€‰ä¸­åŠ è½½æ¨¡æ¿ï¼Œéœ€è¦æ›´æ–°é€‰æ‹©å™¨ã€‚ä½ å¯ä»¥ä½¿ç”¨æ–°çš„ `app.spaLoaderTag` å’Œ `app.spaLoaderAttrs` é…ç½®é€‰é¡¹æ¥è¾…åŠ©ã€‚

æ­¤å¤–å¯ç”¨ä»¥ä¸‹é…ç½®æ¢å¤ä¹‹å‰è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    spaLoadingTemplateLocation: 'within',
  }
})
```

### è§£æ `error.data`

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

ä¹‹å‰æŠ›å‡ºçš„é”™è¯¯å¯¹è±¡ä¸­çš„ `data` å±æ€§æœªè¢«è§£æã€‚ç°åœ¨å®ƒè¢«è§£æåå¯åœ¨ `error` å¯¹è±¡ä¸­ä½¿ç”¨ã€‚è™½ç„¶è¿™æ˜¯ä¿®æ­£ï¼Œä½†å¦‚æœä¾èµ–æ—§è¡Œä¸ºå¹¶è‡ªå·±è§£æï¼Œåˆ™å±äºç ´åæ€§å˜æ›´ã€‚

#### è¿ç§»æ­¥éª¤

æ›´æ–°è‡ªå®šä¹‰çš„ `error.vue` ï¼Œç§»é™¤å¯¹ `error.data` çš„é¢å¤–è§£æï¼š

```diff
  <script setup lang="ts">
  import type { NuxtError } from '#app'

  const props = defineProps({
    error: Object as () => NuxtError
  })

- const data = JSON.parse(error.data)
+ const data = error.data
  </script>
```

ä½ ä¹Ÿå¯ä»¥é€šè¿‡å…³é—­è¯¥å®éªŒç‰¹æ€§ï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    parseErrorData: false
  },
})
```

### æ›´ç²¾ç»†çš„å†…è”æ ·å¼

ğŸš¦ **å½±å“ç­‰çº§**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

Nuxt ç°åœ¨åªå¯¹ Vue ç»„ä»¶å†…è”æ ·å¼ï¼Œè€Œéæ‰€æœ‰å…¨å±€ CSSã€‚

ä»¥å‰ï¼ŒNuxt ä¼šå°†å…¨éƒ¨ CSSï¼ˆåŒ…æ‹¬å…¨å±€æ ·å¼ï¼‰å†…è”ï¼Œå¹¶ç§»é™¤ `<link>` å¤–é“¾ï¼›ç°åœ¨ä»…å¯¹ Vue ç»„ä»¶å†…è” CSSï¼ˆè¿™äº›ç»„ä»¶ä¹‹å‰ä¼šæ‹†åˆ†ç‹¬ç«‹ CSS chunkï¼‰ã€‚è¿™åœ¨å‡å°‘ç½‘ç»œè¯·æ±‚ï¼ˆé¦–å±ä¸è¯·æ±‚å•ç‹¬ `.css` æ–‡ä»¶ï¼‰çš„åŒæ—¶ï¼Œæ”¯æŒç¼“å­˜å•ä¸€å…¨å±€ CSS æ–‡ä»¶ï¼Œå‡å°åˆå§‹æ–‡æ¡£å¤§å°ã€‚

#### è¿ç§»æ­¥éª¤

æ­¤ç‰¹æ€§å¯é…ç½®ï¼Œä½ å¯ä»¥é€šè¿‡è®¾ç½® `inlineStyles: true` æ¢å¤ä¹‹å‰çš„å…¨å±€æ ·å¼å†…è”è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  features: {
    inlineStyles: true
  }
})
```

### å»¶åæ‰«æé¡µé¢å…ƒæ•°æ®

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

#### å˜åŒ–å†…å®¹

ç°åœ¨æ‰«æé¡µé¢å…ƒæ•°æ®ï¼ˆç”± `definePageMeta` å®šä¹‰ï¼‰æ˜¯åœ¨è°ƒç”¨ `pages:extend` é’©å­åè¿›è¡Œï¼Œè€Œéä¹‹å‰çš„é’©å­ä¹‹å‰ã€‚

#### å˜æ›´åŸå› 

è¿™æ ·å¯æ‰«æç”¨æˆ·åœ¨ `pages:extend` ä¸­æ–°å¢çš„é¡µé¢å…ƒæ•°æ®ã€‚æˆ‘ä»¬è¿˜å¢åŠ äº†ä¸€ä¸ªæ–°çš„é’©å­ `pages:resolved`ï¼Œä¾›ä½ ä¿®æ”¹æˆ–è¦†ç›–å…ƒæ•°æ®ã€‚

#### è¿ç§»æ­¥éª¤

å¦‚æœä½ æƒ³è¦†ç›–é¡µé¢å…ƒæ•°æ®ï¼Œåº”åœ¨ `pages:resolved` é’©å­ä¸­å®Œæˆï¼Œè€Œé `pages:extend`ã€‚

```diff
  export default defineNuxtConfig({
    hooks: {
-     'pages:extend'(pages) {
+     'pages:resolved'(pages) {
        const myPage = pages.find(page => page.path === '/')
        myPage.meta ||= {}
        myPage.meta.layout = 'overridden-layout'
      }
    }
  })
```

ä½ ä¹Ÿå¯ä»¥ç”¨ä»¥ä¸‹é…ç½®æ¢å¤ä¹‹å‰è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    scanPageMeta: true
  }
})
```

### å…±äº«é¢„æ¸²æŸ“æ•°æ®

ğŸš¦ **å½±å“ç­‰çº§**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

å¯ç”¨äº†ä¹‹å‰çš„å®éªŒç‰¹æ€§ï¼šåœ¨ä¸åŒé¡µé¢é—´å…±äº« `useAsyncData` å’Œ `useFetch` è°ƒç”¨çš„æ•°æ®ã€‚è¯¦æƒ…è§[åŸå§‹ PR](https://github.com/nuxt/nuxt/pull/24894)ã€‚

#### å˜æ›´åŸå› 

æ­¤ç‰¹æ€§å…è®¸é¢„æ¸²æŸ“æ—¶åœ¨é¡µé¢é—´å…±äº« payload æ•°æ®ï¼Œæ˜¾è‘—æå‡é‡å¤è¯·æ±‚ç›¸åŒæ•°æ®çš„ç«™ç‚¹æ€§èƒ½ï¼Œæ¯”å¦‚æ¯ä¸ªé¡µé¢éƒ½éœ€è¦è°ƒç”¨ `useFetch` è·å–å¯¼èˆªæ æ•°æ®æ—¶ï¼Œé¦–æ¬¡è·å–åç¼“å­˜ç”¨äºå…¶ä»–é¡µé¢ã€‚

#### è¿ç§»æ­¥éª¤

ç¡®ä¿æ‰€æœ‰æ•°æ®å”¯ä¸€çš„ key å‡èƒ½æ˜ å°„åˆ°å¯¹åº”æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨åŠ¨æ€é¡µé¢ä¸­ï¼Œ`useAsyncData` çš„ key åº”èƒ½å”¯ä¸€æ ‡è¯†è·å–çš„æ•°æ®ï¼š

```ts [app/pages/test/[slug\\].vue]
// è¿™æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºè·¯ç”±å‚æ•° slug å½±å“æ•°æ®ï¼Œä½† key æ²¡åæ˜ è¿™ä¸€ç‚¹ã€‚
const route = useRoute()
const { data } = await useAsyncData(async () => {
  return await $fetch(`/api/my-page/${route.params.slug}`)
})
// åº”è¯¥ä½¿ç”¨èƒ½å”¯ä¸€æ ‡è¯†æ•°æ®çš„keyã€‚
const { data } = await useAsyncData(route.params.slug, async () => {
  return await $fetch(`/api/my-page/${route.params.slug}`)
})
```

ä½ ä¹Ÿå¯ä»¥å…³é—­è¯¥åŠŸèƒ½ï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    sharedPrerenderData: false
  }
})
```

### `useAsyncData` å’Œ `useFetch` ä¸­é»˜è®¤çš„ `data` å’Œ `error` å€¼

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

#### å˜åŒ–å†…å®¹

`useAsyncData` è¿”å›çš„ `data` å’Œ `error` å¯¹è±¡é»˜è®¤å€¼ç°åœ¨æ˜¯ `undefined`ã€‚

#### å˜æ›´åŸå› 

ä¹‹å‰ `data` åˆå§‹åŒ–ä¸º `null`ï¼Œä½†åœ¨ `clearNuxtData` æ—¶é‡ç½®ä¸º `undefined`ï¼Œ`error` åˆå§‹åŒ–ä¸º `null`ã€‚æ­¤å˜æ›´æ›´ä¸€è‡´ã€‚

#### è¿ç§»æ­¥éª¤

å¦‚ä½ ä¹‹å‰æ£€æŸ¥ `data.value` æˆ– `error.value` æ˜¯å¦ä¸º `null`ï¼Œè¯·æ”¹ä¸ºæ£€æŸ¥ `undefined`ã€‚

::tip
ä½ å¯ä»¥é€šè¿‡ `npx codemod@latest nuxt/4/default-data-error-value` è‡ªåŠ¨æ‰§è¡Œæ­¤æ­¥éª¤ã€‚
::

å‡ºç°é—®é¢˜å¯é€šè¿‡ä»¥ä¸‹é…ç½®æ¢å¤æ—§è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    defaults: {
      useAsyncData: {
        value: 'null',
        errorValue: 'null'
      }
    }
  }
})
```

å¦‚é‡‡ç”¨æ­¤é…ç½®è¯·åé¦ˆé—®é¢˜ï¼Œæˆ‘ä»¬è®¡åˆ’ä¸å†æ”¯æŒæ­¤é…ç½®ã€‚

### ç§»é™¤ `useAsyncData` å’Œ `useFetch` ä¸­è°ƒç”¨ `refresh` æ—¶ `dedupe` é€‰é¡¹çš„å¸ƒå°”å€¼æ”¯æŒ

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

#### å˜åŒ–å†…å®¹

ä¹‹å‰å¯ä»¥å‘ `refresh` ä¼ é€’ `dedupe: boolean`ï¼Œä¸ `cancel: true` å’Œ `defer: false` åˆ«åç›¸åŒã€‚

```ts twoslash [app.vue]
const { refresh } = await useAsyncData(async () => ({ message: 'Hello, Nuxt!' }))

async function refreshData () {
  await refresh({ dedupe: true })
}
```

#### å˜æ›´åŸå› 

ä¸ºäº†æ›´æ¸…æ™°ï¼Œç§»é™¤äº†å¸ƒå°”å€¼åˆ«åã€‚

å› ä¸º `refresh({ dedupe: false })` è¡¨ç¤º **ä¸å–æ¶ˆ** å½“å‰è¯·æ±‚ï¼›ä½† `dedupe: true` åœ¨ `useAsyncData` é€‰é¡¹ä¸­è¡¨ç¤º**å¦‚æœå·²æœ‰æœªå®Œæˆè¯·æ±‚åˆ™ä¸æ–°å»ºè¯·æ±‚**ï¼Œä¸¤è€…å«ä¹‰æ˜¯ _ç›¸å_ çš„ã€‚ï¼ˆè¯¦è§ [PR](https://github.com/nuxt/nuxt/pull/24564#pullrequestreview-1764584361)ï¼‰

#### è¿ç§»æ­¥éª¤

è¿ç§»æ¯”è¾ƒç®€å•ï¼š

```diff
  const { refresh } = await useAsyncData(async () => ({ message: 'Hello, Nuxt 3!' }))
  
  async function refreshData () {
-   await refresh({ dedupe: true })
+   await refresh({ dedupe: 'cancel' })

-   await refresh({ dedupe: false })
+   await refresh({ dedupe: 'defer' })
  }
```

::tip
ä½ å¯ä»¥é€šè¿‡ `npx codemod@latest nuxt/4/deprecated-dedupe-value` è‡ªåŠ¨æ‰§è¡Œæ­¤æ­¥éª¤ã€‚
::

### `useAsyncData` å’Œ `useFetch` æ¸…ç†æ•°æ®æ—¶éµå®ˆé»˜è®¤å€¼

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

#### å˜åŒ–å†…å®¹

ä¸º `useAsyncData` æä¾›äº†è‡ªå®šä¹‰çš„ `default` å€¼åï¼Œè°ƒç”¨ `clear` æˆ– `clearNuxtData` æ—¶ä¼šç”¨è¯¥é»˜è®¤å€¼é‡ç½®ï¼Œè€Œéç›´æ¥æ¸…ç©ºã€‚

#### å˜æ›´åŸå› 

å¾ˆå¤šç”¨æˆ·ä½¿ç”¨åˆé€‚çš„ç©ºå€¼ï¼ˆä¾‹å¦‚ç©ºæ•°ç»„ï¼‰é¿å…åœ¨è®¿é—®æ•°æ®æ—¶æ£€æŸ¥ `null` æˆ– `undefined`ï¼Œåº”è¯¥å°Šé‡å¹¶ä¿æŒè¿™ç±»é»˜è®¤å€¼ã€‚

#### è¿ç§»æ­¥éª¤

é‡é—®é¢˜æ—¶å¯ä¸´æ—¶ç”¨æ­¤é…ç½®æ¢å¤æ—§è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    resetAsyncDataToUndefined: true,
  }
})
```

æ­¤é…ç½®æœªæ¥å¯èƒ½ç§»é™¤ï¼Œä½¿ç”¨æ—¶è¯·åé¦ˆã€‚

### `useAsyncData` å’Œ `useFetch` ä¸­ `pending` å€¼å¯¹é½

ğŸš¦ **å½±å“ç­‰çº§**ï¼šä¸­ç­‰

`useAsyncData`ã€`useFetch`ã€`useLazyAsyncData` åŠ `useLazyFetch` è¿”å›çš„ `pending` ç°åœ¨æ˜¯ä¸€ä¸ªè®¡ç®—å±æ€§ï¼Œä»…å½“ `status` å¤„äº pending çŠ¶æ€æ—¶ä¸º trueã€‚

#### å˜åŒ–å†…å®¹

å½“è®¾ç½® `immediate: false` æ—¶ï¼Œ`pending` ä¼šåœ¨é¦–æ¬¡è¯·æ±‚å‘èµ·å‰ä¿æŒ falseï¼Œä¹‹å‰æ˜¯å§‹ç»ˆ trueã€‚

#### å˜æ›´åŸå› 

`pending` ç°åœ¨ä¸ `status` å±æ€§æ„ä¹‰å¯¹é½ï¼Œå‡è¡¨ç¤ºè¯·æ±‚æ­£åœ¨è¿›è¡Œã€‚

#### è¿ç§»æ­¥éª¤

ä¾èµ– `pending` çš„é€»è¾‘éœ€è€ƒè™‘æ–°è¡Œä¸ºï¼Œ`pending` åªåœ¨ `status` pending æ—¶ä¸º trueã€‚

```diff
  <template>
-   <div v-if="!pending">
+   <div v-if="status === 'success'">
      <p>Data: {{ data }}</p>
    </div>
    <div v-else>
      <p>Loading...</p>
    </div>
  </template>
  <script setup lang="ts">
  const { data, pending, execute, status } = await useAsyncData(() => fetch('/api/data'), {
    immediate: false
  })
  onMounted(() => execute())
  </script>
```

ä½ ä¹Ÿå¯ä¸´æ—¶æ¢å¤æ—§è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    pendingWhenIdle: true
  }
})
```

### `useAsyncData` å’Œ `useFetch` ä¸­ key å˜æ›´è¡Œä¸º

ğŸš¦ **å½±å“ç­‰çº§**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

ä½¿ç”¨å“åº”å¼ key æ—¶ï¼ŒNuxt åœ¨ key å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°è·å–æ•°æ®ã€‚`immediate: false` æ—¶ï¼Œ`useAsyncData` ä»…åœ¨å·²æœ‰æ•°æ®çš„æƒ…å†µä¸‹æ‰ä¼šåœ¨ key å˜æ›´æ—¶é‡æ–°è¯·æ±‚ã€‚

ä¹‹å‰ `useFetch` è¡Œä¸ºç•¥ä¸åŒï¼Œæ€»æ˜¯åœ¨ key å˜æ›´æ—¶è¯·æ±‚æ•°æ®ã€‚

ç°åœ¨ï¼Œ`useFetch` å’Œ `useAsyncData` è¡Œä¸ºç»Ÿä¸€ï¼Œä»…åœ¨å·²æœ‰æ•°æ®çš„æƒ…å†µä¸‹å“åº” key å˜åŒ–ã€‚

#### å˜æ›´åŸå› 

ç»Ÿä¸€ä¸¤è€…è¡Œä¸ºï¼Œé¿å…æ„å¤–è¯·æ±‚ã€‚è‹¥è®¾ç½® `immediate: false`ï¼Œå¿…é¡»è°ƒç”¨ `refresh` æˆ– `execute` æ‰èƒ½æ‹‰å–æ•°æ®ã€‚

#### è¿ç§»æ­¥éª¤

æ–°è¡Œä¸ºé€šå¸¸æ˜¯æå‡ä½“éªŒï¼Œä½†è‹¥ä¹‹å‰ä¾èµ– `useFetch` åœ¨ key å˜åŒ–æ—¶è‡ªåŠ¨è¯·æ±‚ï¼Œé¦–æ¬¡éœ€æ‰‹åŠ¨è§¦å‘ï¼š

```diff
  const id = ref('123')
  const { data, execute } = await useFetch('/api/test', {
    query: { id },
    immediate: false
  )
+ watch(id, execute, { once: true })
```

å¯å…¨å±€ç¦ç”¨è¯¥è¡Œä¸ºï¼š

```ts
// æˆ–åœ¨ Nuxt é…ç½®ä¸­
export default defineNuxtConfig({
  experimental: {
    alwaysRunFetchOnKeyChange: true
  }
})
```

### `useAsyncData` å’Œ `useFetch` ä¸­çš„æ•°æ®æµ…å±‚å“åº”æ€§

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

`useAsyncData`ã€`useFetch`ã€`useLazyAsyncData` åŠ `useLazyFetch` è¿”å›çš„ `data` ç°åœ¨æ˜¯ `shallowRef` è€Œé `ref`ã€‚

#### å˜åŒ–å†…å®¹

æ–°æ•°æ®åˆ°è¾¾æ—¶ï¼Œæ›¿æ¢ `data` å¯¹è±¡ä¼šè§¦å‘å“åº”ã€‚ä½†ä¿®æ”¹ `data` å†…éƒ¨å±æ€§ä¸å†è§¦å‘å“åº”ã€‚

#### å˜æ›´åŸå› 

æå¤§æå‡æ·±å±‚åµŒå¥—å¯¹è±¡å’Œæ•°ç»„çš„æ€§èƒ½ï¼Œå› ä¸º Vue ä¸å†ç›‘å¬æ¯ä¸ªå±æ€§çš„å˜åŒ–ã€‚å¤§å¤šæ•°åœºæ™¯æ•°æ®åº”ä¿æŒä¸å¯å˜ã€‚

#### è¿ç§»æ­¥éª¤

å¤šæ•°æƒ…å†µæ— éœ€å˜åŠ¨ï¼Œè‹¥ä¾èµ–æ·±å±‚å“åº”ï¼Œå¯é€‰ï¼š

1. é’ˆå¯¹ç‰¹å®šç»„åˆå‡½æ•°å¯ç”¨æ·±å±‚å“åº”ï¼š

   ```diff
   - const { data } = useFetch('/api/test')
   + const { data } = useFetch('/api/test', { deep: true })
   ```
2. å…¨å±€é»˜è®¤å¼€å¯ï¼ˆä¸æ¨èï¼‰ï¼š

   ```ts twoslash [nuxt.config.ts]
   export default defineNuxtConfig({
     experimental: {
       defaults: {
         useAsyncData: {
           deep: true
         }
       }
     }
   })
   ```

::tip
å¯é€šè¿‡ `npx codemod@latest nuxt/4/shallow-function-reactivity` è‡ªåŠ¨æ‰§è¡Œæ­¤æ­¥éª¤ã€‚
::

### `builder:watch` ä¸­çš„ç»å¯¹è·¯å¾„ç›‘å¬

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

#### å˜åŒ–å†…å®¹

`builder:watch` é’©å­ç°åœ¨å‘å‡ºçš„è·¯å¾„ä¸ºç»å¯¹è·¯å¾„ï¼ˆè€Œéç›¸å¯¹äº `srcDir` çš„ç›¸å¯¹è·¯å¾„ï¼‰ã€‚

#### å˜æ›´åŸå› 

æ”¯æŒç›‘å¬ `srcDir` ä»¥å¤–çš„è·¯å¾„ï¼Œæ›´å¥½æ”¯æŒå±‚ï¼ˆlayersï¼‰åŠå¤æ‚åœºæ™¯ã€‚

#### è¿ç§»æ­¥éª¤

æˆ‘ä»¬å·²ä¸»åŠ¨è¿ç§»çŸ¥æ™“çš„å…¬å…± Nuxt æ¨¡å—ï¼Œ[è¯¦è§ issue #25339](https://github.com/nuxt/nuxt/issues/25339)ã€‚

ä½œä¸ºæ¨¡å—ä½œè€…ï¼Œæƒ³ä¿æŒå…¼å®¹å¯æŒ‰ä»¥ä¸‹æ–¹å¼ä¿è¯ï¼š

```diff
+ import { relative, resolve } from 'node:fs'
  // ...
  nuxt.hook('builder:watch', async (event, path) => {
+   path = relative(nuxt.options.srcDir, resolve(nuxt.options.srcDir, path))
    // ...
  })
```

::tip
ä½ å¯ä»¥è‡ªåŠ¨æ‰§è¡Œæ­¤è¿ç§»ï¼š`npx codemod@latest nuxt/4/absolute-watch-path`
::

### ç§»é™¤ `window.__NUXT__` å¯¹è±¡

#### å˜åŒ–å†…å®¹

åº”ç”¨å®Œæˆ hydration åå…¨å±€å¯¹è±¡ `window.__NUXT__` è¢«ç§»é™¤ã€‚

#### å˜æ›´åŸå› 

ä¸ºå¤šåº”ç”¨æ¨¡å¼é“ºè·¯ï¼ˆ[#21635](https://github.com/nuxt/nuxt/issues/21635)ï¼‰ï¼Œå¹¶èšç„¦é€šè¿‡å•ä¸€æ–¹å¼è®¿é—® Nuxt åº”ç”¨æ•°æ® â€”â€” `useNuxtApp()`ã€‚

#### è¿ç§»æ­¥éª¤

æ•°æ®ä¾æ—§å¯ç”¨ï¼Œåªéœ€æ”¹ä¸ºè®¿é—®ï¼š

```diff
- console.log(window.__NUXT__)
+ console.log(useNuxtApp().payload)
```

### ç›®å½•ç´¢å¼•æ‰«ææ”¹è¿›

ğŸš¦ **å½±å“ç­‰çº§**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

`middleware/` ç›®å½•ä¸‹çš„å­æ–‡ä»¶å¤¹åŒæ ·æ‰«æ `index` æ–‡ä»¶ï¼Œå¹¶å°†å…¶æ³¨å†Œä¸ºä¸­é—´ä»¶ã€‚

#### å˜æ›´åŸå› 

ä¸ºä½¿ `middleware/` å’Œ `plugins/` ç›®å½•çš„è¡Œä¸ºä¸€è‡´ï¼Œåè€…å­æ–‡ä»¶å¤¹å·²æœ‰ç±»ä¼¼è¡Œä¸ºã€‚

#### è¿ç§»æ­¥éª¤

ä¸€èˆ¬ä¸éœ€è¦è¿ç§»ï¼Œè‹¥æƒ³æ¢å¤æ—§è¡Œä¸ºï¼Œå¯ä½¿ç”¨é’©å­è¿‡æ»¤æ‰ `index` ä¸­é—´ä»¶ï¼š

```ts
export default defineNuxtConfig({
  hooks: {
    'app:resolve'(app) {
      app.middleware = app.middleware.filter(mw => !/\/index\.[^/]+$/.test(mw.path))
    }
  }
})
```

### æ¨¡æ¿ç¼–è¯‘å˜æ›´

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

#### å˜åŒ–å†…å®¹

ä»¥å‰ Nuxt ä½¿ç”¨ `lodash/template` æ¥ç¼–è¯‘åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„æ¨¡æ¿ï¼ˆ`.ejs` è¯­æ³•ï¼‰ã€‚

åŒæ—¶æä¾›äº†ä¸€äº›æ¨¡æ¿å·¥å…·å‡½æ•°ï¼ˆ`serialize`ã€`importName`ã€`importSources`ï¼‰ï¼Œç°åœ¨ç§»é™¤è¿™äº›å†…å®¹ã€‚

#### å˜æ›´åŸå› 

Nuxt v3 å¼•å…¥äº†æ”¯æŒ `getContents()` çš„â€œè™šæ‹Ÿâ€è¯­æ³•ï¼Œæ›´çµæ´»ä¸”é«˜æ•ˆã€‚

`lodash/template` å­˜åœ¨å¤šä¸ªå®‰å…¨é—®é¢˜ï¼Œè™½ç„¶åœ¨æ„å»ºæ—¶è°ƒç”¨ã€ç”±å¯ä¿¡ä»£ç ä½¿ç”¨ï¼Œä½†ä»å¼•å‘å®‰å…¨å®¡è®¡ã€‚lodash æ˜¯è¾ƒå¤§ä¾èµ–ï¼Œè®¸å¤šé¡¹ç›®ä¸ä½¿ç”¨ã€‚

ç”± Nuxt å†…ç½®æä¾›ä»£ç åºåˆ—åŒ–ä¹Ÿä¸ç†æƒ³ã€‚æˆ‘ä»¬æä¾›äº†è¯¸å¦‚ [unjs/knitwork](http://github.com/unjs/knitwork) è¿™æ ·çš„é¡¹ç›®ï¼Œå¯ä½œä¸ºé¡¹ç›®ä¾èµ–ï¼Œä¾¿äºç‹¬ç«‹ä¿®å¤å®‰å…¨é—®é¢˜ã€‚

#### è¿ç§»æ­¥éª¤

æˆ‘ä»¬å·²æäº¤ PR æ›´æ–°ä½¿ç”¨ EJS è¯­æ³•çš„æ¨¡å—ï¼Œä½ ä¹Ÿå¯é€‰æ‹©ä»¥ä¸‹ä¸‰ç§å…¼å®¹æ–¹æ¡ˆï¼š

* å°†å­—ç¬¦ä¸²æ’å€¼é€»è¾‘è½¬å…¥ `getContents()`ã€‚
* ä½¿ç”¨è‡ªå®šä¹‰æ›¿æ¢å‡½æ•°ï¼Œå¦‚ https://github.com/nuxt-modules/color-mode/pull/240ã€‚
* ä½¿ç”¨ `es-toolkit/compat`ï¼ˆlodash template çš„æ— ç¼æ›¿ä»£ï¼‰ï¼Œä½œä¸ºä½ é¡¹ç›®ä¾èµ–è€Œé Nuxt ä¾èµ–ï¼š

```diff
+ import { readFileSync } from 'node:fs'
+ import { template } from 'es-toolkit/compat'
  // ...
  addTemplate({
    fileName: 'appinsights-vue.js'
    options: { /* some options */ },
-   src: resolver.resolve('./runtime/plugin.ejs'),
+   getContents({ options }) {
+     const contents = readFileSync(resolver.resolve('./runtime/plugin.ejs'), 'utf-8')
+     return template(contents)({ options })
+   },
  })
```

è‹¥ä½ ä½¿ç”¨äº†æ¨¡æ¿å·¥å…·å‡½æ•°ï¼ˆ`serialize`ã€`importName`ã€`importSources`ï¼‰ï¼Œå¯æ”¹ç”¨ `knitwork` å‡½æ•°ï¼š

```ts
import { genDynamicImport, genImport, genSafeVariableName } from 'knitwork'

const serialize = (data: any) => JSON.stringify(data, null, 2).replace(/"{(.+)}"(?=,?$)/gm, r => JSON.parse(r).replace(/^{(.*)}$/, '$1'))

const importSources = (sources: string | string[], { lazy = false } = {}) => {
  return toArray(sources).map((src) => {
    if (lazy) {
      return `const ${genSafeVariableName(src)} = ${genDynamicImport(src, { comment: \`webpackChunkName: \${JSON.stringify(src)}\` })}`
    }
    return genImport(src, genSafeVariableName(src))
  }).join('\n')
}

const importName = genSafeVariableName
```

::tip
ä½ å¯ä»¥é€šè¿‡ `npx codemod@latest nuxt/4/template-compilation-changes` è‡ªåŠ¨æ‰§è¡Œè¯¥è¿ç§»ã€‚
::

### ç§»é™¤å®éªŒæ€§ç‰¹æ€§çš„é…ç½®é¡¹

ğŸš¦ **å½±å“ç­‰çº§**ï¼šæœ€ä½

#### å˜åŒ–å†…å®¹

ä»¥ä¸‹å››ä¸ªå®éªŒç‰¹æ€§åœ¨ Nuxt 4 ä¸­ä¸å†å¯é…ç½®ï¼š

* `experimental.treeshakeClientOnly` é»˜è®¤ä¸º `true`ï¼ˆv3.0 èµ·é»˜è®¤ï¼‰
* `experimental.configSchema` é»˜è®¤ä¸º `true`ï¼ˆv3.3 èµ·é»˜è®¤ï¼‰
* `experimental.polyfillVueUseHead` é»˜è®¤ä¸º `false`ï¼ˆv3.4 èµ·é»˜è®¤ï¼‰
* `experimental.respectNoSSRHeader` é»˜è®¤ä¸º `false`ï¼ˆv3.4 èµ·é»˜è®¤ï¼‰
* `vite.devBundler` ä¸å¯é…ç½®ï¼Œé»˜è®¤ä½¿ç”¨ `vite-node`

#### å˜æ›´åŸå› 

è¿™äº›é€‰é¡¹å·²é•¿æœŸä¿æŒæ­¤é»˜è®¤å€¼ï¼Œä¸”æ— ç†ç”±ç»§ç»­ä¿ç•™å¯é…ç½®æ€§ã€‚

#### è¿ç§»æ­¥éª¤

* `polyfillVueUseHead` å¯åœ¨ç”¨æˆ·ç«¯é€šè¿‡[æ­¤æ’ä»¶](https://github.com/nuxt/nuxt/blob/f209158352b09d1986aa320e29ff36353b91c358/packages/nuxt/src/head/runtime/plugins/vueuse-head-polyfill.ts#L10-L11)å®ç°
* `respectNoSSRHeader` å¯é€šè¿‡[æœåŠ¡å™¨ä¸­é—´ä»¶](https://github.com/nuxt/nuxt/blob/c660b39447f0d5b8790c0826092638d321cd6821/packages/nuxt/src/core/runtime/nitro/no-ssr.ts#L8-L9)å®ç°

## Nuxt 2 ä¸ Nuxt 3+ å¯¹æ¯”

ä¸‹è¡¨å¿«é€Ÿå¯¹æ¯”äº† Nuxt ä¸‰ä¸ªç‰ˆæœ¬ï¼š

| åŠŸèƒ½ / ç‰ˆæœ¬             | Nuxt 2          | Nuxt Bridge      | Nuxt 3+         |
|-------------------------|-----------------|------------------|-----------------|
| Vue ç‰ˆæœ¬                | 2               | 2                | 3               |
| ç¨³å®šæ€§                  | ğŸ˜Š ç¨³å®š         | ğŸ˜Š ç¨³å®š          | ğŸ˜Š ç¨³å®š         |
| æ€§èƒ½                    | ğŸ å¿«           | âœˆï¸ æ›´å¿«          | ğŸš€ æœ€å¿«         |
| Nitro å¼•æ“              | âŒ              | âœ…               | âœ…              |
| ESM æ”¯æŒ                | ğŸŒ™ éƒ¨åˆ†æ”¯æŒ     | ğŸ‘ è¾ƒå¥½          | âœ…              |
| TypeScript æ”¯æŒ         | â˜‘ï¸ å¯é€‰         | ğŸš§ éƒ¨åˆ†æ”¯æŒ      | âœ…              |
| Composition API         | âŒ              | ğŸš§ éƒ¨åˆ†æ”¯æŒ      | âœ…              |
| Options API             | âœ…              | âœ…               | âœ…              |
| ç»„ä»¶è‡ªåŠ¨å¯¼å…¥            | âœ…              | âœ…               | âœ…              |
| `<script setup>` è¯­æ³•   | âŒ              | ğŸš§ éƒ¨åˆ†æ”¯æŒ      | âœ…              |
| è‡ªåŠ¨å¯¼å…¥                | âŒ              | âœ…               | âœ…              |
| webpack ç‰ˆæœ¬           | 4               | 4                | 5               |
| Vite æ”¯æŒ               | âš ï¸ éƒ¨åˆ†æ”¯æŒ     | ğŸš§ éƒ¨åˆ†æ”¯æŒ      | âœ…              |
| Nuxt CLI                | âŒ è€ç‰ˆæœ¬       | âœ… `nuxt`        | âœ… `nuxt`       |
| é™æ€ç«™ç‚¹æ”¯æŒ            | âœ…              | âœ…               | âœ…              |

## ä» Nuxt 2 è¿ç§»åˆ° Nuxt 3+

è¿ç§»æŒ‡å—æä¾›äº† Nuxt 2 ç‰¹æ€§ä¸ Nuxt 3+ ç‰¹æ€§çš„é€æ­¥å¯¹æ¯”ï¼Œä»¥åŠå¦‚ä½•é€‚é…ç°æœ‰åº”ç”¨çš„æŒ‡å¯¼ã€‚

::read-more{to="/docs/migration/overview"}
æŸ¥çœ‹ **ä» Nuxt 2 è¿ç§»åˆ° Nuxt 3 çš„å®Œæ•´æŒ‡å—**ã€‚
::

## ä» Nuxt 2 è¿ç§»åˆ° Nuxt Bridge

å¦‚æœä½ å¸Œæœ›æ¸è¿›è¿ç§» Nuxt 2 åº”ç”¨åˆ° Nuxt 3ï¼Œå¯ä»¥ä½¿ç”¨ Nuxt Bridgeã€‚Nuxt Bridge æ˜¯ä¸€ä¸ªå…¼å®¹å±‚ï¼Œå…è®¸ä½ åœ¨ Nuxt 2 ä¸­æŒ‰éœ€å¯ç”¨ Nuxt 3+ çš„ç‰¹æ€§ã€‚

::read-more{to="/docs/bridge/overview"}
**ä» Nuxt 2 è¿ç§»åˆ° Nuxt Bridge**ã€‚
::