---
title: å‡çº§æŒ‡å—
description: 'äº†è§£å¦‚ä½•å‡çº§åˆ°æœ€æ–°çš„ Nuxt ç‰ˆæœ¬ã€‚'
navigation.icon: i-lucide-circle-arrow-up
---

## å‡çº§ Nuxt

### æœ€æ–°ç‰ˆæœ¬

è¦å°† Nuxt å‡çº§åˆ°[æœ€æ–°ç‰ˆæœ¬](https://github.com/nuxt/nuxt/releases)ï¼Œè¯·ä½¿ç”¨ `nuxt upgrade` å‘½ä»¤ã€‚

::code-group{sync="pm"}

```bash [npm]
npx nuxt upgrade
```

```bash [yarn]
yarn nuxt upgrade
```

```bash [pnpm]
pnpm nuxt upgrade
```

```bash [bun]
bun x nuxt upgrade
```

::

### å¤œç‰ˆå‘å¸ƒæ¸ é“

è¦ä½¿ç”¨ Nuxt çš„æœ€æ–°æ„å»ºç‰ˆæœ¬å¹¶æµ‹è¯•æ–°åŠŸèƒ½ï¼ˆå°šæœªæ­£å¼å‘å¸ƒï¼‰ï¼Œè¯·é˜…è¯»[å¤œç‰ˆå‘å¸ƒæ¸ é“](/docs/4.x/guide/going-further/nightly-release-channel)æŒ‡å—ã€‚

## æµ‹è¯• Nuxt 5

Nuxt 5 **ç›®å‰æ­£åœ¨å¼€å‘ä¸­**ã€‚åœ¨å‘å¸ƒä¹‹å‰ï¼Œå¯ä»¥æµ‹è¯•è®¸å¤š Nuxt 5 ä» Nuxt ç‰ˆæœ¬ 4.2+ çš„é‡å¤§æ›´æ”¹ã€‚

### é€‰æ‹©ä½¿ç”¨ Nuxt 5

é¦–å…ˆï¼Œå°† Nuxt å‡çº§åˆ° [æœ€æ–°ç‰ˆæœ¬](https://github.com/nuxt/nuxt/releases)ã€‚

ç„¶åï¼Œæ‚¨å¯ä»¥å°† `future.compatibilityVersion` è®¾ç½®ä¸ºåŒ¹é… Nuxt 5 çš„è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  future: {
    compatibilityVersion: 5,
  },
})
```

å½“æ‚¨å°† `future.compatibilityVersion` è®¾ç½®ä¸º `5` æ—¶ï¼Œæ‚¨åœ¨ Nuxt é…ç½®ä¸­çš„é»˜è®¤å€¼å°†æ›´æ”¹ä¸ºé€‰æ‹© Nuxt v5 çš„è¡Œä¸ºï¼ŒåŒ…æ‹¬ï¼š

- **Vite ç¯å¢ƒ API**ï¼šè‡ªåŠ¨å¯ç”¨æ–°çš„ [Vite ç¯å¢ƒ API](#migration-to-vite-environment-api)ï¼Œä»¥æ”¹å–„æ„å»ºé…ç½®ã€‚
- å…¶ä»– Nuxt 5 çš„æ”¹è¿›å’Œå˜åŒ–å°†ä¼šåœ¨å¯ç”¨æ—¶å‘å¸ƒã€‚

::note
æœ¬èŠ‚å†…å®¹åœ¨æœ€ç»ˆå‘å¸ƒä¹‹å‰å¯èƒ½ä¼šæœ‰æ‰€æ›´æ”¹ï¼Œå› æ­¤å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ `future.compatibilityVersion: 5` æµ‹è¯• Nuxt 5ï¼Œè¯·å®šæœŸå›æ¥æŸ¥çœ‹ã€‚
::

é‡å¤§æˆ–æ˜¾è‘—çš„å˜åŒ–å°†åœ¨ä¸‹é¢æ³¨æ˜ï¼Œå¹¶é™„ä¸Šå‘å/å‘å‰å…¼å®¹çš„è¿ç§»æ­¥éª¤ã€‚

### è¿ç§»åˆ° Vite ç¯å¢ƒ API

ğŸš¦ **å½±å“çº§åˆ«**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

Nuxt 5 è¿ç§»åˆ° Vite 6 çš„æ–° [ç¯å¢ƒ API](https://vite.dev/guide/api-environment)ï¼Œè¯¥ API æ­£å¼åŒ–äº†ç¯å¢ƒçš„æ¦‚å¿µï¼Œå¹¶æä¾›äº†å¯¹æ¯ä¸ªç¯å¢ƒé…ç½®çš„æ›´å¥½æ§åˆ¶ã€‚

ä¹‹å‰ï¼ŒNuxt ä½¿ç”¨å•ç‹¬çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ Vite é…ç½®ã€‚ç°åœ¨ï¼ŒNuxt ä½¿ç”¨å…±äº«çš„ Vite é…ç½®ï¼Œå¹¶é…å¤‡ç‰¹å®šäºç¯å¢ƒçš„æ’ä»¶ï¼Œè¿™äº›æ’ä»¶ä½¿ç”¨ `applyToEnvironment()` æ–¹æ³•æ¥é’ˆå¯¹ç‰¹å®šç¯å¢ƒã€‚

::tip
æ‚¨å¯ä»¥é€šè¿‡è®¾ç½® `future.compatibilityVersion: 5`ï¼ˆè¯·å‚é˜… [æµ‹è¯• Nuxt 5](#æµ‹è¯•-nuxt-5)ï¼‰æˆ–é€šè¿‡æ˜¾å¼å¯ç”¨ `experimental.viteEnvironmentApi: true` æ¥æå‰æµ‹è¯•æ­¤åŠŸèƒ½ã€‚
::

**å…³é”®å˜åŒ–ï¼š**

1. **ä¸å†æ”¯æŒç‰¹å®šäºç¯å¢ƒçš„ `extendViteConfig()`**ï¼š `extendViteConfig()` ä¸­çš„ `server` å’Œ `client` é€‰é¡¹å·²è¢«å¼ƒç”¨ï¼Œä½¿ç”¨æ—¶å°†æ˜¾ç¤ºè­¦å‘Šã€‚

2. **æ›´æ”¹æ’ä»¶æ³¨å†Œ**ï¼šä½¿ç”¨ `addVitePlugin()` æ³¨å†Œçš„ Vite æ’ä»¶ï¼Œå¦‚æœä»…é’ˆå¯¹ä¸€ä¸ªç¯å¢ƒï¼ˆé€šè¿‡ä¼ é€’ `server: false` æˆ– `client: false`ï¼‰å°†ä¸ä¼šè°ƒç”¨å…¶ `config` æˆ– `configResolved` é’©å­ã€‚

3. **å…±äº«é…ç½®**ï¼š`vite:extendConfig` å’Œ `vite:configResolved` é’©å­ç°åœ¨ä¸å…±äº«é…ç½®ä¸€èµ·å·¥ä½œï¼Œè€Œä¸æ˜¯å•ç‹¬çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨é…ç½®ã€‚

#### å˜æ›´åŸå› 

Vite ç¯å¢ƒ API æä¾›äº†ï¼š
- æ›´å¥½çš„ä¸€è‡´æ€§ï¼Œç¡®ä¿å¼€å‘å’Œç”Ÿäº§æ„å»ºä¹‹é—´çš„å·®å¼‚æœ€å°åŒ–
- æ›´ç»†ç²’åº¦çš„ç¯å¢ƒç‰¹å®šé…ç½®æ§åˆ¶
- æ”¹è¿›çš„æ€§èƒ½å’Œæ’ä»¶æ¶æ„
- æ”¯æŒè‡ªå®šä¹‰ç¯å¢ƒï¼Œè€Œä¸ä»…ä»…æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨

#### è¿ç§»æ­¥éª¤

##### 1. è¿ç§»åˆ°ä½¿ç”¨ Vite æ’ä»¶

æˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨ Vite æ’ä»¶ï¼Œè€Œä¸æ˜¯ `extendViteConfig`ã€`vite:configResolved` å’Œ `vite:extendConfig`ã€‚

```ts
// Before
extendViteConfig((config) => {
  config.optimizeDeps.include.push('my-package')
}, { server: false })

nuxt.hook('vite:extendConfig' /* or vite:configResolved */, (config, { isClient }) => {
  if (isClient) {
    config.optimizeDeps.include.push('my-package')
  }
})

// After
addVitePlugin(() => ({
  name: 'my-plugin',
  config (config) {
    // you can set global vite configuration here
  },
  configResolved (config) {
    // you can access the fully resolved vite configuration here
  },
  configEnvironment (name, config) {
    // you can set environment-specific vite configuration here
    if (name === 'client') {
      config.optimizeDeps ||= {}
      config.optimizeDeps.include ||= []
      config.optimizeDeps.include.push('my-package')
    }
  },
  applyToEnvironment (environment) {
    return environment.name === 'client'
  },
}))
```

##### 2. è¿ç§» Vite æ’ä»¶ä»¥ä½¿ç”¨ç¯å¢ƒ

æ‚¨å¯ä»¥ä½¿ç”¨æ’ä»¶ä¸­çš„æ–° `applyToEnvironment` é’©å­ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `addVitePlugin` ç»“åˆ `server: false` æˆ– `client: false`ã€‚

```ts
// Before
addVitePlugin(() => ({
  name: 'my-plugin',
  config (config) {
    config.optimizeDeps.include.push('my-package')
  },
}), { client: false })

// After
addVitePlugin(() => ({
  name: 'my-plugin',
  config (config) {
    // you can set global vite configuration here
  },
  configResolved (config) {
    // you can access the fully resolved vite configuration here
  },
  configEnvironment (name, config) {
    // you can set environment-specific vite configuration here
    if (name === 'client') {
      config.optimizeDeps ||= {}
      config.optimizeDeps.include ||= []
      config.optimizeDeps.include.push('my-package')
    }
  },
  applyToEnvironment (environment) {
    return environment.name === 'client'
  },
}))
```

::read-more{to="https://vite.dev/guide/api-environment" target="_blank"}
Learn more about Vite's Environment API
::

## è¿ç§»åˆ° Nuxt 4

Nuxt 4 åŒ…å«äº†æ˜¾è‘—çš„æ”¹è¿›å’Œå˜åŒ–ã€‚æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å°†ç°æœ‰çš„ Nuxt 3 åº”ç”¨è¿ç§»åˆ° Nuxt 4ã€‚

é¦–å…ˆï¼Œå‡çº§åˆ° Nuxt 4ï¼š

::code-group{sync="pm"}

```bash [npm]
npm install nuxt@^4.0.0
```

```bash [yarn]
yarn add nuxt@^4.0.0
```

```bash [pnpm]
pnpm add nuxt@^4.0.0
```

```bash [bun]
bun add nuxt@^4.0.0
```

::

å‡çº§å®Œæˆåï¼Œå¤§å¤šæ•° Nuxt 4 çš„è¡Œä¸ºå·²æˆä¸ºé»˜è®¤ã€‚ä½†å¦‚æœåœ¨è¿ç§»è¿‡ç¨‹ä¸­éœ€è¦ä¿æŒå‘åå…¼å®¹ï¼ŒæŸäº›ç‰¹æ€§ä»å¯ä»¥é…ç½®ã€‚

ä»¥ä¸‹ç« èŠ‚è¯¦ç»†æè¿°äº†å‡çº§åˆ° Nuxt 4 æ—¶çš„ä¸»è¦å˜åŒ–å’Œè¿ç§»æ­¥éª¤ã€‚

é‡å¤§æˆ–ç ´åæ€§æ›´æ”¹å‡å·²è®°å½•ï¼Œå¹¶é™„å¸¦è¿ç§»æ­¥éª¤åŠå¯ç”¨é…ç½®é€‰é¡¹ã€‚

### ä½¿ç”¨ Codemods è¿ç§»

ä¸ºäº†ç®€åŒ–å‡çº§æµç¨‹ï¼Œæˆ‘ä»¬ä¸ [Codemod](https://github.com/codemod-com/codemod) å›¢é˜Ÿåˆä½œï¼Œæä¾›äº†å¤šä¸ªå¼€æºçš„è‡ªåŠ¨åŒ–è¿ç§»è„šæœ¬ã€‚

::note
å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·ä½¿ç”¨ `npx codemod feedback` å‘ Codemod å›¢é˜Ÿåé¦ˆ ğŸ™
::

å…³äº Nuxt 4 Codemods çš„å®Œæ•´åˆ—è¡¨ã€è¯¦ç»†ä¿¡æ¯ã€æºç åŠå¤šç§è¿è¡Œæ–¹å¼ï¼Œè¯·è®¿é—® [Codemod æ³¨å†Œè¡¨](https://go.codemod.com/codemod-registry)ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ `codemod` è„šæœ¬è¿è¡Œæœ¬æŒ‡å—ä¸­æåŠçš„æ‰€æœ‰ codemodï¼š

::code-group

```bash [npm]
# Using pinned version due to https://github.com/codemod-com/codemod/issues/1710
npx codemod@0.18.7 nuxt/4/migration-recipe
```

```bash [yarn]
# Using pinned version due to https://github.com/codemod-com/codemod/issues/1710
yarn dlx codemod@0.18.7 nuxt/4/migration-recipe
```

```bash [pnpm]
# Using pinned version due to https://github.com/codemod-com/codemod/issues/1710
pnpm dlx codemod@0.18.7 nuxt/4/migration-recipe
```

```bash [bun]
# Using pinned version due to https://github.com/codemod-com/codemod/issues/1710
bun x codemod@0.18.7 nuxt/4/migration-recipe
```

::

è¯¥å‘½ä»¤ä¼šä¾æ¬¡æ‰§è¡Œæ‰€æœ‰ codemodsï¼Œå¹¶å…è®¸æ‚¨å–æ¶ˆé€‰æ‹©ä¸å¸Œæœ›è¿è¡Œçš„é¡¹ã€‚æ¯ä¸ª codemod ä¹Ÿåœ¨ä¸‹é¢æŒ‰å…¶å¯¹åº”æ›´æ”¹åˆ—å‡ºï¼Œå¯å•ç‹¬è¿è¡Œã€‚

### æ–°çš„ç›®å½•ç»“æ„

ğŸš¦ **å½±å“çº§åˆ«**ï¼šé‡å¤§

Nuxt ç°åœ¨é»˜è®¤é‡‡ç”¨æ–°çš„ç›®å½•ç»“æ„ï¼ŒåŒæ—¶ä¿æŒå‘åå…¼å®¹ï¼ˆå¦‚æœ Nuxt æ£€æµ‹åˆ°æ‚¨ä½¿ç”¨çš„æ˜¯æ—§ç»“æ„ï¼Œæ¯”å¦‚å­˜åœ¨é¡¶å±‚çš„ `app/pages/` ç›®å½•ï¼Œåˆ™ä¸ä¼šåº”ç”¨æ­¤æ–°ç»“æ„ï¼‰ã€‚

ğŸ‘‰ [æŸ¥çœ‹å®Œæ•´ RFC](https://github.com/nuxt/nuxt/issues/26444)

#### å˜åŒ–å†…å®¹

- æ–°çš„ Nuxt é»˜è®¤ `srcDir` å˜ä¸º `app/`ï¼Œå¤§å¤šæ•°èµ„æºéƒ½ä¼šä»è¿™é‡Œè§£æã€‚
- `serverDir` é»˜è®¤å€¼ç”± `<srcDir>/server` æ”¹ä¸º `<rootDir>/server`
- `layers/`ã€`modules/` å’Œ `public/` ç›®å½•é»˜è®¤ç›¸å¯¹äº `<rootDir>` è§£æ
- ä½¿ç”¨ [Nuxt Content v2.13+](https://github.com/nuxt/content/pull/2649) æ—¶ï¼Œ`content/` ç›®å½•é»˜è®¤ç›¸å¯¹äº `<rootDir>` è§£æ
- æ–°å¢ `dir.app` é…ç½®é¡¹ï¼ŒæŒ‡å®šæŸ¥æ‰¾ `router.options.ts` å’Œ `spa-loading-template.html` çš„ç›®å½•ï¼Œé»˜è®¤æ˜¯ `<srcDir>/`

<details>

<summary>ç¤ºä¾‹ v4 ç‰ˆæœ¬çš„æ–‡ä»¶å¤¹ç»“æ„ã€‚</summary>

```sh
.output/
.nuxt/
app/
  assets/
  components/
  composables/
  layouts/
  middleware/
  pages/
  plugins/
  utils/
  app.config.ts
  app.vue
  router.options.ts
content/
layers/
modules/
node_modules/
public/
shared/
server/
  api/
  middleware/
  plugins/
  routes/
  utils/
nuxt.config.ts
```

::note
åœ¨æ­¤æ–°ç»“æ„ä¸‹ï¼Œ`~` åˆ«åé»˜è®¤æŒ‡å‘ `app/` ç›®å½•ï¼ˆå³ `srcDir`ï¼‰ã€‚è¿™æ„å‘³ç€ `~/components` è§£æåˆ° `app/components/`ï¼Œ`~/pages` è§£æåˆ° `app/pages/`ï¼Œç­‰ç­‰ã€‚
::

</details>

ğŸ‘‰ æ›´å¤šç»†èŠ‚è¯·å‚è§[å®ç°è¯¥å˜æ›´çš„ PR](https://github.com/nuxt/nuxt/pull/27029)ã€‚

#### å˜æ›´åŸå› 

1. **æ€§èƒ½** â€” å°†æ‰€æœ‰ä»£ç ç½®äºä»“åº“æ ¹ç›®å½•ä¼šå¯¼è‡´ `.git/` å’Œ `node_modules/` æ–‡ä»¶å¤¹è¢«æ–‡ä»¶ç³»ç»Ÿç›‘è§†å™¨æ‰«æï¼Œå°¤å…¶åœ¨é Mac OS ç³»ç»Ÿä¸‹æå¤§å»¶é•¿å¯åŠ¨æ—¶é—´ã€‚
1. **IDE ç±»å‹å®‰å…¨** â€” `server/` ç›®å½•ä¸åº”ç”¨çš„å…¶ä»–éƒ¨åˆ†è¿è¡Œåœ¨å®Œå…¨ä¸åŒçš„ä¸Šä¸‹æ–‡å¹¶æœ‰ä¸åŒçš„å…¨å±€å¯¼å…¥ï¼Œç¡®ä¿ `server/` ä¸åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸‹æ˜¯ä¿è¯ IDE è‡ªåŠ¨è¡¥å…¨æ•ˆæœçš„é‡è¦ä¸€æ­¥ã€‚

:video-accordion{title="è§‚çœ‹ Vue School å…³äºæ–°ç›®å½•ç»“æ„çš„è§†é¢‘" videoId="1031028378" platform="vimeo"}

#### è¿ç§»æ­¥éª¤

1. æ–°å»ºä¸€ä¸ªåä¸º `app/` çš„ç›®å½•ã€‚
1. å°† `assets/`ã€`components/`ã€`composables/`ã€`layouts/`ã€`middleware/`ã€`pages/`ã€`plugins/` å’Œ `utils/` æ–‡ä»¶å¤¹ï¼Œä»¥åŠ `app.vue`ã€`error.vue`ã€`app.config.ts` ç§»åŠ¨åˆ° `app/` ç›®å½•ä¸‹ã€‚å¦‚æœæ‚¨æœ‰ `app/router-options.ts` æˆ– `app/spa-loading-template.html`ï¼Œè·¯å¾„ä¿æŒä¸å˜ã€‚
1. ç¡®ä¿ `nuxt.config.ts`ã€`content/`ã€`layers/`ã€`modules/`ã€`public/` å’Œ `server/` è¿™äº›æ–‡ä»¶å¤¹ä¾ç„¶åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œä¸”æœªç§»å…¥ `app/`ã€‚
1. è®°å¾—æ›´æ–°ä»»ä½•ç¬¬ä¸‰æ–¹é…ç½®æ–‡ä»¶ä»¥é…åˆæ–°çš„ç›®å½•ç»“æ„ï¼Œä¾‹å¦‚ `tailwindcss` æˆ– `eslint` é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼Œ`@nuxtjs/tailwindcss` åº”è‡ªåŠ¨æ­£ç¡®é…ç½® `tailwindcss`ï¼‰ã€‚

::tip
æ‚¨å¯ä»¥è¿è¡Œ `npx codemod@latest nuxt/4/file-structure` è‡ªåŠ¨å®Œæˆè¯¥è¿ç§»ã€‚
::

ä¸è¿‡ï¼Œè¿ç§» _éå¼ºåˆ¶æ€§_ã€‚å¦‚æœæ‚¨å¸Œæœ›ä¿æŒç°æœ‰ç›®å½•ç»“æ„ï¼ŒNuxt ä¼šè‡ªåŠ¨æ£€æµ‹ã€‚ï¼ˆå¦‚æœæœªæ£€æµ‹åˆ°ï¼Œè¯·æäº¤ issueã€‚ï¼‰å”¯ä¸€ä¾‹å¤–æ˜¯å¦‚æœæ‚¨å·²æœ‰è‡ªå®šä¹‰çš„ `srcDir`ï¼Œæ­¤æ—¶ `modules/`ã€`public/` å’Œ `server/` æ–‡ä»¶å¤¹å°†é»˜è®¤ä» `rootDir` è§£æï¼Œè€Œéè‡ªå®šä¹‰çš„ `srcDir`ã€‚æ‚¨å¯ä»¥é€šè¿‡é…ç½® `dir.modules`ã€`dir.public` å’Œ `serverDir` æ¥è¦†ç›–ã€‚

æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®å¼ºåˆ¶ä½¿ç”¨ v3 çš„ç›®å½•ç»“æ„ï¼š

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  // å°†æ–°é»˜è®¤çš„ srcDir ä» `app` æ”¹å›æ ¹ç›®å½•
  srcDir: '.',
  // æŒ‡å®š `router.options.ts` å’Œ `spa-loading-template.html` çš„ç›®å½•å‰ç¼€
  dir: {
    app: 'app',
  },
})
```

### å•ä¾‹æ•°æ®è·å–å±‚

ğŸš¦ **å½±å“çº§åˆ«**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

Nuxt çš„æ•°æ®è·å–ç³»ç»Ÿï¼ˆ`useAsyncData` å’Œ `useFetch`ï¼‰ç»è¿‡é‡å¤§é‡ç»„ï¼Œä»¥æå‡æ€§èƒ½ä¸ä¸€è‡´æ€§ï¼š

1. **ç›¸åŒ key å…±äº« refs**ï¼šæ‰€æœ‰ä½¿ç”¨ç›¸åŒ key è°ƒç”¨ `useAsyncData` æˆ– `useFetch` çš„åœ°æ–¹éƒ½ä¼šå…±äº«ç›¸åŒçš„ `data`ã€`error` å’Œ `status` å¼•ç”¨ã€‚è¿™æ„å‘³ç€å¸¦æœ‰æ˜¾å¼ key çš„è°ƒç”¨ï¼Œå…¶ `deep`ã€`transform`ã€`pick`ã€`getCachedData` æˆ– `default` é€‰é¡¹å¿…é¡»ä¸€è‡´ï¼Œé¿å…å†²çªã€‚

2. **æ›´çµæ´»çš„ `getCachedData`**ï¼š`getCachedData` å‡½æ•°ç°åœ¨æ¯æ¬¡æ•°æ®è·å–æ—¶éƒ½ä¼šè°ƒç”¨ï¼ŒåŒ…æ‹¬ç”±ä¾¦å¬å™¨è§¦å‘æˆ–æ‰‹åŠ¨è°ƒç”¨ `refreshNuxtData` æ—¶ã€‚ï¼ˆä¹‹å‰è¿™äº›æƒ…å†µä¸‹ä¸ä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚ï¼‰ä¸ºæ›´çµæ´»åœ°æ§åˆ¶ä½•æ—¶ä½¿ç”¨ç¼“å­˜æ•°æ®ã€ä½•æ—¶é‡æ–°è¯·æ±‚ï¼Œå‡½æ•°ä¼šæ¥æ”¶åŒ…å«è¯·æ±‚åŸå› çš„ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚

3. **æ”¯æŒå“åº”å¼ key**ï¼šç°åœ¨æ”¯æŒä½¿ç”¨è®¡ç®— Refã€æ™®é€š Ref æˆ– getter å‡½æ•°ä½œä¸º keyï¼Œå¯ä»¥åŸºäº key è‡ªåŠ¨é‡æ–°è¯·æ±‚æ•°æ®ï¼ˆå¹¶ä¸”ç‹¬ç«‹å­˜å‚¨æ•°æ®ï¼‰ã€‚

4. **æ•°æ®è‡ªåŠ¨æ¸…ç†**ï¼šæœ€åä¸€ä¸ªä½¿ç”¨ `useAsyncData` æ•°æ®çš„ç»„ä»¶å¸è½½æ—¶ï¼ŒNuxt ä¼šè‡ªåŠ¨ç§»é™¤ç›¸å…³æ•°æ®ï¼Œé¿å…å†…å­˜å ç”¨ä¸æ–­å¢é•¿ã€‚

#### å˜æ›´åŸå› 

æ­¤æ”¹åŠ¨æå‡å†…å­˜åˆ©ç”¨æ•ˆç‡ï¼ŒåŒæ—¶ç»Ÿä¸€ `useAsyncData` å„è°ƒç”¨å¤„çš„åŠ è½½çŠ¶æ€è¡¨ç°ã€‚

#### è¿ç§»æ­¥éª¤

1. **æ£€æŸ¥ä¸ä¸€è‡´çš„é€‰é¡¹**ï¼šæŸ¥æ‰¾æ‰€æœ‰ä½¿ç”¨åŒä¸€ key ä½†å¸¦ä¸åŒé€‰é¡¹æˆ– fetch å‡½æ•°çš„ç»„ä»¶ã€‚

   ```ts
   // ç°åœ¨ä¼šè§¦å‘è­¦å‘Š
   const { data: users1 } = useAsyncData('users', () => $fetch('/api/users'), { deep: false })
   const { data: users2 } = useAsyncData('users', () => $fetch('/api/users'), { deep: true })
   ```

   å»ºè®®å°†å¸¦æœ‰æ˜¾å¼ keyï¼ˆä¸”è‡ªå®šä¹‰é€‰é¡¹ï¼‰çš„è°ƒç”¨æå–ä¸ºç‹¬ç«‹çš„ç»„åˆå‡½æ•°ï¼š

   ```ts [app/composables/useUserData.ts]
   export function useUserData (userId: string) {
     return useAsyncData(
       `user-${userId}`,
       () => fetchUser(userId),
       {
         deep: true,
         transform: user => ({ ...user, lastAccessed: new Date() }),
       },
     )
   }
   ```

2. **æ›´æ–° `getCachedData` å®ç°**ï¼š

   ```diff
   useAsyncData('key', fetchFunction, {
   -  getCachedData: (key, nuxtApp) => {
   -    return cachedData[key]
   -  }
   +  getCachedData: (key, nuxtApp, ctx) => {
   +    // ctx.cause - å¯èƒ½ä¸º 'initial' | 'refresh:hook' | 'refresh:manual' | 'watch'
   +    
   +    // ç¤ºä¾‹ï¼šæ‰‹åŠ¨åˆ·æ–°æ—¶ä¸ä½¿ç”¨ç¼“å­˜
   +    if (ctx.cause === 'refresh:manual') return undefined
   +    
   +    return cachedData[key]
   +  }
   })
   ```

æˆ–è€…ï¼Œæ‚¨ç°åœ¨ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®ç¦ç”¨è¯¥è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    granularCachedData: false,
    purgeCachedData: false,
  },
})
```

### Layers ä¸­ä¿®æ­£çš„æ¨¡å—åŠ è½½é¡ºåº

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

ä½¿ç”¨[Nuxt å±‚çº§ç³»ç»Ÿ](/docs/4.x/guide/going-further/layers)æ—¶ï¼Œä¹‹å‰æ¨¡å—åŠ è½½é¡ºåºé”™è¯¯ï¼šé¡¹ç›®æ ¹ç›®å½•çš„æ¨¡å—å…ˆåŠ è½½ï¼Œæ‰©å±•å±‚çš„æ¨¡å—ååŠ è½½ï¼Œé¡ºåºä¸é¢„æœŸç›¸åã€‚

ç°åœ¨æ¨¡å—åŠ è½½é¡ºåºå·²è¢«æ­£ç¡®ä¿®æ­£ï¼š

1. **å…ˆåŠ è½½å±‚çº§æ¨¡å—**ï¼ˆæŒ‰ç…§æ‰©å±•é¡ºåºï¼Œæœ€æ·±å±‚ä¼˜å…ˆï¼‰
2. **ååŠ è½½é¡¹ç›®æ¨¡å—**ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

è¿™å½±å“äº†ï¼š

- åœ¨ `nuxt.config.ts` çš„ `modules` æ•°ç»„ä¸­å®šä¹‰çš„æ¨¡å—
- `modules/` ç›®å½•ä¸­è‡ªåŠ¨å‘ç°çš„æ¨¡å—

#### å˜æ›´åŸå› 

æ­¤æ”¹åŠ¨ç¡®ä¿ï¼š

- æ‰©å±•å±‚çš„ä¼˜å…ˆçº§ä½äºä½¿ç”¨å®ƒä»¬çš„é¡¹ç›®
- æ¨¡å—æ‰§è¡Œé¡ºåºç¬¦åˆå±‚ç»§æ‰¿çš„ç›´è§‚é¢„æœŸ
- åœ¨å¤šå±‚æ¶æ„ä¸‹ï¼Œæ¨¡å—é…ç½®å’Œé’©å­èƒ½æ­£å¸¸å·¥ä½œ

#### è¿ç§»æ­¥éª¤

**å¤§å¤šæ•°é¡¹ç›®æ— éœ€æ›´æ”¹**ï¼Œæ­¤æ”¹åŠ¨åªæ˜¯ä¿®æ­£äº†æ¨¡å—åŠ è½½é¡ºåºä¸é¢„æœŸç›¸ç¬¦ã€‚

ä½†å¦‚æœæ‚¨çš„é¡¹ç›®ä¾èµ–ä¹‹å‰é”™è¯¯çš„é¡ºåºï¼Œå¯èƒ½éœ€è¦ï¼š

1. **æ£€æŸ¥æ¨¡å—ä¾èµ–å…³ç³»**ï¼šæŸ¥çœ‹æ˜¯å¦æœ‰æ¨¡å—ä¾èµ–ç‰¹å®šåŠ è½½é¡ºåº
2. **è°ƒæ•´æ¨¡å—é…ç½®**ï¼šå¦‚æœæ­¤å‰ä¸ºåº”å¯¹é¡ºåºé—®é¢˜åšäº†é…ç½®è°ƒæ•´
3. **å……åˆ†æµ‹è¯•**ï¼šç¡®ä¿ä¿®æ­£é¡ºåºååŠŸèƒ½æ­£å¸¸

æ–°çš„æ­£ç¡®ç¤ºä¾‹é¡ºåºï¼š

```ts
// å±‚çº§ï¼šmy-layer/nuxt.config.ts
export default defineNuxtConfig({
  modules: ['layer-module-1', 'layer-module-2'],
})

// é¡¹ç›®ï¼šnuxt.config.ts
export default defineNuxtConfig({
  extends: ['./my-layer'],
  modules: ['project-module-1', 'project-module-2'],
})

// åŠ è½½é¡ºåºï¼ˆå·²ä¿®æ­£ï¼‰ï¼š
// 1. layer-module-1
// 2. layer-module-2
// 3. project-module-1 ï¼ˆå¯è¦†ç›–å±‚æ¨¡å—ï¼‰
// 4. project-module-2 ï¼ˆå¯è¦†ç›–å±‚æ¨¡å—ï¼‰
```

å¦‚æœæ‚¨çš„æ¨¡å—é¡ºåºä¾èµ–äºæ³¨å†Œé’©å­ï¼Œå»ºè®®ä½¿ç”¨ [`modules:done` é’©å­](/docs/4.x/guide/going-further/modules#custom-hooks)ï¼Œè¯¥é’©å­åœ¨æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆåè§¦å‘ï¼Œä½¿ç”¨å®ƒæ¯”è¾ƒå®‰å…¨ã€‚

ğŸ‘‰ å‚è§ [PR #31507](https://github.com/nuxt/nuxt/pull/31507) å’Œ [issue #25719](https://github.com/nuxt/nuxt/issues/25719) è·å–æ›´å¤šç»†èŠ‚ã€‚

### è·¯ç”±å…ƒæ•°æ®å»é‡

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

å¯ä»¥ä½¿ç”¨ `definePageMeta` è®¾ç½®æŸäº›è·¯ç”±å…ƒæ•°æ®ï¼Œå¦‚ `name`ã€`path` ç­‰ã€‚ä¹‹å‰è¿™äº›å…ƒæ•°æ®åŒæ—¶å­˜åœ¨äºè·¯ç”±å¯¹è±¡å’Œè·¯ç”±å…ƒæ•°æ®å¯¹è±¡ä¸­ï¼ˆä¾‹å¦‚ `route.name` å’Œ `route.meta.name`ï¼‰ã€‚

ç°åœ¨ï¼Œå®ƒä»¬åªåœ¨è·¯ç”±å¯¹è±¡ä¸Šå¯è®¿é—®ã€‚

#### å˜æ›´åŸå› 

è¿™æ˜¯å› ä¸ºé»˜è®¤å¯ç”¨äº† `experimental.scanPageMeta`ï¼Œæ˜¯æ€§èƒ½ä¼˜åŒ–æªæ–½ã€‚

#### è¿ç§»æ­¥éª¤

è¿ç§»éå¸¸ç®€å•ï¼š

```diff
  const route = useRoute()
  
- console.log(route.meta.name)
+ console.log(route.name)
```

### ç»„ä»¶åç§°æ ‡å‡†åŒ–

ğŸš¦ **å½±å“çº§åˆ«**ï¼šä¸­ç­‰

Vue ç°åœ¨ä¼šç”Ÿæˆç¬¦åˆ Nuxt ç»„ä»¶å‘½åè§„åˆ™çš„ç»„ä»¶åç§°ã€‚

#### å˜åŒ–å†…å®¹

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ‚¨æœªæ‰‹åŠ¨è®¾ç½®ï¼ŒVue ä¼šèµ‹äºˆç»„ä»¶åç­‰åŒäºç»„ä»¶æ–‡ä»¶åçš„åç§°ã€‚

```bash [ç›®å½•ç»“æ„]
â”œâ”€ components/
â”œâ”€â”€â”€ SomeFolder/
â”œâ”€â”€â”€â”€â”€ MyComponent.vue
```

æ­¤æ—¶ï¼ŒVue è®¤ä¸ºç»„ä»¶åä¸º `MyComponent`ã€‚å¦‚æœä½ æƒ³å’Œ `<KeepAlive>` æ­é…ä½¿ç”¨ï¼Œæˆ–åœ¨ Vue DevTools ä¸­è¯†åˆ«è¯¥ç»„ä»¶ï¼Œéœ€è¦ä½¿ç”¨è¿™ä¸ªåç§°ã€‚

ä½† Nuxt çš„è‡ªåŠ¨å¯¼å…¥ä¼šä½¿ç”¨ `SomeFolderMyComponent` ä½œä¸ºåç§°ã€‚

æ­¤æ¬¡å˜æ›´åï¼Œè¿™ä¸¤ä¸ªåç§°å°†ä¿æŒä¸€è‡´ï¼ŒVue ç”Ÿæˆçš„ç»„ä»¶åå°†åŒ¹é… Nuxt çš„å‘½åæ¨¡å¼ã€‚

#### è¿ç§»æ­¥éª¤

ç¡®ä¿æ‚¨åœ¨ä½¿ç”¨ `@vue/test-utils` çš„ `findComponent` è¿›è¡Œæµ‹è¯•ï¼Œä»¥åŠä»»ä½•ä¾èµ–ç»„ä»¶åçš„ `<KeepAlive>` ä¸­ä½¿ç”¨æ›´æ–°åçš„åç§°ã€‚

æˆ–è€…ï¼Œæ‚¨ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®ç¦ç”¨æ­¤è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    normalizeComponentNames: false,
  },
})
```

### Unhead v2

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

ç”¨äºç”Ÿæˆ `<head>` æ ‡ç­¾çš„ [Unhead](https://unhead.unjs.io/) å‡çº§åˆ°ç‰ˆæœ¬ 2ã€‚å°½ç®¡å¤§å¤šæ•°å…¼å®¹ï¼Œä½†åº•å±‚ API æœ‰è‹¥å¹²ç ´åæ€§å˜æ›´ï¼š

- ç§»é™¤å±æ€§ï¼š`vmid`ã€`hid`ã€`children`ã€`body`
- ä¸å†æ”¯æŒ Promise ç±»å‹çš„è¾“å…¥
- é»˜è®¤ä½¿ç”¨ Capo.js å¯¹æ ‡ç­¾è¿›è¡Œæ’åº

#### è¿ç§»æ­¥éª¤

ä¸Šè¿°å˜æ›´å¯¹åº”ç”¨å½±å“è¾ƒå°ã€‚

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

- æ‚¨æ˜¯å¦ä½¿ç”¨äº†å·²ç§»é™¤çš„å±æ€§

```diff
useHead({
  meta: [{ 
    name: 'description', 
    // meta æ ‡ç­¾æ— éœ€ vmid æˆ– key    
-   vmid: 'description' 
-   hid: 'description'
  }]
})
```

- å¦‚æœä½¿ç”¨äº† [æ¨¡æ¿å‚æ•°](https://unhead.unjs.io/docs/head/guides/plugins/template-params) æˆ– [åˆ«åæ ‡ç­¾æ’åº](https://unhead.unjs.io/docs/head/guides/plugins/alias-sorting)ï¼Œéœ€è¦æ˜¾å¼å¯ç”¨ç›¸å…³æ’ä»¶ã€‚

```ts
import { AliasSortingPlugin, TemplateParamsPlugin } from '@unhead/vue/plugins'

export default defineNuxtPlugin({
  setup () {
    const unhead = injectHead()
    unhead.use(TemplateParamsPlugin)
    unhead.use(AliasSortingPlugin)
  },
})
```

è™½ç„¶éå¿…é¡»ï¼Œå»ºè®®å°†æ‰€æœ‰ä» `@unhead/vue` çš„å¯¼å…¥æ”¹ä¸º `#imports` æˆ– `nuxt/app`ã€‚

```diff
-import { useHead } from '@unhead/vue'
+import { useHead } from '#imports'
```

å¦‚ä»æœ‰é—®é¢˜ï¼Œå¯é€šè¿‡å¯ç”¨ `head.legacy` é…ç½®å›é€€åˆ° v1 è¡Œä¸ºï¼š

```ts
export default defineNuxtConfig({
  unhead: {
    legacy: true,
  },
})
```

### SPA Loading å±å¹•çš„æ–° DOM ä½ç½®

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

å®¢æˆ·ç«¯æ¸²æŸ“é¡µé¢ï¼ˆ`ssr: false`ï¼‰æ—¶ï¼ŒåŠ è½½å±å¹•ï¼ˆé»˜è®¤ä¸º `~/app/spa-loading-template.html`ï¼›Nuxt 4 ä¸­æ”¹ä¸º `~/spa-loading-template.html`ï¼‰æ¸²æŸ“åœ¨ Nuxt åº”ç”¨æ ¹èŠ‚ç‚¹å†…ï¼š

```html
<div id="__nuxt">
  <!-- spa loading template -->
</div>
```

ç°åœ¨ï¼ŒåŠ è½½å±å¹•é»˜è®¤æ¸²æŸ“åœ¨ Nuxt åº”ç”¨æ ¹èŠ‚ç‚¹æ—è¾¹ï¼š

```html
<div id="__nuxt"></div>
<!-- spa loading template -->
```

#### å˜æ›´åŸå› 

è¿™æ ·èƒ½ä¿è¯åŠ è½½å±å¹•åœ¨ Vue åº”ç”¨ Suspense è§£æå®Œå‰ä¸€ç›´å­˜åœ¨ï¼Œé¿å…å‡ºç°é—ªç™½ã€‚

#### è¿ç§»æ­¥éª¤

å¦‚æœæ‚¨æ›¾ç”¨ CSS æˆ– `document.querySelector` å®šä½åŠ è½½å±å¹•å…ƒç´ ï¼Œè¯·æ›´æ–°é€‰æ‹©å™¨ã€‚æ‚¨å¯ä»¥åˆ©ç”¨æ–°çš„ `app.spaLoaderTag` å’Œ `app.spaLoaderAttrs` é…ç½®è¾…åŠ©å®šä½ã€‚

æˆ–è€…ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®æ¢å¤è‡³æ—§è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    spaLoadingTemplateLocation: 'within',
  },
})
```

### è§£æåçš„ `error.data`

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

ä¹‹å‰æŠ›å‡ºçš„é”™è¯¯å¯¹è±¡ä¸­è‹¥æœ‰ `data` å±æ€§ï¼Œæœªè‡ªåŠ¨è§£æã€‚ç°åœ¨å·²è‡ªåŠ¨è§£æå¹¶å¯é€šè¿‡é”™è¯¯å¯¹è±¡è®¿é—®ã€‚è™½ç„¶æ­¤ä¸ºä¿®å¤ï¼Œä½†å¦‚æœæ‚¨ä¾èµ–æ—§è¡Œä¸ºå¹¶æ‰‹åŠ¨è§£æï¼Œä¼šå±äºç ´åæ€§å˜æ›´ã€‚

#### è¿ç§»æ­¥éª¤

æ›´æ–°è‡ªå®šä¹‰ `error.vue`ï¼Œåˆ é™¤å¯¹ `error.data` çš„é¢å¤–è§£æï¼š

```diff
  <script setup lang="ts">
  import type { NuxtError } from '#app'

  const props = defineProps({
    error: Object as () => NuxtError
  })

- const data = JSON.parse(error.data)
+ const data = error.data
  </script>
```

### æ›´ç»†ç²’åº¦çš„å†…è”æ ·å¼

ğŸš¦ **å½±å“çº§åˆ«**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

Nuxt ç°åœ¨ä»…å¯¹ Vue ç»„ä»¶çš„æ ·å¼è¿›è¡Œå†…è”ï¼Œä¸å†å†…è”å…¨å±€ CSSã€‚

ä¹‹å‰ï¼ŒNuxt ä¼šå†…è”åŒ…æ‹¬å…¨å±€æ ·å¼åœ¨å†…çš„æ‰€æœ‰ CSS å¹¶ç§»é™¤é’ˆå¯¹å•ç‹¬ CSS æ–‡ä»¶çš„ `<link>`ï¼Œç°åœ¨åªå¯¹ Vue ç»„ä»¶ç›¸å…³ CSS å†…è”ï¼ˆæ­¤å‰è¿™äº›æ ·å¼ä¼šäº§ç”Ÿç‹¬ç«‹çš„ CSS Chunkï¼‰ã€‚è¿™èƒ½æ›´å¥½åœ°å¹³è¡¡å‡å°‘ç½‘ç»œè¯·æ±‚æ•°é‡ï¼ˆé¦–å±åŠ è½½æ—¶ä¸ä¼šä¸ºæ¯ä¸ªé¡µé¢æˆ–ç»„ä»¶å•ç‹¬è¯·æ±‚ `.css` æ–‡ä»¶ï¼‰ã€å…¨å±€ CSS ç¼“å­˜å’Œå‡å°‘åˆå§‹è¯·æ±‚ä½“ç§¯ã€‚

#### è¿ç§»æ­¥éª¤

æ­¤ç‰¹æ€§å¯é€šè¿‡é…ç½®å®Œå…¨æ§åˆ¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡è®¾ç½® `inlineStyles: true` æ¢å¤ä¹‹å‰çš„è¡Œä¸ºï¼Œå³å¯¹å…¨å±€ CSS ä¹Ÿè¿›è¡Œå†…è”ï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  features: {
    inlineStyles: true,
  },
})
```

### è§£æåæ‰«æé¡µé¢å…ƒæ•°æ®

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

æˆ‘ä»¬ç°åœ¨åœ¨è°ƒç”¨ `pages:extend` é’©å­ä¹‹åæ‰«æé¡µé¢å…ƒæ•°æ®ï¼ˆåœ¨ `definePageMeta` ä¸­å®šä¹‰ï¼‰ï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„è°ƒç”¨ä¹‹å‰ã€‚

#### å˜æ›´åŸå› 

è¿™æ ·åšæ˜¯ä¸ºäº†å…è®¸æ‰«æç”¨æˆ·å¸Œæœ›åœ¨ `pages:extend` ä¸­æ·»åŠ çš„é¡µé¢çš„å…ƒæ•°æ®ã€‚æˆ‘ä»¬ä»ç„¶æä¾›äº†ä¸€ä¸ªæœºä¼šï¼Œå³åœ¨æ–°çš„ `pages:resolved` é’©å­ä¸­æ›´æ”¹æˆ–è¦†ç›–é¡µé¢å…ƒæ•°æ®ã€‚

#### è¿ç§»æ­¥éª¤

å¦‚æœä½ æƒ³è¦†ç›–é¡µé¢å…ƒæ•°æ®ï¼Œè¯·åœ¨ `pages:resolved` ä¸­è¿›è¡Œï¼Œè€Œä¸æ˜¯åœ¨ `pages:extend` ä¸­ã€‚

```diff
  export default defineNuxtConfig({
    hooks: {
-     'pages:extend'(pages) {
+     'pages:resolved'(pages) {
        const myPage = pages.find(page => page.path === '/')
        myPage.meta ||= {}
        myPage.meta.layout = 'overridden-layout'
      }
    }
  })
```

æˆ–è€…ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¢å¤ä¹‹å‰çš„è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    scanPageMeta: true,
  },
})
```

### å…±äº«é¢„æ¸²æŸ“æ•°æ®

ğŸš¦ **å½±å“çº§åˆ«**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

æˆ‘ä»¬å¯ç”¨äº†ä¸€ä¸ªå…ˆå‰çš„å®éªŒåŠŸèƒ½ï¼Œç”¨äºåœ¨ä¸åŒé¡µé¢é—´å…±äº« `useAsyncData` å’Œ `useFetch` è°ƒç”¨çš„æ•°æ®ã€‚è¯¦è§[åŸå§‹ PR](https://github.com/nuxt/nuxt/pull/24894)ã€‚

#### å˜æ›´åŸå› 

è¯¥åŠŸèƒ½ä¼šè‡ªåŠ¨åœ¨é¢„æ¸²æŸ“é¡µé¢ä¹‹é—´å…±äº«è´Ÿè½½ä¸­çš„ _æ•°æ®_ã€‚è¿™åœ¨é¢„æ¸²æŸ“ä½¿ç”¨ `useAsyncData` æˆ– `useFetch` å¹¶åœ¨ä¸åŒé¡µé¢è¯·æ±‚ç›¸åŒæ•°æ®çš„ç«™ç‚¹æ—¶ï¼Œèƒ½æ˜¾è‘—æå‡æ€§èƒ½ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„ç«™ç‚¹åœ¨æ¯ä¸ªé¡µé¢éƒ½éœ€è¦è°ƒç”¨ `useFetch`ï¼ˆæ¯”å¦‚ç”¨äºè·å–èœå•å¯¼èˆªæ•°æ®ï¼Œæˆ– CMS ä¸­çš„ç«™ç‚¹è®¾ç½®ï¼‰ï¼Œè¿™äº›æ•°æ®ä¼šåœ¨é¦–æ¬¡é¢„æ¸²æŸ“ä½¿ç”¨å®ƒçš„é¡µé¢æ—¶åªè¢«è¯·æ±‚ä¸€æ¬¡ï¼Œå¹¶ç¼“å­˜èµ·æ¥ç”¨äºå…¶ä»–é¡µé¢çš„é¢„æ¸²æŸ“ã€‚

#### è¿ç§»æ­¥éª¤

ç¡®ä¿ä½ æ•°æ®çš„å”¯ä¸€é”®æ€»æ˜¯èƒ½è§£æåˆ°ç›¸åŒçš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä½¿ç”¨ `useAsyncData` è¯·æ±‚ä¸ç‰¹å®šé¡µé¢ç›¸å…³çš„æ•°æ®ï¼Œåº”æä¾›ä¸€ä¸ªå”¯ä¸€åŒ¹é…è¯¥æ•°æ®çš„é”®ã€‚ï¼ˆ`useFetch` ä¼šè‡ªåŠ¨ä¸ºä½ å¤„ç†ï¼‰

```ts [app/pages/test/[slug\\].vue]
// åœ¨åŠ¨æ€é¡µé¢ï¼ˆä¾‹å¦‚ `[slug].vue`ï¼‰ä¸­ï¼Œè¿™æ ·ä½¿ç”¨æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºè·¯ç”±çš„ slug ä¼šå½±å“è¯·æ±‚çš„æ•°æ®ï¼Œ
// è€Œ Nuxt æ— æ³•æ„ŸçŸ¥è¿™ä¸€ç‚¹ï¼Œå› ä¸ºå®ƒæœªåæ˜ åœ¨ key ä¸­ã€‚
const route = useRoute()
const { data } = await useAsyncData(async () => {
  return await $fetch(`/api/my-page/${route.params.slug}`)
})
// æ­£ç¡®åšæ³•æ˜¯ä½¿ç”¨å”¯ä¸€æ ‡è¯†è¯·æ±‚æ•°æ®çš„ keyã€‚
const { data } = await useAsyncData(route.params.slug, async () => {
  return await $fetch(`/api/my-page/${route.params.slug}`)
})
```

æˆ–è€…ï¼Œä½ å¯ä»¥ç¦ç”¨æ­¤åŠŸèƒ½ï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    sharedPrerenderData: false,
  },
})
```

### `useAsyncData` å’Œ `useFetch` ä¸­é»˜è®¤çš„ `data` å’Œ `error` å€¼

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

ä» `useAsyncData` è¿”å›çš„ `data` å’Œ `error` å¯¹è±¡é»˜è®¤ç°åœ¨ä¸º `undefined`ã€‚

#### å˜æ›´åŸå› 

ä¹‹å‰ `data` åˆå§‹åŒ–ä¸º `null`ï¼Œä½†åœ¨ `clearNuxtData` ä¸­è¢«é‡ç½®ä¸º `undefined`ã€‚`error` åˆå§‹åŒ–ä¸º `null`ã€‚æ­¤æ›´æ”¹æ—¨åœ¨æå‡ä¸€è‡´æ€§ã€‚

#### è¿ç§»æ­¥éª¤

å¦‚æœä½ ä¹‹å‰æ£€æŸ¥è¿‡ `data.value` æˆ– `error.value` æ˜¯å¦ä¸º `null`ï¼Œå¯ä»¥æ”¹ä¸ºæ£€æŸ¥å…¶æ˜¯å¦ä¸º `undefined`ã€‚

::tip
ä½ å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/default-data-error-value` è‡ªåŠ¨å®Œæˆæ­¤æ­¥éª¤
::

### ç§»é™¤è°ƒç”¨ `useAsyncData` å’Œ `useFetch` çš„ `refresh` æ—¶ `dedupe` é€‰é¡¹çš„å¸ƒå°”å€¼æ”¯æŒ

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

ä¹‹å‰è°ƒç”¨ `refresh` æ—¶å¯ä»¥ä¼ é€’ `dedupe: boolean`ã€‚å®ƒä»¬æ˜¯ `cancel`ï¼ˆ`true`ï¼‰å’Œ `defer`ï¼ˆ`false`ï¼‰çš„åˆ«åã€‚

```ts twoslash [app/app.vue]
// @errors: 2322
const { refresh } = await useAsyncData(() => Promise.resolve({ message: 'Hello, Nuxt!' }))

async function refreshData () {
  await refresh({ dedupe: true })
}
```

#### å˜æ›´åŸå› 

ä¸ºäº†æ›´æ¸…æ™°ï¼Œæˆ‘ä»¬ç§»é™¤äº†è¿™äº›å¸ƒå°”åˆ«åã€‚

è¯¥é—®é¢˜äº§ç”Ÿäºä¸º `useAsyncData` æ·»åŠ  `dedupe` é€‰é¡¹æ—¶ï¼Œå¸ƒå°”å€¼æœ€ç»ˆå˜æˆäº†ç›¸åçš„å«ä¹‰ã€‚

`refresh({ dedupe: false })` è¡¨ç¤º **ä¸å–æ¶ˆç°æœ‰è¯·æ±‚ä»¥ä¼˜å…ˆæ‰§è¡Œè¯¥è¯·æ±‚**ã€‚ä½†åœ¨ `useAsyncData` é€‰é¡¹ä¸­ä¼ é€’ `dedupe: true` è¡¨ç¤º **è‹¥å·²æœ‰æŒ‚èµ·è¯·æ±‚åˆ™ä¸å‘èµ·æ–°è¯·æ±‚**ã€‚ï¼ˆè¯¦è§[PR](https://github.com/nuxt/nuxt/pull/24564#pullrequestreview-1764584361)ï¼‰

#### è¿ç§»æ­¥éª¤

è¿ç§»å¾ˆç®€å•ï¼š

```diff
  const { refresh } = await useAsyncData(async () => ({ message: 'Hello, Nuxt 3!' }))
  
  async function refreshData () {
-   await refresh({ dedupe: true })
+   await refresh({ dedupe: 'cancel' })

-   await refresh({ dedupe: false })
+   await refresh({ dedupe: 'defer' })
  }
```

::tip
ä½ å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/deprecated-dedupe-value` è‡ªåŠ¨å®Œæˆæ­¤æ­¥éª¤
::

### åœ¨ `useAsyncData` å’Œ `useFetch` ä¸­æ¸…ç©º `data` æ—¶å°Šé‡é»˜è®¤å€¼

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

å¦‚æœä½ ä¸º `useAsyncData` æä¾›äº†è‡ªå®šä¹‰çš„ `default` å€¼ï¼Œè°ƒç”¨ `clear` æˆ– `clearNuxtData` æ—¶ï¼Œå°†ä¼šç”¨è¯¥é»˜è®¤å€¼é‡ç½®ï¼Œè€Œä¸åªæ˜¯ç®€å•åœ°ç½®ä¸ºç©ºã€‚

#### å˜æ›´åŸå› 

ç”¨æˆ·é€šå¸¸ä¼šè®¾ç½®åˆé€‚çš„ç©ºå€¼ï¼ˆå¦‚ç©ºæ•°ç»„ï¼‰ï¼Œä»¥é¿å…åœ¨éå†æ—¶æ£€æŸ¥ `null` æˆ– `undefined`ã€‚æ¸…ç©ºæ•°æ®æ—¶åº”å°Šé‡è¿™ä¸€è®¾å®šã€‚

### `useAsyncData` å’Œ `useFetch` ä¸­ `pending` å€¼çš„å¯¹é½

ğŸš¦ **å½±å“çº§åˆ«**ï¼šä¸­ç­‰

`useAsyncData`ã€`useFetch`ã€`useLazyAsyncData` å’Œ `useLazyFetch` è¿”å›çš„ `pending` ç°åœ¨æ˜¯è®¡ç®—å±æ€§ï¼Œä»…åœ¨ `status` ä¹Ÿå¤„äºæŒ‚èµ·çŠ¶æ€æ—¶ä¸º `true`ã€‚

#### å˜åŒ–å†…å®¹

å½“ä¼ å…¥ `immediate: false` æ—¶ï¼Œ`pending` ä¼šåœ¨é¦–æ¬¡è¯·æ±‚å‘èµ·å‰ä¿æŒä¸º `false`ï¼Œè¿™ä¸ä¹‹å‰çš„è¡Œä¸ºä¸åŒï¼ˆä¹‹å‰é¦–æ¬¡è¯·æ±‚å‰ `pending` æ€»æ˜¯ä¸º `true`ï¼‰ã€‚

#### å˜æ›´åŸå› 

æ­¤å˜æ›´ä½¿ `pending` çš„å«ä¹‰ä¸ `status` å±æ€§ä¸€è‡´ï¼Œå½“è¯·æ±‚è¿›è¡Œæ—¶ä¸¤è€…å‡ä¸ºæŒ‚èµ·çŠ¶æ€ã€‚

#### è¿ç§»æ­¥éª¤

å¦‚æœä¾èµ– `pending` å±æ€§ï¼Œè¯·ç¡®ä¿é€»è¾‘è€ƒè™‘åˆ°æ–°è¡Œä¸ºï¼Œå³ `pending` ä»…åœ¨ `status` ä¹Ÿå¤„äºæŒ‚èµ·æ—¶ä¸º `true`ã€‚

```diff
  <template>
-   <div v-if="!pending">
+   <div v-if="status === 'success'">
      <p>Data: {{ data }}</p>
    </div>
    <div v-else>
      <p>Loading...</p>
    </div>
  </template>
  <script setup lang="ts">
  const { data, pending, execute, status } = await useAsyncData(() => fetch('/api/data'), {
    immediate: false
  })
  onMounted(() => execute())
  </script>
```

ä½ ä¹Ÿå¯ä»¥æš‚æ—¶ä½¿ç”¨ä¸‹åˆ—é…ç½®æ¢å¤æ—§è¡Œä¸ºï¼š

```ts twoslash [nuxt.config.ts]
export default defineNuxtConfig({
  experimental: {
    pendingWhenIdle: true,
  },
})
```

### `useAsyncData` å’Œ `useFetch` ä¸­ key å˜æ›´è¡Œä¸º

ğŸš¦ **å½±å“çº§åˆ«**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

åœ¨ `useAsyncData` æˆ– `useFetch` ä¸­ä½¿ç”¨å“åº”å¼ key æ—¶ï¼Œå½“ key å˜åŒ–ä¼šè‡ªåŠ¨é‡æ–°è¯·æ±‚æ•°æ®ã€‚è®¾ç½® `immediate: false` æ—¶ï¼Œ`useAsyncData` åªæœ‰åœ¨æ•°æ®å·²è¯·æ±‚è¿‡ä¸€æ¬¡åï¼Œkey å˜åŒ–æ‰ä¼šé‡æ–°è¯·æ±‚ã€‚

ä¹‹å‰ï¼Œ`useFetch` çš„è¡Œä¸ºç•¥æœ‰ä¸åŒï¼Œä¼šåœ¨ key å˜åŒ–æ—¶å§‹ç»ˆè¯·æ±‚æ•°æ®ã€‚

ç°ä»Šï¼Œ`useFetch` ä¸ `useAsyncData` è¡Œä¸ºä¸€è‡´ â€”â€” åªæœ‰åœ¨æ•°æ®å·²è¯·æ±‚è¿‡ä¸€æ¬¡åï¼Œkey å˜åŒ–æ‰é‡æ–°è¯·æ±‚ã€‚

#### å˜æ›´åŸå› 

ä¿è¯ `useAsyncData` ä¸ `useFetch` è¡Œä¸ºä¸€è‡´ï¼Œé¿å…æ„å¤–è¯·æ±‚ã€‚

è‹¥è®¾ç½®äº† `immediate: false`ï¼Œéœ€è°ƒç”¨ `refresh` æˆ– `execute`ï¼Œå¦åˆ™æ•°æ®æ°¸è¿œä¸ä¼šè¢«è¯·æ±‚ã€‚

#### è¿ç§»æ­¥éª¤

æ­¤æ›´æ”¹ä¸€èˆ¬æå‡é¢„æœŸè¡Œä¸ºï¼Œä½†å¦‚æœä½ æœŸæœ›åœ¨éç«‹å³åŠ è½½çš„ `useFetch` ä¸­é€šè¿‡æ”¹å˜ key æˆ–é€‰é¡¹è‡ªåŠ¨è¯·æ±‚ï¼Œç°åœ¨éœ€è¦æ‰‹åŠ¨é¦–æ¬¡è§¦å‘ã€‚

```diff
  const id = ref('123')
  const { data, execute } = await useFetch('/api/test', {
    query: { id },
    immediate: false
  )
+ watch(id, () => execute(), { once: true })
```

è‹¥å¸Œæœ›ç¦ç”¨æ­¤è¡Œä¸ºï¼š

```ts
// æˆ–åœ¨ Nuxt é…ç½®ä¸­å…¨å±€ç¦ç”¨
export default defineNuxtConfig({
  experimental: {
    alwaysRunFetchOnKeyChange: true,
  },
})
```

### `useAsyncData` å’Œ `useFetch` ä¸­æ•°æ®æµ…å±‚å“åº”æ€§

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

ä» `useAsyncData`ã€`useFetch`ã€`useLazyAsyncData` å’Œ `useLazyFetch` è¿”å›çš„ `data` å¯¹è±¡ç°åœ¨æ˜¯ `shallowRef`ï¼Œè€Œéæ™®é€šçš„ `ref`ã€‚

#### å˜åŒ–å†…å®¹

æ–°æ•°æ®åˆ°è¾¾æ—¶ï¼Œä¾èµ– `data` çš„å†…å®¹ä»ç„¶æ˜¯å“åº”çš„ï¼Œå› ä¸ºæ•´ä¸ªå¯¹è±¡è¢«æ›¿æ¢ã€‚ä½†å¦‚æœä»£ç ä¿®æ”¹æ•°æ®å¯¹è±¡å†…çš„å±æ€§ï¼Œåˆ™ä¸ä¼šè§¦å‘å“åº”æ€§æ›´æ–°ã€‚

#### å˜æ›´åŸå› 

è¿™å¯¹æ·±å±‚åµŒå¥—çš„å¯¹è±¡å’Œæ•°ç»„å¸¦æ¥**æ˜¾è‘—**çš„æ€§èƒ½æå‡ï¼Œå› ä¸º Vue ä¸å¿…ç›‘æ§æ¯ä¸ªå±æ€§æˆ–æ•°ç»„é¡¹ã€‚ä¸”é€šå¸¸ `data` åº”è¯¥æ˜¯ä¸å¯å˜çš„ã€‚

#### è¿ç§»æ­¥éª¤

å¤§å¤šæ•°æƒ…å†µä¸‹æ— éœ€å˜åŒ–ï¼Œä½†è‹¥ä½ ä¾èµ–æ•°æ®å¯¹è±¡å†…éƒ¨çš„å“åº”æ€§ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

1. åœ¨å…·ä½“çš„ç»„åˆå¼å‡½æ•°è°ƒç”¨æ—¶å¼€å¯æ·±å±‚å“åº”æ€§ï¼š

   ```diff
   - const { data } = useFetch('/api/test')
   + const { data } = useFetch('/api/test', { deep: true })
   ```

2. åœ¨é¡¹ç›®ä¸­å…¨å±€æ›´æ”¹é»˜è®¤è¡Œä¸ºï¼ˆä¸æ¨èï¼‰ï¼š

   ```ts twoslash [nuxt.config.ts]
   export default defineNuxtConfig({
     experimental: {
       defaults: {
         useAsyncData: {
           deep: true,
         },
       },
     },
   })
   ```

::tip
ä½ å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/shallow-function-reactivity` è‡ªåŠ¨å®Œæˆæ­¤æ­¥éª¤
::

### `builder:watch` ä¸­ä½¿ç”¨ç»å¯¹è·¯å¾„ç›‘å¬

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

Nuxt çš„ `builder:watch` é’©å­ç°åœ¨å‘å‡ºçš„è·¯å¾„æ˜¯ç»å¯¹è·¯å¾„ï¼Œè€Œä¸æ˜¯ç›¸å¯¹äºé¡¹ç›® `srcDir` çš„ç›¸å¯¹è·¯å¾„ã€‚

#### å˜æ›´åŸå› 

æ­¤å˜æ›´æ”¯æŒç›‘å¬ `srcDir` å¤–çš„è·¯å¾„ï¼Œä»¥åŠæ›´å¥½åœ°æ”¯æŒå›¾å±‚ç­‰å¤æ‚æ¨¡å¼ã€‚

#### è¿ç§»æ­¥éª¤

æˆ‘ä»¬å·²ä¸»åŠ¨è¿ç§»äº†å·²çŸ¥ä½¿ç”¨è¯¥é’©å­çš„å®˜æ–¹ Nuxt æ¨¡å—ï¼Œè¯¦è§ [issue #25339](https://github.com/nuxt/nuxt/issues/25339)ã€‚

å¦‚æœä½ æ˜¯æ¨¡å—ä½œè€…å¹¶æƒ³å…¼å®¹ Nuxt v3 å’Œ Nuxt v4ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢ä»£ç é€‚é…è·¯å¾„ï¼š

```diff
+ import { relative, resolve } from 'node:fs'
  // ...
  nuxt.hook('builder:watch', async (event, path) => {
+   path = relative(nuxt.options.srcDir, resolve(nuxt.options.srcDir, path))
    // ...
  })
```

::tip
ä½ å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/absolute-watch-path` è‡ªåŠ¨å®Œæˆæ­¤æ­¥éª¤
::

### ç§»é™¤ `window.__NUXT__` å¯¹è±¡

#### å˜åŒ–å†…å®¹

åœ¨åº”ç”¨å®Œæˆ hydration åï¼Œæˆ‘ä»¬ç§»é™¤äº†å…¨å±€çš„ `window.__NUXT__` å¯¹è±¡ã€‚

#### å˜æ›´åŸå› 

è¿™ä¸ºå¤šåº”ç”¨æ¨¡å¼ï¼ˆ[#21635](https://github.com/nuxt/nuxt/issues/21635)ï¼‰é“ºå¹³é“è·¯ï¼Œå¹¶è®©æˆ‘ä»¬ä¸“æ³¨äºè®¿é—® Nuxt åº”ç”¨æ•°æ®çš„å”¯ä¸€é€”å¾„ â€”â€” `useNuxtApp()`ã€‚

#### è¿ç§»æ­¥éª¤

è¿™ä¸ªæ•°æ®ä»ç„¶å¯ç”¨ï¼Œä½†éœ€è¦é€šè¿‡ `useNuxtApp().payload` è®¿é—®ï¼š

```diff
- console.log(window.__NUXT__)
+ console.log(useNuxtApp().payload)
```

### ç›®å½•ç´¢å¼•æ‰«æ

ğŸš¦ **å½±å“çº§åˆ«**ï¼šä¸­ç­‰

#### å˜åŒ–å†…å®¹

`app/middleware/` æ–‡ä»¶å¤¹å†…çš„å­æ–‡ä»¶å¤¹ä¹Ÿä¼šè¢«æ‰«æå…¶ `index` æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¹Ÿä¼šè¢«æ³¨å†Œä¸ºé¡¹ç›®ä¸­é—´ä»¶ã€‚

#### å˜æ›´åŸå› 

Nuxt ä¼šè‡ªåŠ¨æ‰«æå¤šä¸ªæ–‡ä»¶å¤¹ï¼ŒåŒ…æ‹¬ `app/middleware/` å’Œ `app/plugins/`ã€‚

`app/plugins/` çš„å­æ–‡ä»¶å¤¹ä¼šæ‰«æå…¶ `index` æ–‡ä»¶ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ‰«æç›®å½•æ—¶è¡Œä¸ºä¿æŒä¸€è‡´ã€‚

#### è¿ç§»æ­¥éª¤

é€šå¸¸æ— éœ€è¿ç§»ï¼Œä½†è‹¥æƒ³æ¢å¤ä¹‹å‰è¡Œä¸ºï¼Œå¯ä»¥æ·»åŠ é’©å­è¿‡æ»¤æ‰è¿™äº›ä¸­é—´ä»¶ï¼š

```ts
export default defineNuxtConfig({
  hooks: {
    'app:resolve' (app) {
      app.middleware = app.middleware.filter(mw => !/\/index\.[^/]+$/.test(mw.path))
    },
  },
})
```

### æ¨¡æ¿ç¼–è¯‘æ›´æ”¹

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

ä¹‹å‰ Nuxt ä½¿ç”¨ `lodash/template` ç¼–è¯‘ä½äºæ–‡ä»¶ç³»ç»Ÿã€é‡‡ç”¨ `.ejs` æ–‡ä»¶æ ¼å¼/è¯­æ³•çš„æ¨¡æ¿ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†ä¸€äº›æ¨¡æ¿å·¥å…·å‡½æ•°ï¼ˆå¦‚ `serialize`ã€`importName`ã€`importSources`ï¼‰ï¼Œç”¨äºè¿™äº›æ¨¡æ¿ä¸­çš„ä»£ç ç”Ÿæˆï¼Œä½†ç°åœ¨ä¸å†æä¾›ã€‚

#### å˜æ›´åŸå› 

åœ¨ Nuxt v3 ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†æ›´çµæ´»é«˜æ•ˆçš„â€œè™šæ‹Ÿâ€è¯­æ³•å’Œ `getContents()` å‡½æ•°ã€‚

å¦å¤–ï¼Œ`lodash/template` æ›¾å‡ºç°å¤šæ¬¡å®‰å…¨é—®é¢˜ï¼Œå°½ç®¡å¯¹ Nuxt é¡¹ç›®å½±å“ä¸å¤§ï¼ˆæ„å»ºæ—¶ä½¿ç”¨ï¼Œéè¿è¡Œæ—¶ï¼Œä¸”å¯ä¿¡ä»£ç ï¼‰ï¼Œä½†ä»ä¼šåœ¨å®‰å…¨å®¡è®¡ä¸­å‡ºç°ã€‚`lodash` æœ¬èº«ä¾èµ–è¾ƒé‡ï¼Œå¤šæ•°é¡¹ç›®å¹¶æœªç”¨åˆ°ã€‚

æœ€åï¼Œç›´æ¥åœ¨ Nuxt å†…ç½®ä»£ç åºåˆ—åŒ–å‡½æ•°ä¸ç†æƒ³ã€‚æ›´æ¨èä½¿ç”¨å¦‚ [unjs/knitwork](http://github.com/unjs/knitwork) è¿™ç±»é¡¹ç›®ï¼Œå®ƒä»¬å¯ä»¥ä½œä¸ºä½ çš„é¡¹ç›®ä¾èµ–ï¼Œåœ¨é‚£é‡Œå¯ä»¥ç›´æ¥ä¸ŠæŠ¥å’Œä¿®å¤å®‰å…¨é—®é¢˜ï¼Œæ— éœ€æ›´æ–° Nuxtã€‚

#### è¿ç§»æ­¥éª¤

æˆ‘ä»¬å·²é’ˆå¯¹ä½¿ç”¨ EJS è¯­æ³•çš„æ¨¡å—æäº¤äº† PRï¼Œä½†å¦‚æœä½ éœ€è¦è‡ªè¡Œå¤„ç†ï¼Œæœ‰ä¸‰ç§å…¼å®¹æ–¹æ¡ˆï¼š

- å°†å­—ç¬¦ä¸²æ’å€¼é€»è¾‘ç›´æ¥å†™å…¥ `getContents()`ã€‚
- ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°å¤„ç†æ›¿æ¢ï¼Œå¦‚ https://github.com/nuxt-modules/color-mode/pull/240ã€‚
- ç”¨ `es-toolkit/compat`ï¼ˆlodash template çš„æ›¿ä»£å“ï¼‰ä½œä¸ºä½ é¡¹ç›®çš„ä¾èµ–ï¼Œè€Œé Nuxtï¼š

```diff
+ import { readFileSync } from 'node:fs'
+ import { template } from 'es-toolkit/compat'
  // ...
  addTemplate({
    fileName: 'appinsights-vue.js'
    options: { /* some options */ },
-   src: resolver.resolve('./runtime/plugin.ejs'),
+   getContents({ options }) {
+     const contents = readFileSync(resolver.resolve('./runtime/plugin.ejs'), 'utf-8')
+     return template(contents)({ options })
+   },
  })
```

æœ€åï¼Œå¦‚æœä½ ä½¿ç”¨äº†æ¨¡æ¿å·¥å…·å‡½æ•°ï¼ˆå¦‚ `serialize`ã€`importName`ã€`importSources`ï¼‰ï¼Œå¯ä»¥ç”¨ `knitwork` æ›¿ä»£ï¼š

```ts
import { genDynamicImport, genImport, genSafeVariableName } from 'knitwork'

const serialize = (data: any) => JSON.stringify(data, null, 2).replace(/"\{(.+)\}"(?=,?$)/gm, r => JSON.parse(r).replace(/^\{(.*)\}$/, '$1'))

const importSources = (sources: string | string[], { lazy = false } = {}) => {
  return toArray(sources).map((src) => {
    if (lazy) {
      return `const ${genSafeVariableName(src)} = ${genDynamicImport(src, { comment: `webpackChunkName: ${JSON.stringify(src)}` })}`
    }
    return genImport(src, genSafeVariableName(src))
  }).join('\n')
}

const importName = genSafeVariableName
```

::tip
ä½ å¯ä»¥é€šè¿‡è¿è¡Œ `npx codemod@latest nuxt/4/template-compilation-changes` è‡ªåŠ¨å®Œæˆæ­¤æ­¥éª¤
::

### é»˜è®¤ TypeScript é…ç½®æ›´æ”¹

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

`compilerOptions.noUncheckedIndexedAccess` é»˜è®¤å€¼ç”± `false` æ”¹ä¸º `true`ã€‚

#### å˜æ›´åŸå› 

è¿™æ˜¯ä¹‹å‰ [3.12 é…ç½®æ›´æ–°](https://github.com/nuxt/nuxt/pull/27485) çš„åç»­ï¼Œæ”¹è¿›äº†é»˜è®¤é…ç½®ï¼Œä¸»è¦éµå¾ª [TotalTypeScript çš„å»ºè®®](https://www.totaltypescript.com/tsconfig-cheat-sheet)ã€‚

#### è¿ç§»æ­¥éª¤

ä¸¤ç§æ–¹æ¡ˆï¼š

1. å¯¹åº”ç”¨è¿è¡Œç±»å‹æ£€æŸ¥å¹¶ä¿®å¤æ–°æŠ¥é”™ï¼ˆæ¨èï¼‰ã€‚

2. åœ¨ `nuxt.config.ts` ä¸­è¦†å†™é»˜è®¤é…ç½®ï¼š

   <!-- @case-police-ignore tsConfig -->

   ```ts
   export default defineNuxtConfig({
     typescript: {
       tsConfig: {
         compilerOptions: {
           noUncheckedIndexedAccess: false,
         },
       },
     },
   })
   ```

### TypeScript é…ç½®æ‹†åˆ†

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

Nuxt ç°ä¸ºä¸åŒç¯å¢ƒç”Ÿæˆç‹¬ç«‹çš„ TypeScript é…ç½®æ–‡ä»¶ï¼Œæå‡ç±»å‹æ£€æµ‹ä½“éªŒï¼š

1. **æ–°çš„ TypeScript é…ç½®æ–‡ä»¶**ï¼š
   - `.nuxt/tsconfig.app.json` - ç”¨äºåº”ç”¨ä»£ç ï¼ˆVue ç»„ä»¶ã€ç»„åˆå¼å‡½æ•°ç­‰ï¼‰
   - `.nuxt/tsconfig.server.json` - ç”¨äºæœåŠ¡ç«¯ä»£ç ï¼ˆNitro/server ç›®å½•ï¼‰
   - `.nuxt/tsconfig.node.json` - ç”¨äºæ„å»ºæ—¶ä»£ç ï¼ˆæ¨¡å—ã€`nuxt.config.ts` ç­‰ï¼‰
   - `.nuxt/tsconfig.shared.json` - ç”¨äºå…±äº«ä»£ç ï¼ˆå¦‚ç±»å‹å’Œéç¯å¢ƒä¾èµ–å·¥å…·ï¼‰
   - `.nuxt/tsconfig.json` - æ—§ç‰ˆé…ç½®ï¼Œä¿æŒå‘åå…¼å®¹

2. **å‘åå…¼å®¹æ€§**ï¼šæ‰©å±• `.nuxt/tsconfig.json` çš„é¡¹ç›®ç»§ç»­æ­£å¸¸ä½¿ç”¨ã€‚

3. **é¡¹ç›®å¼•ç”¨é€‰é¡¹ï¼ˆProject Referencesï¼‰**ï¼šæ–°é¡¹ç›®æˆ–éœ€è¦æ›´å¥½ç±»å‹æ£€æŸ¥çš„å¯ä»¥é‡‡ç”¨ã€‚

4. **é’ˆå¯¹ä¸åŒç¯å¢ƒçš„ä¸Šä¸‹æ–‡ç±»å‹æ£€æŸ¥**ï¼šæ¯ä¸ªç¯å¢ƒéƒ½æ‹¥æœ‰åˆé€‚çš„ç¼–è¯‘é€‰é¡¹å’ŒåŒ…å«/æ’é™¤è§„åˆ™ã€‚

5. **æ–°å¢ `typescript.nodeTsConfig` é€‰é¡¹**ï¼šå¯å®šåˆ¶ Node.js æ„å»ºæ—¶çš„ TypeScript é…ç½®ã€‚

#### å˜æ›´åŸå› 

æ­¤å˜æ›´å¸¦æ¥å¤šé‡å¥½å¤„ï¼š

1. **æ›´å¥½ç±»å‹å®‰å…¨**ï¼šå„ç¯å¢ƒæ‹¥æœ‰åŒ¹é…çš„å…¨å±€å˜é‡å’Œ API æ£€æŸ¥ã€‚
2. **æå‡ IDE ä½“éªŒ**ï¼šé’ˆå¯¹ä¸åŒä»£ç éƒ¨åˆ†æ›´å¥½çš„æ™ºèƒ½æç¤ºå’Œé”™è¯¯æŠ¥å‘Šã€‚
3. **æ¸…æ™°åˆ†ç¦»**ï¼šé¿å…æœåŠ¡ç«¯ä»£ç è¯¯å¼•ç”¨å®¢æˆ·ç«¯ APIï¼Œåä¹‹äº¦ç„¶ã€‚
4. **æ€§èƒ½æå‡**ï¼šTypeScript å¯æ›´é«˜æ•ˆåœ°æ£€æŸ¥é™å®šèŒƒå›´ä»£ç ã€‚

ä¾‹å¦‚ï¼Œä½ çš„ `nuxt.config.ts` ä¸­ä¸å†æ”¯æŒè‡ªåŠ¨å¯¼å…¥ï¼Œä¹‹å‰ TS ä¸ä¼šæŠ¥é”™ã€‚IDE è™½è¯†åˆ«æœåŠ¡ç«¯ç›®å½•çš„ `tsconfig.json` ï¼Œä½†ç±»å‹æ£€æŸ¥æœªåæ˜ ï¼Œæ­¤å˜åŒ–è¡¥è¶³æ­¤å·®å¼‚ã€‚

#### è¿ç§»æ­¥éª¤

**æ— éœ€è¿ç§»**ï¼Œç°æœ‰é¡¹ç›®ç…§æ—§æ”¯æŒã€‚

è‹¥æƒ³åˆ©ç”¨æ›´å¥½ç±»å‹æ£€æŸ¥ï¼Œå¯é‡‡ç”¨æ–°é¡¹ç›®å¼•ç”¨æ–¹å¼ï¼š

1. æ›´æ–°æ ¹ç›®å½• `tsconfig.json`ï¼Œæ·»åŠ é¡¹ç›®å¼•ç”¨ï¼š

   ::note
   å¦‚æœä½ çš„ `tsconfig.json` å½“å‰æœ‰ä¸€è¡Œ `"extends": "./.nuxt/tsconfig.json"`ï¼Œ**åœ¨æ·»åŠ å¼•ç”¨ä¹‹å‰è¯·åˆ é™¤å®ƒ**ã€‚é¡¹ç›®å¼•ç”¨å’Œæ‰©å±•æ˜¯äº’æ–¥çš„ã€‚
   ::

   ```json
   {
     // Remove "extends": "./.nuxt/tsconfig.json" if present
     "files": [],
     "references": [
       { "path": "./.nuxt/tsconfig.app.json" },
       { "path": "./.nuxt/tsconfig.server.json" },
       { "path": "./.nuxt/tsconfig.shared.json" },
       { "path": "./.nuxt/tsconfig.node.json" }
     ]
   }
   ```

2. ç§»é™¤ä»»ä½•æ‰‹å†™çš„æœåŠ¡å™¨ç«¯ `tsconfig.json`ï¼ˆå¦‚ `server/tsconfig.json`ï¼‰ä¸­å¯¹ `.nuxt/tsconfig.server.json` çš„ç»§æ‰¿ã€‚

3. æ›´æ–°ç±»å‹æ£€æŸ¥è„šæœ¬ä»¥ä½¿ç”¨é¡¹ç›®å¼•ç”¨æ„å»ºï¼š

   ```diff
   - "typecheck": "nuxt prepare && vue-tsc --noEmit"
   + "typecheck": "nuxt prepare && vue-tsc -b --noEmit"
   ```

4. å°†æ‰€æœ‰ç±»å‹å¢å¼ºä»£ç å½’å…¥ç›¸åº”ä¸Šä¸‹æ–‡ï¼š
   - åº”ç”¨ç«¯çš„å¢å¼ºæ”¾å…¥ `app/` ç›®å½•ã€‚
   - æœåŠ¡ç«¯çš„å¢å¼ºæ”¾å…¥ `server/` ç›®å½•ã€‚
   - åº”ç”¨ä¸æœåŠ¡ç«¯å…±äº«çš„å¢å¼ºæ”¾å…¥ `shared/` ç›®å½•ã€‚

    ::warning
    å¢å¼ºä»£ç è‹¥æ”¾åœ¨ `app/`ã€`server/` æˆ– `shared/` ç›®å½•å¤–ï¼Œæ— æ³•å…¼å®¹æ–°é¡¹ç›®å¼•ç”¨æœºåˆ¶ã€‚
    ::

5. å¦‚éœ€å®šåˆ¶ Node.js TypeScript é…ç½®ï¼Œåœ¨é…ç½®ä¸­æ·»åŠ ï¼š

   <!-- @case-police-ignore tsConfig -->

   ```ts
   export default defineNuxtConfig({
     typescript: {
       // å®šåˆ¶ app/server çš„ TypeScript é…ç½®
       tsConfig: {
         compilerOptions: {
           strict: true,
         },
       },
       // å®šåˆ¶æ„å»ºæ—¶çš„ TypeScript é…ç½®
       nodeTsConfig: {
         compilerOptions: {
           strict: true,
         },
       },
     },
   })
   ```

6. æ›´æ–° CI/æ„å»ºè„šæœ¬ï¼Œç¡®ä¿ä½¿ç”¨æ–°é¡¹ç›®å¼•ç”¨æ–¹å¼ã€‚

æ–°é…ç½®ä¸ºå¯é€‰ï¼Œæä¾›äº†æ›´å¥½çš„ç±»å‹å®‰å…¨å’Œæ™ºèƒ½æç¤ºï¼ŒåŒæ—¶å¯¹ç°æœ‰é¡¹ç›®ä¿æŒå®Œæ•´å…¼å®¹ã€‚

### ç§»é™¤å®éªŒæ€§åŠŸèƒ½é…ç½®

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

Nuxt 4 ä¸å†å…è®¸é…ç½®ä»¥ä¸‹å››ä¸ªå®éªŒæ€§åŠŸèƒ½ï¼š

- `experimental.treeshakeClientOnly` å°†é»˜è®¤å¼€å¯ï¼ˆv3.0 ä»¥æ¥å³é»˜è®¤ï¼‰
- `experimental.configSchema` å°†é»˜è®¤å¼€å¯ï¼ˆv3.3 ä»¥æ¥é»˜è®¤ï¼‰
- `experimental.polyfillVueUseHead` å°†é»˜è®¤å…³é—­ï¼ˆv3.4 ä»¥æ¥é»˜è®¤ï¼‰
- `experimental.respectNoSSRHeader` å°†é»˜è®¤å…³é—­ï¼ˆv3.4 ä»¥æ¥é»˜è®¤ï¼‰
- `vite.devBundler` ä¸å†å¯é…ç½®ï¼Œå°†é»˜è®¤ä½¿ç”¨ `vite-node`

#### å˜æ›´åŸå› 

è¿™äº›é€‰é¡¹é•¿æœŸé»˜è®¤å¼€å¯æˆ–å…³é—­ï¼Œæš‚æ— ç†ç”±ä¿ç•™ä¸ºå¯é…ç½®çŠ¶æ€ã€‚

#### è¿ç§»æ­¥éª¤

- `polyfillVueUseHead` å¯é€šè¿‡ç”¨æˆ·æ’ä»¶å®ç°ï¼Œ[ç¤ºä¾‹](https://github.com/nuxt/nuxt/blob/f209158352b09d1986aa320e29ff36353b91c358/packages/nuxt/src/head/runtime/plugins/vueuse-head-polyfill.ts#L10-L11)

- `respectNoSSRHeader` å¯é€šè¿‡æœåŠ¡å™¨ä¸­é—´ä»¶å®ç°ï¼Œ[ç¤ºä¾‹](https://github.com/nuxt/nuxt/blob/c660b39447f0d5b8790c0826092638d321cd6821/packages/nuxt/src/core/runtime/nitro/no-ssr.ts#L8-L9)

### ç§»é™¤é¡¶å±‚ `generate` é…ç½®é¡¹

ğŸš¦ **å½±å“çº§åˆ«**ï¼šæœ€å°

#### å˜åŒ–å†…å®¹

Nuxt 4 ä¸å†æ”¯æŒé¡¶å±‚çš„ `generate` é…ç½®ï¼ŒåŒ…æ‹¬å…¶æ‰€æœ‰å±æ€§ï¼š

- `generate.exclude` â€”â€” æ’é™¤ prerender è·¯ç”±
- `generate.routes` â€”â€” æŒ‡å®š prerender è·¯ç”±

#### å˜æ›´åŸå› 

é¡¶å±‚ `generate` é…ç½®æ˜¯ Nuxt 2 çš„é—ç•™ï¼Œç°å·²ä¼˜å…ˆä½¿ç”¨ `nitro.prerender` é…ç½®ã€‚

#### è¿ç§»æ­¥éª¤

ç”¨å¯¹åº”çš„ `nitro.prerender` é…ç½®æ›¿ä»£ `generate`ï¼š

```diff
export default defineNuxtConfig({
- generate: {
-   exclude: ['/admin', '/private'],
-   routes: ['/sitemap.xml', '/robots.txt']
- }
+ nitro: {
+   prerender: {
+     ignore: ['/admin', '/private'],
+     routes: ['/sitemap.xml', '/robots.txt']
+   }
+ }
})
```

::read-more{to="https://nitro.zhcndoc.com/config#prerender"}
äº†è§£æ›´å¤š Nitro prerender é…ç½®é€‰é¡¹ã€‚
::

## Nuxt 2 ä¸ Nuxt 3+ æ¯”è¾ƒ

ä¸‹è¡¨ç®€è¦æ¯”è¾ƒäº† Nuxt ä¸‰ä¸ªç‰ˆæœ¬ï¼š

| ç‰¹æ€§ / ç‰ˆæœ¬             | Nuxt 2        | Nuxt Bridge   | Nuxt 3+      |
|------------------------|---------------|--------------|--------------|
| Vue                    | 2             | 2            | 3            |
| ç¨³å®šæ€§                  | ğŸ˜Š ç¨³å®š       | ğŸ˜Š ç¨³å®š       | ğŸ˜Š ç¨³å®š       |
| æ€§èƒ½                    | ğŸ å¿«         | âœˆï¸ æ›´å¿«      | ğŸš€ æœ€å¿«      |
| Nitro å¼•æ“              | âŒ            | âœ…           | âœ…           |
| ESM æ”¯æŒ                | ğŸŒ™ éƒ¨åˆ†æ”¯æŒ   | ğŸ‘ æ”¹è¿›      | âœ…           |
| TypeScript             | â˜‘ï¸ é€‰ç”¨å¼•å…¥   | ğŸš§ éƒ¨åˆ†æ”¯æŒ  | âœ…           |
| ç»„åˆå¼ API              | âŒ            | ğŸš§ éƒ¨åˆ†æ”¯æŒ  | âœ…           |
| é€‰é¡¹å¼ API              | âœ…            | âœ…           | âœ…           |
| ç»„ä»¶è‡ªåŠ¨å¯¼å…¥            | âœ…            | âœ…           | âœ…           |
| `<script setup>` è¯­æ³•   | âŒ            | ğŸš§ éƒ¨åˆ†æ”¯æŒ  | âœ…           |
| è‡ªåŠ¨å¯¼å…¥                | âŒ            | âœ…           | âœ…           |
| webpack                | 4             | 4            | 5            |
| Vite                   | âš ï¸ éƒ¨åˆ†æ”¯æŒ   | ğŸš§ éƒ¨åˆ†æ”¯æŒ  | âœ…           |
| Nuxt CLI               | âŒ è€ç‰ˆ       | âœ… (nuxt)    | âœ… (nuxt)    |
| é™æ€ç«™ç‚¹æ”¯æŒ            | âœ…            | âœ…           | âœ…           |

## Nuxt 2 å‡çº§åˆ° Nuxt 3+

è¿ç§»æŒ‡å—æä¾›äº† Nuxt 2 ä¸ Nuxt 3+ ç‰¹æ€§å¯¹æ¯”ï¼Œå¹¶æŒ‡å¯¼å¦‚ä½•é€‚é…ä½ çš„åº”ç”¨ã€‚

::read-more{to="/docs/4.x/migration/overview"}
æŸ¥çœ‹ **Nuxt 2 åˆ° Nuxt 3 è¿ç§»æŒ‡å—**ã€‚
::

## Nuxt 2 å‡çº§åˆ° Nuxt Bridge

è‹¥æƒ³é€æ­¥è¿ç§» Nuxt 2 åº”ç”¨åˆ° Nuxt 3ï¼Œå¯ä½¿ç”¨ Nuxt Bridgeã€‚å®ƒæ˜¯ä¸€ä¸ªå…¼å®¹å±‚ï¼Œå…è®¸ä½ åœ¨ Nuxt 2 ä¸­ä½¿ç”¨éƒ¨åˆ† Nuxt 3+ ç‰¹æ€§ï¼Œéœ€ä¸»åŠ¨å¼€å¯ã€‚

::read-more{to="/docs/4.x/bridge/overview"}
**ä» Nuxt 2 è¿ç§»åˆ° Nuxt Bridge**
::
