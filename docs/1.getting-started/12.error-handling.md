---
title: '错误处理'
description: '了解如何在 Nuxt 中捕获和处理错误。'
navigation.icon: i-lucide-bug-off
---

Nuxt 是一个全栈框架，这意味着在不同的上下文中可能会发生一些无法预防的运行时用户错误，来源包括：

- 在 Vue 渲染生命周期中的错误（SSR 与 CSR）
- 服务器和客户端启动时的错误（SSR + CSR）
- 在 Nitro 服务器生命周期中的错误（[`server/`](/docs/4.x/guide/directory-structure/server) 目录）
- 下载 JS chunk 时的错误

::tip
**SSR** 表示 **服务器端渲染（Server-Side Rendering）**，**CSR** 表示 **客户端渲染（Client-Side Rendering）**。
::

## Vue 错误

你可以使用 [`onErrorCaptured`](https://vue.zhcndoc.com/api/composition-api-lifecycle.html#onerrorcaptured) 钩子来捕获 Vue 错误。

此外，Nuxt 提供了一个 [`vue:error`](/docs/4.x/api/advanced/hooks#app-hooks-runtime) 钩子，如果任何错误向上冒泡到顶层，该钩子将被调用。

如果你在使用错误上报框架，可以通过 [`vueApp.config.errorHandler`](https://vue.zhcndoc.com/api/application.html#app-config-errorhandler) 提供一个全局处理器。它会接收所有 Vue 错误，即使这些错误已被处理。

```ts twoslash [plugins/error-handler.ts]
export default defineNuxtPlugin((nuxtApp) => {
  nuxtApp.vueApp.config.errorHandler = (error, instance, info) => {
    // 处理错误，例如上报到服务
  }

  // 也可以这样使用
  nuxtApp.hook('vue:error', (error, instance, info) => {
    // 处理错误，例如上报到服务
  })
})
```

::note
请注意，`vue:error` 钩子是基于 [`onErrorCaptured`](https://vue.zhcndoc.com/api/composition-api-lifecycle.html#onerrorcaptured) 生命周期钩子。
::

## 启动错误

如果在启动 Nuxt 应用时发生任何错误，Nuxt 会调用 `app:error` 钩子。

这包括：
- 运行 [Nuxt 插件](/docs/4.x/guide/directory-structure/plugins)
- 处理 `app:created` 和 `app:beforeMount` 钩子
- 将你的 Vue 应用渲染为 HTML（在 SSR 期间）
- 在客户端挂载应用（尽管你应当使用 `onErrorCaptured` 或 `vue:error` 来处理这种情况）
- 处理 `app:mounted` 钩子

## Nitro 服务器错误

目前你无法为这些错误定义服务器端处理器，但可以渲染错误页面，参见 [渲染错误页面](/docs/4.x/getting-started/error-handling#error-page) 部分。

## JS 分块错误

你可能会遇到 chunk 加载错误，原因是网络连接失败或新的部署（使旧的带哈希的 JS chunk URL 失效）。Nuxt 内置了处理 chunk 加载错误的支持：在路由导航期间如果某个 chunk 加载失败，会执行硬刷新。

你可以通过将 `experimental.emitRouteChunkError` 设置为 `false`（完全禁用对这些错误的钩取）或设置为 `manual`（如果你想自行处理它们）来更改此行为。如果你想手动处理 chunk 加载错误，可以查看 [自动实现](https://github.com/nuxt/nuxt/blob/main/packages/nuxt/src/app/plugins/chunk-reload.client.ts) 以获取灵感。

## 错误页面

::note
当 Nuxt 遇到严重错误（服务器上任何未处理的错误，或客户端使用 `fatal: true` 创建的错误）时，它将根据请求头决定要么渲染 JSON 响应（如果请求带有 `Accept: application/json`），要么触发一个全屏错误页面。
::

在服务器生命周期中可能发生错误的情况包括：
- 处理你的 Nuxt 插件
- 将你的 Vue 应用渲染为 HTML
- 服务器 API 路由抛出错误

在客户端也可能发生错误的情况包括：
- 处理你的 Nuxt 插件
- 在挂载应用之前（`app:beforeMount` 钩子）
- 如果未使用 `onErrorCaptured` 或 `vue:error` 钩子处理，在挂载应用时发生错误
- Vue 应用在浏览器中初始化并挂载（`app:mounted`）

::read-more{to="/docs/4.x/api/advanced/hooks"}
了解所有 Nuxt 生命周期钩子。
::

通过在应用源目录中（与 `app.vue` 并列）添加 `~/error.vue` 来自定义默认错误页面。

<!-- TODO:twoslash: Twoslash does not support tsconfig paths yet -->

```vue [error.vue]
<script setup lang="ts">
import type { NuxtError } from '#app'

const props = defineProps({
  error: Object as () => NuxtError,
})

const handleError = () => clearError({ redirect: '/' })
</script>

<template>
  <div>
    <h2>{{ error?.statusCode }}</h2>
    <button @click="handleError">
      清除错误
    </button>
  </div>
</template>
```

::read-more{to="/docs/4.x/guide/directory-structure/error"}
阅读关于 `error.vue` 及其用途的更多内容。
::

对于自定义错误，我们强烈建议使用 `onErrorCaptured` 可组合函数（可在页面/组件的 setup 函数中调用）或在 Nuxt 插件中配置的运行时 `vue:error` 钩子。

```ts twoslash [plugins/error-handler.ts]
export default defineNuxtPlugin((nuxtApp) => {
  nuxtApp.hook('vue:error', (err) => {
    //
  })
})
```

当你准备移除错误页面时，可以调用 [`clearError`](/docs/4.x/api/utils/clear-error) 帮助函数，它接受一个可选的重定向路径（例如，如果你想导航到一个“安全”页面）。

::important
在使用依赖于 Nuxt 插件的任何内容（例如 `$route` 或 `useRouter`）之前，请务必先检查，因为如果某个插件抛出了错误，该插件在清除错误之前不会重新运行。
::

::note
渲染错误页面是一次完全独立的页面加载，这意味着任何已注册的中间件将会再次运行。你可以在中间件中使用 [`useError`](/docs/4.x/getting-started/error-handling#useerror) 来检查是否正在处理错误。
::

::note
如果你在 Node 16 上运行，并且在渲染错误页面时设置了任何 cookie，它们将会[覆盖先前设置的 cookie](https://github.com/nuxt/nuxt/pull/20585)。我们建议使用更新版本的 Node，因为 Node 16 已于 2023 年 9 月到达生命周期结束。
::

## 错误工具

### `useError`

```ts [TS Signature]
function useError (): Ref<Error | { url, statusCode, statusMessage, message, description, data }>
```

此函数将返回当前正在处理的全局 Nuxt 错误。

::read-more{to="/docs/4.x/api/composables/use-error"}
阅读关于 `useError` 可组合函数的更多内容。
::

### `createError`

```ts [TS Signature]
function createError (err: string | { cause, data, message, name, stack, statusCode, statusMessage, fatal }): Error
```

创建一个带有附加元数据的错误对象。你可以传入字符串作为错误的 `message`，也可以传入包含错误属性的对象。该函数可在应用的 Vue 和服务器部分使用，并且用于抛出错误。

如果你抛出由 `createError` 创建的错误：
- 在服务器端，它会触发一个全屏错误页面，你可以使用 [`clearError`](/docs/4.x/getting-started/error-handling#clearerror) 来清除。
- 在客户端，它会抛出一个非致命错误，供你处理。如果你需要触发全屏错误页面，可以通过设置 `fatal: true` 来实现。

```vue twoslash [pages/movies/[slug\\].vue]
<script setup lang="ts">
const route = useRoute()
const { data } = await useFetch(`/api/movies/${route.params.slug}`)

if (!data.value) {
  throw createError({
    statusCode: 404,
    statusMessage: '未找到页面',
  })
}
</script>
```

::read-more{to="/docs/4.x/api/utils/create-error"}
阅读关于 `createError` 工具的更多内容。
::

### `showError`

```ts [TS Signature]
function showError (err: string | Error | { statusCode, statusMessage }): Error
```

你可以在客户端的任意时刻调用此函数，或者在服务器端直接在中间件、插件或 `setup()` 函数内调用。它会触发一个全屏错误页面，你可以使用 [`clearError`](/docs/4.x/getting-started/error-handling#clearerror) 来清除。

建议改为使用 `throw createError()`。

::read-more{to="/docs/4.x/api/utils/show-error"}
阅读关于 `showError` 工具的更多内容。
::

### `clearError`

```ts [TS Signature]
function clearError (options?: { redirect?: string }): Promise<void>
```

此函数将清除当前正在处理的 Nuxt 错误。它还接受一个可选的重定向路径（例如，如果你想导航到一个“安全”页面）。

::read-more{to="/docs/4.x/api/utils/clear-error"}
阅读关于 `clearError` 工具的更多内容。
::

## 在组件中渲染错误

Nuxt 还提供了一个 [`<NuxtErrorBoundary>`](/docs/4.x/api/components/nuxt-error-boundary) 组件，允许你在应用内处理客户端错误，而无需将整个站点替换为错误页面。

该组件负责处理发生在其默认插槽中的错误。在客户端，它会阻止错误向顶层冒泡，并渲染 `#error` 插槽作为替代。

`#error` 插槽将接收 `error` 作为 prop。（如果你将 `error = null`，它会触发默认插槽的重新渲染；你需要确保错误已被完全解决，否则错误插槽将再次被渲染。）

::tip
如果你导航到其它路由，错误将会自动清除。
::

```vue [app/pages/index.vue]
<template>
  <!-- 一些内容 -->
  <NuxtErrorBoundary @error="someErrorLogger">
    <!-- 使用默认插槽渲染内容 -->
    <template #error="{ error, clearError }">
      你可以在这里本地显示错误: {{ error }}
      <button @click="clearError">
        清除错误
      </button>
    </template>
  </NuxtErrorBoundary>
</template>
```

:link-example{to="/docs/4.x/examples/advanced/error-handling"}
